![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-
blog.csdnimg.cn/f10e586ae9624fb6979ff44f2a87716c.png#pic_center)

>
>
è¿™æ˜¯æˆ‘åœ¨çœ‹è¯¾ç¨‹ã€Š[é»‘é©¬ç¨‹åºå‘˜JVMå®Œæ•´æ•™ç¨‹](https://www.bilibili.com/video/BV1yE411Z7AP/?vd_source=3eaa9d17f2454e1ae80abc50d16e66b5)
ã€‹è¿‡ç¨‹ä¸­è®°çš„ç¬”è®°ã€‚æˆ‘è§‰å¾—è¯¥è¯¾ç¨‹æ€»æ—¶ä¸é•¿ï¼Œå¹¶ä¸”ç†è®º+å®æˆ˜æ˜¯ä¸€ä¸ªå…¥é—¨JVMçš„å¥½è¯¾ç¨‹ã€‚  
> è‹¥ä½ çœ‹å®Œè¯¥è¯¾ç¨‹å¯ä»¥çœ‹ä¸‹é¢å‡ ä¸ªå‚çœ‹ä¹¦è¿›ä¸€æ­¥æ·±å…¥äº†è§£JVM
>
>   * æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰
>   * å®æˆ˜Javaè™šæ‹Ÿæœº
>   * æ·±å…¥JAVAè™šæ‹Ÿæœºç¬¬äºŒç‰ˆ
>

>
> è¿™ä¸‰æœ¬å‚è€ƒä¹¦çš„pdfç‰ˆæœ¬å·²ç»æ”¾åœ¨ä¸‹é¢çš„ç½‘ç›˜ä¸­(åªé™ä¸ªäººçœ‹)  
> é“¾æ¥ï¼šhttps://pan.baidu.com/s/1iNJcbSecMwnOQuaJNxzrRQ  
> æå–ç ï¼šwcar

## 1.å†…å­˜ç»“æ„

### 1.1 ç¨‹åºè®¡æ•°å™¨

![image-20220720222405638](https://img-
blog.csdnimg.cn/img_convert/025701ff1110cb1ca3801ae56f125e67.png)

Program Counter Register ç¨‹åºè®¡æ•°å™¨ï¼ˆå¯„å­˜å™¨ï¼‰

* ä½œç”¨ï¼Œæ˜¯è®°ä½ä¸‹ä¸€æ¡jvmæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€
* ç‰¹ç‚¹
    * æ˜¯çº¿ç¨‹ç§æœ‰çš„
    * ä¸ä¼šå­˜åœ¨å†…å­˜æº¢å‡º

ä¸‹é¢æ˜¯ä¸€æ¡Javaç¨‹åºçš„æŒ‡ä»¤ï¼š  
![image-20220720221813565](https://img-
blog.csdnimg.cn/img_convert/a0d504b441fe13598aca723af9dd8f21.png)

### 1.2 è™šæ‹Ÿæœºæ ˆ

![image-20220720230437288](https://img-
blog.csdnimg.cn/img_convert/bffcfbfca00b55471ab06fbec7bcdc3c.png)

**å®šä¹‰ï¼š**Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰

* æ ˆ-æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶éœ€è¦çš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥è·Ÿç¨‹åºè®¡æ•°å™¨ä¸€æ ·çº¿ç¨‹ç§æœ‰çš„ç»“æ„ã€‚
* æ ˆç”±å¤šä¸ªæ ˆå¸§ç»„æˆï¼Œæ¯ä¸ªæ ˆå¸§å¯¹åº”æ¯ä¸ªæ–¹æ³•è¿è¡Œæ—¶éœ€è¦çš„å†…å­˜ï¼ŒåŒ…å«æ–¹æ³•å‚æ•°ï¼Œå±€éƒ¨å˜é‡ï¼Œè¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚
* æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•

![image-20220720223105927](https://img-
blog.csdnimg.cn/img_convert/e1e2ea31ac529938fc638988b41375b1.png)

**é—®é¢˜è¾¨æï¼š**

1.åƒåœ¾å›æ”¶æ˜¯å¦æ¶‰åŠæ ˆå†…å­˜ï¼Ÿ

ç­”æ¡ˆï¼šä¸ä¼š

2.å†…å­˜åˆ†é…è¶Šå¤§è¶Šå¥½å—ï¼Ÿ

ç­”æ¡ˆï¼šä¸æ˜¯ï¼Œ-Xss å‚æ•°æ¥è®¾ç½®æ ˆç©ºé—´ï¼Œå¦‚æœæ ˆç©ºé—´è®¾ç½®è¿‡å¤§ï¼Œä¼šé™ä½çº¿ç¨‹æ•°ï¼Œå› ä¸ºæœºå­çš„ç‰©ç†å†…å­˜ç©ºé—´å¤§å°å›ºå®šçš„ã€‚

3.æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

* å¦‚æœæ–¹æ³•å†…å±€éƒ¨å˜é‡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
* å¦‚æœæ˜¯å±€éƒ¨å˜é‡å¼•ç”¨äº†å¯¹è±¡ï¼Œå¹¶é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

**æ ˆå†…å­˜æº¢å‡º**

> java.lang.StackOverflowError

* æ ˆå¸§è¿‡å¤šå¯¼è‡´æ ˆå†…å­˜æº¢å‡º
* æ ˆå¸§è¿‡å¤§å¯¼è‡´æ ˆå†…å­˜æº¢å‡º

**çº¿ç¨‹è¿è¡Œè¯Šæ–­**

* cpuå ç”¨è¿‡å¤šæ¡ˆä¾‹
    * ç”¨topå®šä½å“ªä¸ªè¿›ç¨‹å¯¹cpuçš„å ç”¨è¿‡é«˜
    * ps H -eo pid,tid,%cpu | grep è¿›ç¨‹id ï¼ˆç”¨pså‘½ä»¤è¿›ä¸€æ­¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹å¼•èµ·çš„cpuå ç”¨è¿‡é«˜ï¼‰
    * jstack è¿›ç¨‹id
        * å¯ä»¥æ ¹æ®çº¿ç¨‹id æ‰¾åˆ°æœ‰é—®é¢˜çš„çº¿ç¨‹ï¼Œè¿›ä¸€æ­¥å®šä½åˆ°é—®é¢˜ä»£ç çš„æºç è¡Œå·
* ç¨‹åºè¿è¡Œå¾ˆé•¿æ—¶é—´æ²¡æœ‰ç»“æœæ¡ˆä¾‹
    * jstack è¿›ç¨‹id æ¥æŸ¥çœ‹æ˜¯å¦å‡ºç°æ­»é”é—®é¢˜

### 1.3 æœ¬åœ°æ–¹æ³•æ ˆ

![image-20220720230522325](https://img-
blog.csdnimg.cn/img_convert/64b5cd4608c3af65b06fe5c690a0e589.png)

* ä½œç”¨ï¼šç»™æœ¬åœ°æ–¹æ³•æä¾›è¿è¡Œç©ºé—´

### 1.4 å †

![image-20220720230902088](https://img-
blog.csdnimg.cn/img_convert/dbdd8c22d46bae24d21523028b9b0109.png)

**Heap å †**

* é€šè¿‡ new å…³é”®å­—ï¼Œåˆ›å»ºå¯¹è±¡éƒ½ä¼šä½¿ç”¨å †å†…å­˜

**ç‰¹ç‚¹**

* å®ƒæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œå †ä¸­å¯¹è±¡éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜
* æœ‰åƒåœ¾å›æ”¶æœºåˆ¶

**å †å†…å­˜æº¢å‡º**

> java.lang.OutOfMemoryError:Java head space

![image-20220720231131516](https://img-
blog.csdnimg.cn/img_convert/ba2c150d41d970eb6015723026f7815e.png)

* -Xmm è®¾ç½®å †ç©ºé—´

**å †å†…å­˜è¯Šæ–­**

* jps å·¥å…·

æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº› java è¿›ç¨‹

* jmap å·¥å…·

æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µ jmap - heap è¿›ç¨‹id

* jconsole å·¥å…·

å›¾å½¢ç•Œé¢çš„ï¼Œå¤šåŠŸèƒ½çš„ç›‘æµ‹å·¥å…·ï¼Œå¯ä»¥è¿ç»­ç›‘æµ‹

**æ¡ˆä¾‹**

* åƒåœ¾å›æ”¶åï¼Œå†…å­˜å ç”¨ä¾ç„¶å¾ˆé«˜
    * jps:æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº› java è¿›ç¨‹
    * jmap:æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µ jmap - heap è¿›ç¨‹id
    * jconsole :æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œå¹¶å®æ—¶æŸ¥çœ‹
    * jvisualvm:å¯è§†åŒ–çš„æ–¹å¼æ˜¾ç°ï¼Œjvmå†…å­˜ç»“æ„

### 1.5 æ–¹æ³•åŒº

![image-20220720232505950](https://img-
blog.csdnimg.cn/img_convert/fc747b554896d8993b47dc41d1deab6c.png)

**å®šä¹‰**

* Java è™šæ‹Ÿæœºæœ‰ä¸€ä¸ªåœ¨æ‰€æœ‰ Java
  è™šæ‹Ÿæœºçº¿ç¨‹ä¹‹é—´å…±äº«çš„æ–¹æ³•åŒºã€‚æ–¹æ³•åŒºç±»ä¼¼äºä¼ ç»Ÿè¯­è¨€çš„ç¼–è¯‘ä»£ç çš„å­˜å‚¨åŒºï¼Œæˆ–è€…ç±»ä¼¼äºæ“ä½œç³»ç»Ÿè¿›ç¨‹ä¸­çš„â€œæ–‡æœ¬â€æ®µã€‚å®ƒå­˜å‚¨æ¯ä¸ªç±»çš„ç»“æ„ï¼Œä¾‹å¦‚è¿è¡Œæ—¶å¸¸é‡æ± ã€å­—æ®µå’Œæ–¹æ³•æ•°æ®ï¼Œä»¥åŠæ–¹æ³•å’Œæ„é€ å‡½æ•°çš„ä»£ç ï¼ŒåŒ…æ‹¬ç±»å’Œå®ä¾‹åˆå§‹åŒ–å’Œæ¥å£åˆå§‹åŒ–ä¸­ä½¿ç”¨çš„ç‰¹æ®Šæ–¹æ³•ã€‚
*
æ–¹æ³•åŒºæ˜¯åœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºçš„ã€‚å°½ç®¡æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ç®€å•çš„å®ç°å¯èƒ½ä¼šé€‰æ‹©ä¸è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–å‹ç¼©å®ƒã€‚æœ¬è§„èŒƒä¸è¦æ±‚æ–¹æ³•åŒºåŸŸçš„ä½ç½®æˆ–ç”¨äºç®¡ç†å·²ç¼–è¯‘ä»£ç çš„ç­–ç•¥ã€‚æ–¹æ³•åŒºåŸŸå¯ä»¥æ˜¯å›ºå®šå¤§å°ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è®¡ç®—éœ€è¦æ‰©å¤§ï¼Œå¦‚æœä¸éœ€è¦æ›´å¤§çš„æ–¹æ³•åŒºåŸŸï¼Œå¯ä»¥ç¼©å°ã€‚æ–¹æ³•åŒºçš„å†…å­˜ä¸éœ€è¦æ˜¯è¿ç»­çš„ã€‚
* Java è™šæ‹Ÿæœºå®ç°å¯ä»¥ä¸ºç¨‹åºå‘˜æˆ–ç”¨æˆ·æä¾›å¯¹æ–¹æ³•åŒºåŸŸåˆå§‹å¤§å°çš„æ§åˆ¶ï¼Œä»¥åŠåœ¨æ–¹æ³•åŒºåŸŸå¤§å°å¯å˜çš„æƒ…å†µä¸‹ï¼Œå¯¹æœ€å¤§å’Œæœ€å°æ–¹æ³•åŒºåŸŸå¤§å°çš„æ§åˆ¶ã€‚

**ç»„æˆï¼š**

![image-20220720233029357](https://img-
blog.csdnimg.cn/img_convert/f6d1430b4d9631bc9c94cb5eabfc91d6.png)

**æ–¹æ³•åŒºå†…å­˜æº¢å‡º**

* 1.8 ä»¥å‰ä¼šå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜æº¢å‡º

![image-20220720233539735](https://img-
blog.csdnimg.cn/img_convert/47a4b2a8f4946120aa752cf094d8e239.png)

* 1.8 ä¹‹åä¼šå¯¼è‡´å…ƒç©ºé—´å†…å­˜æº¢å‡º

![image-20220720233618338](https://img-
blog.csdnimg.cn/img_convert/62f4b56409809783757d95170efa88fc.png)

**è¿è¡Œæ—¶å¸¸é‡æ± **

* å¸¸é‡æ± ï¼Œå°±æ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ä¿¡æ¯
* è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¸¸é‡æ± æ˜¯ *.class æ–‡ä»¶ä¸­çš„ï¼Œå½“è¯¥ç±»è¢«åŠ è½½ï¼Œå®ƒçš„å¸¸é‡æ± ä¿¡æ¯å°±ä¼šæ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶æŠŠé‡Œé¢çš„ç¬¦å·åœ°å€å˜ä¸ºçœŸå®åœ°å€

**StringTable**

å…ˆçœ‹å‡ é“é¢è¯•é¢˜ï¼š

![image-20220720235226829](https://img-
blog.csdnimg.cn/img_convert/2e1355d54dcc435706c4e1f29f3c9922.png)

* å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä»…æ˜¯ç¬¦å·ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°æ—¶æ‰å˜ä¸ºå¯¹è±¡
* åˆ©ç”¨ä¸²æ± çš„æœºåˆ¶ï¼Œæ¥é¿å…é‡å¤åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
* å­—ç¬¦ä¸²å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯ StringBuilder ï¼ˆ1.8ï¼‰
* å­—ç¬¦ä¸²å¸¸é‡æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–
* å¯ä»¥ä½¿ç”¨ intern æ–¹æ³•ï¼Œä¸»åŠ¨å°†ä¸²æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥ä¸²æ± 
    * 1.8 å°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ï¼Œå¦‚æœæœ‰åˆ™å¹¶ä¸ä¼šæ”¾å…¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ”¾å…¥ä¸²æ± ï¼Œ ä¼šæŠŠä¸²æ± ä¸­çš„å¯¹è±¡è¿”å›
    * 1.6 å°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ï¼Œå¦‚æœæœ‰åˆ™å¹¶ä¸ä¼šæ”¾å…¥ï¼Œå¦‚æœæ²¡æœ‰ä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼Œ ä¼šæŠŠä¸²æ± ä¸­çš„å¯¹è±¡è¿”å›
* è°ƒæ•´ -XX:StringTableSize=æ¡¶ä¸ªæ•°

### 1.6 ç›´æ¥å†…å­˜

**å®šä¹‰** ï¼šDirect Memory

* å¸¸è§äº NIO æ“ä½œæ—¶ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº
* åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä½†è¯»å†™æ€§èƒ½é«˜
* ä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†

**åŸºæœ¬åŸç†**

* ä¸ä½¿ç”¨ç›´æ¥å†…å­˜çš„æ—¶å€™I/Oæ“ä½œè¿‡ç¨‹

![image-20230322131846007](https://img-
blog.csdnimg.cn/img_convert/51ec00d01dc513292cc5c22b5c0536e6.png)

* ä½¿ç”¨ç›´æ¥å†…å­˜

![image-20230322132043963](https://img-
blog.csdnimg.cn/img_convert/6862b95a3333b7077245af1d3372b0bb.png)

**åˆ†é…å’Œå›æ”¶åŸç†**

* ä½¿ç”¨äº† Unsafe å¯¹è±¡å®Œæˆç›´æ¥å†…å­˜çš„åˆ†é…å›æ”¶ï¼Œå¹¶ä¸”å›æ”¶éœ€è¦ä¸»åŠ¨è°ƒç”¨ freeMemory æ–¹æ³•
* ByteBuffffer çš„å®ç°ç±»å†…éƒ¨ï¼Œä½¿ç”¨äº† Cleaner ï¼ˆè™šå¼•ç”¨ï¼‰æ¥ç›‘æµ‹ ByteBuffffer å¯¹è±¡ï¼Œä¸€æ—¦ByteBuffffer å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šç”±
  ReferenceHandler çº¿ç¨‹é€šè¿‡ Cleaner çš„ clean æ–¹æ³•è°ƒç”¨ freeMemory æ¥é‡Šæ”¾ç›´æ¥å†…å­˜

## 2.åƒåœ¾å›æ”¶å™¨

![](https://img-
blog.csdnimg.cn/img_convert/818ab96e8f5115c6abd58148637abed3.png)

### 2.1 å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶

**æ–¹æ³•ä¸€ï¼šå¼•ç”¨è®¡æ•°æ³• ï¼ˆæ—©æœŸçš„Pythonè™šæ‹Ÿæœºç”¨è¿‡ï¼‰**

**æ¦‚å¿µï¼š**

* å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å¼•ç”¨äº†é‚£ä¹ˆå¯¹åº”çš„å¼•ç”¨è®¡æ•°å™¨åŠ ä¸€ï¼Œåæ­£å‡ä¸€ï¼Œå½“ç­‰äºé›¶æ—¶è¯´æ˜è¯¥å¯¹è±¡å¯ä»¥å›æ”¶ã€‚

**å¥½å¤„ï¼š**

* ç®€å•æ˜“è§£

**åå¤„ï¼š**

* å¦‚æœå­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å¤±æ•ˆäº†

![image-20230322134208697](https://img-
blog.csdnimg.cn/img_convert/3e1ccbd7c1ec37248bdae4b0119c686a.png)

**æ–¹æ³•äºŒï¼šå¯è¾¾æ€§åˆ†æç®—æ³• **

* Java è™šæ‹Ÿæœºä¸­çš„åƒåœ¾å›æ”¶å™¨é‡‡ç”¨å¯è¾¾æ€§åˆ†ææ¥æ¢ç´¢æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡
* æ‰«æå †ä¸­çš„å¯¹è±¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿæ²¿ç€ GC Rootå¯¹è±¡ ä¸ºèµ·ç‚¹çš„å¼•ç”¨é“¾æ‰¾åˆ°è¯¥å¯¹è±¡ï¼Œæ‰¾ä¸åˆ°ï¼Œè¡¨ç¤ºå¯ä»¥å›æ”¶
* å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Root ?
    * é‚£äº›è‚¯å®šä¸èƒ½å½“ä½œåƒåœ¾æ¥å›æ”¶çš„å¯¹è±¡

**å››ç§å¼•ç”¨**

![image-20230322140044715](https://img-
blog.csdnimg.cn/img_convert/5e167035dc054edfb34e2cfb3837b9df.png)

1. **å¼ºå¼•ç”¨**

åªæœ‰æ‰€æœ‰ GC Roots å¯¹è±¡éƒ½ä¸é€šè¿‡ã€å¼ºå¼•ç”¨ã€‘å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‰èƒ½è¢«åƒåœ¾å›æ”¶

2. **è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰**

ä»…æœ‰è½¯å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶åï¼Œ **å†…å­˜ä»ä¸è¶³** æ—¶ä¼šå†æ¬¡å‡ºå‘åƒåœ¾å›æ”¶ï¼Œå›æ”¶è½¯å¼•ç”¨å¯¹è±¡å¯ä»¥é…åˆå¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾è½¯å¼•ç”¨è‡ªèº«

3. **å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰**

ä»…æœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶å¼±å¼•ç”¨å¯¹è±¡å¯ä»¥é…åˆå¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾å¼±å¼•ç”¨è‡ªèº«

4. **è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰**

å¿…é¡»é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ï¼Œä¸»è¦é…åˆ ByteBuffffer ä½¿ç”¨ï¼Œè¢«å¼•ç”¨å¯¹è±¡å›æ”¶æ—¶ï¼Œä¼šå°†è™šå¼•ç”¨å…¥é˜Ÿï¼Œç”± Reference Handler
çº¿ç¨‹è°ƒç”¨è™šå¼•ç”¨ç›¸å…³æ–¹æ³•é‡Šæ”¾ç›´æ¥å†…å­˜

5. **ç»ˆç»“å™¨å¼•ç”¨ï¼ˆFinalReferenceï¼‰**

æ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œä½†å…¶å†…éƒ¨é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œç»ˆç»“å™¨å¼•ç”¨å…¥é˜Ÿï¼ˆè¢«å¼•ç”¨å¯¹è±¡æš‚æ—¶æ²¡æœ‰è¢«å›æ”¶ï¼‰ï¼Œå†ç”± Finalizer
çº¿ç¨‹é€šè¿‡ç»ˆç»“å™¨å¼•ç”¨æ‰¾åˆ°è¢«å¼•ç”¨å¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„ finalizeæ–¹æ³•ï¼Œç¬¬äºŒæ¬¡ GC æ—¶æ‰èƒ½å›æ”¶è¢«å¼•ç”¨å¯¹è±¡

### 2.2 åƒåœ¾å›æ”¶ç®—æ³•

**ç®—æ³•ä¸€ï¼šæ ‡è®°æ¸…é™¤ç®—æ³•**

**å®šä¹‰ï¼š**

* Mark Sweepï¼Œç¬¬ä¸€æ­¥ç”¨å¯è¾¾æ€§æ ‡è®°ç®—æ³•æ ‡è®°å¯å›æ”¶å’Œä¸å¯å›æ”¶å¯¹è±¡ã€‚ç¬¬äºŒæ­¥ï¼Œåˆ é™¤é‚£äº›å¯å›æ”¶çš„å¯¹è±¡ã€‚

![image-20230322143909247](https://img-
blog.csdnimg.cn/img_convert/50be1121a65d9daf0600cc5ded6f942e.png)

**ä¼˜ç‚¹ï¼š**

* é€Ÿåº¦è¾ƒå¿«

**ç¼ºç‚¹ï¼š**

* å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡

**ç®—æ³•äºŒï¼šæ ‡è®°æ•´ç†ç®—æ³•**

**åŸç†ï¼š**

* ç¬¬ä¸€æ­¥ç”¨å¯è¾¾æ€§æ ‡è®°ç®—æ³•æ ‡è®°å¯å›æ”¶å’Œä¸å¯å›æ”¶å¯¹è±¡ã€‚ç¬¬äºŒæ­¥ï¼Œå¯ç”¨å¯¹è±¡å‘å‰ç§»åŠ¨ï¼Œä¸å¯ç”¨çš„å¯¹è±¡åˆ é™¤è¾¾åˆ°æ•´ç†æ•ˆæœã€‚

![image-20230322144403896](https://img-
blog.csdnimg.cn/img_convert/f9bf6e8bd3e6dac65d16c95ec0295c45.png)

**å¥½å¤„ï¼š**

* æ²¡æœ‰å†…å­˜ç¢ç‰‡

**åå¤„ï¼š**

* é€Ÿåº¦æ…¢

**ç®—æ³•ä¸‰ï¼šå¤åˆ¶ç®—æ³•**

**åŸç†ï¼š**

* ç¬¬ä¸€æ­¥ç”¨å¯è¾¾æ€§æ ‡è®°ç®—æ³•æ ‡è®°å¯å›æ”¶å’Œä¸å¯å›æ”¶å¯¹è±¡ã€‚Fromä¸­çš„å¯ç”¨å¯¹è±¡å¤åˆ¶åˆ°TOå†…å­˜å—ä¸­ï¼Œæœ€åäº¤æ¢fromå’Œtoçš„ä½ç½®

![image-20230322144856800](https://img-
blog.csdnimg.cn/img_convert/62763aa21cbd285c4c361b814bbfba7b.png)

**å¥½å¤„ï¼š**

* ä¸ä¼šæœ‰å†…å­˜ç¢ç‰‡

**åå¤„ï¼š**

* éœ€è¦å ç”¨åŒå€å†…å­˜ç©ºé—´

### 2.3 åˆ†ä»£åƒåœ¾å›æ”¶

![image-20230322145333822](https://img-
blog.csdnimg.cn/img_convert/7ed761835da4c93315fe71256a7beedc.png)

* å¯¹è±¡é¦–å…ˆåˆ†é…åœ¨ä¼Šç”¸å›­åŒºåŸŸ

* æ–°ç”Ÿä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œè§¦å‘ minor gcï¼Œä¼Šç”¸å›­å’Œ from å­˜æ´»çš„å¯¹è±¡ä½¿ç”¨ copy å¤åˆ¶åˆ° to ä¸­ï¼Œå­˜æ´»çš„å¯¹è±¡å¹´é¾„åŠ  1å¹¶ä¸”äº¤æ¢ from to

* minor gc ä¼šå¼•å‘ stop the worldï¼Œæš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œå½“å¯¹è±¡å¯¿å‘½è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¼šæ™‹å‡è‡³è€å¹´ä»£ï¼Œæœ€å¤§å¯¿å‘½æ˜¯15ï¼ˆ4bitï¼‰

* å½“è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œä¼šå…ˆå°è¯•è§¦å‘ minor gcï¼Œå¦‚æœä¹‹åç©ºé—´ä»ä¸è¶³ï¼Œé‚£ä¹ˆè§¦å‘ full gcï¼ŒSTWçš„æ—¶é—´æ›´é•¿

**ç›¸å…³å‚æ•°**

 å †åˆå§‹å¤§å°            | -Xms                                                        
------------------|-------------------------------------------------------------  
 å †æœ€å¤§å¤§å°            | -Xmx æˆ– -XX:MaxHeapSize=size                                 
 æ–°ç”Ÿä»£å¤§å°            | -Xmn æˆ– (-XX:NewSize=size + -XX:MaxNewSize=size )            
 å¹¸å­˜åŒºæ¯”ä¾‹ï¼ˆåŠ¨æ€ï¼‰        | -XX:InitialSurvivorRatio=ratio å’Œ -XX:+UseAdaptiveSizePolicy 
 å¹¸å­˜åŒºæ¯”ä¾‹            | -XX:SurvivorRatio=ratio                                     
 æ™‹å‡é˜ˆå€¼             | -XX:MaxTenuringThreshold=threshold                          
 æ™‹å‡è¯¦æƒ…             | -XX:+PrintTenuringDistribution                              
 GCè¯¦æƒ…             | -XX:+PrintGCDetails -verbose:gc                             
 FullGC å‰ MinorGC | -XX:+ScavengeBeforeFullGC                                   

### 2.4 åƒåœ¾å›æ”¶å™¨

1. **ä¸²è¡Œ**

> -XX:+UseSerialGC = Serial + SerialOld

![image-20230322152839472](https://img-
blog.csdnimg.cn/img_convert/38fcc3861923ac37186660e2ac689240.png)

    * å•çº¿ç¨‹
    * å †å†…å­˜è¾ƒå°ï¼Œé€‚åˆä¸ªäººç”µè„‘

2. **ååé‡ä¼˜å…ˆ**

> -XX:+UseParallelGC ~ -XX:+UseParallelOldGC
>
> -XX:GCTimeRatio=ratio
>
> -XX:MaxGCPauseMillis=ms
>
> -XX:ParallelGCThreads=n

![image-20230322152942559](https://img-
blog.csdnimg.cn/img_convert/a24f319e99a0f3e9c455ccbe2b6ce32e.png)

    * å¤šçº¿ç¨‹
    * å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸ cpu
    * è®©å•ä½æ—¶é—´å†…ï¼ŒSTW çš„æ—¶é—´æœ€çŸ­ 0.2 0.2 = 0.4ï¼Œåƒåœ¾å›æ”¶æ—¶é—´å æ¯”æœ€ä½ï¼Œè¿™æ ·å°±ç§°ååé‡é«˜

3. **å“åº”æ—¶é—´ä¼˜å…ˆ**

> -XX:+UseConcMarkSweepGC ~ -XX:+UseParNewGC ~ SerialOld
>
> -XX:ParallelGCThreads=n ~ -XX:ConcGCThreads=threads
>
> -XX:CMSInitiatingOccupancyFraction=percent
>
> -XX:+CMSScavengeBeforeRemark

![image-20230322153241451](https://img-
blog.csdnimg.cn/img_convert/2ba15359b4a40c6581d4ec7c4108e911.png)

    * å¤šçº¿ç¨‹

    * å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸ cpu

    * å°½å¯èƒ½è®©å•æ¬¡ STW çš„æ—¶é—´æœ€çŸ­ 0.1 0.1 0.1 0.1 0.1 = 0.5

4. **G1**

**å®šä¹‰ï¼šGarbage First**

    * 2004 è®ºæ–‡å‘å¸ƒ

    * 2009 JDK 6u14 ä½“éªŒ

    * 2012 JDK 7u4 å®˜æ–¹æ”¯æŒ

    * 2017 JDK 9 é»˜è®¤

**é€‚ç”¨åœºæ™¯**

    * åŒæ—¶æ³¨é‡ååé‡ï¼ˆThroughputï¼‰å’Œä½å»¶è¿Ÿï¼ˆLow latencyï¼‰ï¼Œé»˜è®¤çš„æš‚åœç›®æ ‡æ˜¯ 200 ms

    * è¶…å¤§å †å†…å­˜ï¼Œä¼šå°†å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ Region

    * æ•´ä½“ä¸Šæ˜¯ æ ‡è®°+æ•´ç† ç®—æ³•ï¼Œä¸¤ä¸ªåŒºåŸŸä¹‹é—´æ˜¯ å¤åˆ¶ ç®—æ³•

**ç›¸å…³ JVM å‚æ•°**

-XX:+UseG1GC

-XX:G1HeapRegionSize=size

-XX:MaxGCPauseMillis=time

**G1** **åƒåœ¾å›æ”¶é˜¶æ®µ**

![image-20230322155624122](https://img-
blog.csdnimg.cn/img_convert/86f96a1c7478c642dfd66de3c8145d11.png)

    1. **Young Collection**

      * ä¼š STW
      * ![image-20230322155748974](https://img-blog.csdnimg.cn/img_convert/c942dd94dd4197efd9bdb74722e3ef30.png)
      * ![image-20230322155855560](https://img-blog.csdnimg.cn/img_convert/5de594aec34bcb743773842cf0d3924c.png)
      * ![image-20230322155911310](https://img-blog.csdnimg.cn/img_convert/17b8009756f589f90bebb4adf5ef54e7.png)
    2. **Young Collection + CM**

      * åœ¨ Young GC æ—¶ä¼šè¿›è¡Œ GC Root çš„åˆå§‹æ ‡è®°

      * è€å¹´ä»£å ç”¨å †ç©ºé—´æ¯”ä¾‹è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œè¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆä¸ä¼š STWï¼‰ï¼Œç”±ä¸‹é¢çš„ JVM å‚æ•°å†³å®š

![image-20230322160103156](https://img-
blog.csdnimg.cn/img_convert/a4ebf7a0ba99ca370aeafef039c04656.png)

      * ![image-20230322160122063](https://img-blog.csdnimg.cn/img_convert/dd77355fbedae4acd2f839e000fe19bd.png)

    3. **Mixed Collection**

      * ä¼šå¯¹ Eã€Sã€O è¿›è¡Œå…¨é¢åƒåœ¾å›æ”¶

        * æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼‰ä¼š STW
        * æ‹·è´å­˜æ´»ï¼ˆEvacuationï¼‰ä¼š STW
      * -XX:MaxGCPauseMillis=ms

      * ![image-20230322160312398](https://img-blog.csdnimg.cn/img_convert/e2d12cfacf395ceb7ef5ee0d073811d2.png)

**Full GC**

* SerialGC

    * æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc
    * è€å¹´ä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - full gc
* ParallelGC

    * æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc

    * è€å¹´ä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - full gc

* CMS

    * æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc

    * è€å¹´ä»£å†…å­˜ä¸è¶³

* G1

    * æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc

    * è€å¹´ä»£å†…å­˜ä¸è¶³

**Young Collection** **è·¨ä»£å¼•ç”¨**

* æ–°ç”Ÿä»£å›æ”¶çš„è·¨ä»£å¼•ç”¨ï¼ˆè€å¹´ä»£å¼•ç”¨æ–°ç”Ÿä»£ï¼‰é—®é¢˜

![image-20230322161255491](https://img-
blog.csdnimg.cn/img_convert/bfa059eb1393669a25058f80354d566f.png)

* å¡è¡¨ä¸ Remembered Set

* åœ¨å¼•ç”¨å˜æ›´æ—¶é€šè¿‡ post-write barrier + dirty card queue

* concurrent refinement threads æ›´æ–° Remembered Set

![image-20230322161347989](https://img-
blog.csdnimg.cn/img_convert/3f46d124b138b1c65d1c095d87f732e1.png)

**Remark**

* pre-write barrier + satb_mark_queue

![image-20230322161535125](https://img-
blog.csdnimg.cn/img_convert/befa27e99bfcd8a3fa00f673cac9a159.png)

**JDK 8u20** **å­—ç¬¦ä¸²å»é‡**

* ä¼˜ç‚¹ï¼šèŠ‚çœå¤§é‡å†…å­˜

* ç¼ºç‚¹ï¼šç•¥å¾®å¤šå ç”¨äº† cpu æ—¶é—´ï¼Œæ–°ç”Ÿä»£å›æ”¶æ—¶é—´ç•¥å¾®å¢åŠ 

* -XX:+UseStringDeduplication

*     String s1 = new String("hello"); // char[]{'h','e','l','l','o'}
  String s2 = new String("hello"); // char[]{'h','e','l','l','o'}


* å°†æ‰€æœ‰æ–°åˆ†é…çš„å­—ç¬¦ä¸²æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—

* å½“æ–°ç”Ÿä»£å›æ”¶æ—¶ï¼ŒG1å¹¶å‘æ£€æŸ¥æ˜¯å¦æœ‰å­—ç¬¦ä¸²é‡å¤

* å¦‚æœå®ƒä»¬å€¼ä¸€æ ·ï¼Œè®©å®ƒä»¬å¼•ç”¨åŒä¸€ä¸ª char[]

* æ³¨æ„ï¼Œä¸ String.intern() ä¸ä¸€æ ·

    * String.intern() å…³æ³¨çš„æ˜¯å­—ç¬¦ä¸²å¯¹è±¡

    * è€Œå­—ç¬¦ä¸²å»é‡å…³æ³¨çš„æ˜¯ char[]

    * åœ¨ JVM å†…éƒ¨ï¼Œä½¿ç”¨äº†ä¸åŒçš„å­—ç¬¦ä¸²è¡¨

**JDK 8u40** **å¹¶å‘æ ‡è®°ç±»å¸è½½**

æ‰€æœ‰å¯¹è±¡éƒ½ç»è¿‡å¹¶å‘æ ‡è®°åï¼Œå°±èƒ½çŸ¥é“å“ªäº›ç±»ä¸å†è¢«ä½¿ç”¨ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨çš„æ‰€æœ‰ç±»éƒ½ä¸å†ä½¿ç”¨ï¼Œåˆ™å¸è½½å®ƒæ‰€åŠ è½½çš„æ‰€æœ‰ç±»
-XX:+ClassUnloadingWithConcurrentMark é»˜è®¤å¯ç”¨

**JDK 8u60** **å›æ”¶å·¨å‹å¯¹è±¡**

* ä¸€ä¸ªå¯¹è±¡å¤§äº region çš„ä¸€åŠæ—¶ï¼Œç§°ä¹‹ä¸ºå·¨å‹å¯¹è±¡

* G1 ä¸ä¼šå¯¹å·¨å‹å¯¹è±¡è¿›è¡Œæ‹·è´

* å›æ”¶æ—¶è¢«ä¼˜å…ˆè€ƒè™‘

* G1 ä¼šè·Ÿè¸ªè€å¹´ä»£æ‰€æœ‰ incoming å¼•ç”¨ï¼Œè¿™æ ·è€å¹´ä»£ incoming å¼•ç”¨ä¸º0 çš„å·¨å‹å¯¹è±¡å°±å¯ä»¥åœ¨æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ—¶å¤„ç†æ‰

**JDK 9** **å¹¶å‘æ ‡è®°èµ·å§‹æ—¶é—´çš„è°ƒæ•´**

* å¹¶å‘æ ‡è®°å¿…é¡»åœ¨å †ç©ºé—´å æ»¡å‰å®Œæˆï¼Œå¦åˆ™é€€åŒ–ä¸º FullGC

* JDK 9 ä¹‹å‰éœ€è¦ä½¿ç”¨ -XX:InitiatingHeapOccupancyPercent

* JDK 9 å¯ä»¥åŠ¨æ€è°ƒæ•´

    * -XX:InitiatingHeapOccupancyPercent ç”¨æ¥è®¾ç½®åˆå§‹å€¼
    * è¿›è¡Œæ•°æ®é‡‡æ ·å¹¶åŠ¨æ€è°ƒæ•´
    * æ€»ä¼šæ·»åŠ ä¸€ä¸ªå®‰å…¨çš„ç©ºæ¡£ç©ºé—´

**JDK 9** **æ›´é«˜æ•ˆçš„å›æ”¶**

* 250+å¢å¼º
* 180+bugä¿®å¤
* https://docs.oracle.com/en/java/javase/12/gctuning

### 2.5 åƒåœ¾å›æ”¶è°ƒä¼˜

**é¢„å¤‡çŸ¥è¯†**

* æŒæ¡ GC ç›¸å…³çš„ VM å‚æ•°ï¼Œä¼šåŸºæœ¬çš„ç©ºé—´è°ƒæ•´
* æŒæ¡ç›¸å…³å·¥å…·
* æ˜ç™½ä¸€ç‚¹ï¼šè°ƒä¼˜è·Ÿåº”ç”¨ã€ç¯å¢ƒæœ‰å…³ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„æ³•åˆ™

**è°ƒä¼˜é¢†åŸŸ**

* å†…å­˜
* é”ç«äº‰
* cpu å ç”¨
* io

**ç¡®å®šç›®æ ‡**

* ã€ä½å»¶è¿Ÿã€‘è¿˜æ˜¯ã€é«˜ååé‡ã€‘ï¼Œé€‰æ‹©åˆé€‚çš„å›æ”¶å™¨
* CMSï¼ŒG1ï¼ŒZGC
* ParallelGC
* Zing

**æœ€å¿«çš„** **GC æ˜¯ä¸å‘ç”Ÿ GC**

* æŸ¥çœ‹ FullGC å‰åçš„å†…å­˜å ç”¨ï¼Œè€ƒè™‘ä¸‹é¢å‡ ä¸ªé—®é¢˜

    * æ•°æ®æ˜¯ä¸æ˜¯å¤ªå¤šï¼Ÿ

        * resultSet = statement.executeQuery(â€œselect * from å¤§è¡¨ limit nâ€)
    * æ•°æ®è¡¨ç¤ºæ˜¯å¦å¤ªè‡ƒè‚¿ï¼Ÿ

        * å¯¹è±¡å›¾
        * å¯¹è±¡å¤§å° 16 Integer 24 int 4
    * æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼Ÿ

        * static Map map
        * è½¯
        * å¼±
        * ç¬¬ä¸‰æ–¹ç¼“å­˜å®ç°

**æ–°ç”Ÿä»£è°ƒä¼˜**

_æ–°ç”Ÿä»£çš„ç‰¹ç‚¹_

* æ‰€æœ‰çš„ new æ“ä½œçš„å†…å­˜åˆ†é…éå¸¸å»‰ä»·
    * TLAB thread-local allocation buffer
* æ­»äº¡å¯¹è±¡çš„å›æ”¶ä»£ä»·æ˜¯é›¶
* å¤§éƒ¨åˆ†å¯¹è±¡ç”¨è¿‡å³æ­»
* Minor GC çš„æ—¶é—´è¿œè¿œä½äº Full GC

_è¶Šå¤§è¶Šå¥½å—ï¼Ÿ_

    -Xmn 
    Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery).GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete.Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.

* æ–°ç”Ÿä»£èƒ½å®¹çº³æ‰€æœ‰ã€å¹¶å‘é‡ * (è¯·æ±‚-å“åº”)ã€‘çš„æ•°æ®

* å¹¸å­˜åŒºå¤§åˆ°èƒ½ä¿ç•™ã€å½“å‰æ´»è·ƒå¯¹è±¡+éœ€è¦æ™‹å‡å¯¹è±¡ã€‘

* æ™‹å‡é˜ˆå€¼é…ç½®å¾—å½“ï¼Œè®©é•¿æ—¶é—´å­˜æ´»å¯¹è±¡å°½å¿«æ™‹å‡

-XX:MaxTenuringThreshold=threshold

-XX:+PrintTenuringDistribution

    Desired survivor size 48286924 bytes, new threshold 10 (max 10)
    - age 1: 28992024 bytes, 28992024 total
    - age 2: 1366864 bytes, 30358888 total
    - age 3: 1425912 bytes, 31784800 total
    ...

**è€å¹´ä»£è°ƒä¼˜**

ä»¥ CMS ä¸ºä¾‹

* CMS çš„è€å¹´ä»£å†…å­˜è¶Šå¤§è¶Šå¥½

* å…ˆå°è¯•ä¸åšè°ƒä¼˜ï¼Œå¦‚æœæ²¡æœ‰ Full GC é‚£ä¹ˆå·²ç»â€¦ï¼Œå¦åˆ™å…ˆå°è¯•è°ƒä¼˜æ–°ç”Ÿä»£

* è§‚å¯Ÿå‘ç”Ÿ Full GC æ—¶è€å¹´ä»£å†…å­˜å ç”¨ï¼Œå°†è€å¹´ä»£å†…å­˜é¢„è®¾è°ƒå¤§ 1/4 ~ 1/3

-XX:CMSInitiatingOccupancyFraction=percent

**æ¡ˆä¾‹**

* æ¡ˆä¾‹1 Full GC å’Œ Minor GCé¢‘ç¹

* æ¡ˆä¾‹2 è¯·æ±‚é«˜å³°æœŸå‘ç”Ÿ Full GCï¼Œå•æ¬¡æš‚åœæ—¶é—´ç‰¹åˆ«é•¿ ï¼ˆCMSï¼‰

* æ¡ˆä¾‹3 è€å¹´ä»£å……è£•æƒ…å†µä¸‹ï¼Œå‘ç”Ÿ Full GC ï¼ˆCMS jdk1.7ï¼‰

## 3.ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯

![image-20230322174528353](https://img-
blog.csdnimg.cn/img_convert/3204b65a29e06f467600f7f5c5bca64c.png)

### 3.1 ç±»æ–‡ä»¶ç»“æ„

**ä¸€ä¸ªç®€å•çš„ HelloWorld.java**

    package org.example;
    
    /**
     * HelloWorld ç¤ºä¾‹
     */
    public class HelloWorld {
        public static void main(String[] args) {
            System.out.println("hello world");
        }
    }

**ç¼–è¯‘ä¸º HelloWorld.class åœ¨Ideaä¸­æ‰“å¼€åæ˜¯è¿™ä¸ªæ ·å­çš„ï¼š**

![image-20230322221345650](https://img-
blog.csdnimg.cn/img_convert/970493ceb5319f904f32b34e76accd27.png)

**HelloWorld.class æ–‡ä»¶è½¬äºŒè¿›åˆ¶æ–‡ä»¶ï¼š**

![image-20230322182734241](https://img-
blog.csdnimg.cn/img_convert/57856278e6a62ad23324636c9790cd8e.png)

**æ ¹æ® JVM è§„èŒƒï¼Œç±»æ–‡ä»¶ç»“æ„å¦‚ä¸‹**

    ClassFile {
    	u4			magic; 									//é­”æ•°
    	u2			minor_version; 			 				 //jdkçš„å‰¯ç‰ˆæœ¬å·
    	u2 			major_versionï¼š		    				//jdkçš„ä¸»ç‰ˆæœ¬å·
    	u2 			constant_pool_countï¼š					//å¸¸é‡æ± æ•°é‡
    	cp_info 	constant_pool[constant_pool_count-1]ï¼š	  //å¸¸é‡æ± å…·ä½“ä¿¡æ¯
    	u2   		access_flagsï¼š						    //è®¿é—®æƒé™æ ‡è¯†
    	u2      	this_classï¼š								//ç±»å
    	u2 			super_classï¼š                              //çˆ¶ç±»å
    	u2       	interfaces_countï¼š                         //æ¥å£æ•°é‡
    	u2       	interfaces[interfaces_count]ï¼š			  //æ¥å£ç±»ä¿¡æ¯
    	u2 			fields_countï¼š      						//å­—æ®µæ•°é‡
    	field_info 	fields[fields_count]ï¼š				     //å­—æ®µä¿¡æ¯
    	u2 			methods_countï¼š							//æ–¹æ³•æ•°é‡
    	method_info  methods[methods_count]ï¼š				  //æ–¹æ³•å…·ä½“ä¿¡æ¯
    	u2 			attributes_countï¼š						//å±æ€§æ•°é‡
    	attribute_info attributes[attributes_count]ï¼š           //å±æ€§å…·ä½“ä¿¡æ¯
    }

1. **é­”æ•°**

    * 0~3 å­—èŠ‚ï¼Œè¡¨ç¤ºå®ƒæ˜¯å¦æ˜¯ã€classã€‘ç±»å‹çš„æ–‡ä»¶

![image-20230322182955796](https://img-
blog.csdnimg.cn/img_convert/08e2c11299067425b9f9f69c3d8e046d.png)

2. **ç‰ˆæœ¬**

    * 4~7 å­—èŠ‚ï¼Œè¡¨ç¤ºç±»çš„ç‰ˆæœ¬ 00 34ï¼ˆ52ï¼‰ è¡¨ç¤ºæ˜¯ Java 8

![image-20230322183208061](https://img-
blog.csdnimg.cn/img_convert/48034789e3893996b3f5480cdeb6b972.png)

3. **å¸¸é‡æ± **

 Constant Type               | Value 
-----------------------------|-------  
 CONSTANT_Class              | 7     
 CONSTANT_Fieldref           | 9     
 CONSTANT_Methodref          | 10    
 CONSTANT_InterfaceMethodref | 11    
 CONSTANT_String             | 8     
 CONSTANT_Integer            | 3     
 CONSTANT_Float              | 4     
 CONSTANT_Long               | 5     
 CONSTANT_Double             | 6     
 CONSTANT_NameAndType        | 12    
 CONSTANT_Utf8               | 1     
 CONSTANT_MethodHandle       | 15    
 CONSTANT_MethodType         | 16    
 CONSTANT_InvokeDynamic      | 18    

    * 8~9 å­—èŠ‚ï¼Œè¡¨ç¤ºå¸¸é‡æ± é•¿åº¦ï¼Œ00 22ï¼ˆ34ï¼‰ è¡¨ç¤ºå¸¸é‡æ± æœ‰ #1~#33é¡¹ï¼Œæ³¨æ„ #0 é¡¹ä¸è®¡å…¥ï¼Œä¹Ÿæ²¡æœ‰å€¼

![image-20230322184540536](https://img-
blog.csdnimg.cn/img_convert/8f2d194fe338f9bfc1f8133dccbce57b.png)

    * ç¬¬#1é¡¹ 0a è¡¨ç¤ºå¸¸é‡æ± ä¸­çš„ç±»å‹ï¼Œå› ä¸º0a(10) å¯¹åº”ä¸Šé¢è¡¨æ ¼ä¸­çš„CONSTANT_Methodref ç±»å‹ï¼Œæ‰€ä»¥å®ƒè¡¨ç¤º Method ä¿¡æ¯ï¼Œ00 06 å’Œ 00 14ï¼ˆ20ï¼‰ è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #6 å’Œ #20 é¡¹æ¥è·å¾—è¿™ä¸ªæ–¹æ³•çš„ã€æ‰€å±ç±»ã€‘å’Œã€æ–¹æ³•åã€‘

![image-20230322185150186](https://img-
blog.csdnimg.cn/img_convert/8caecd6461b60f5920b86fab13757a72.png)

    * ç¬¬#2é¡¹ 09 è¡¨ç¤ºä¸€ä¸ª Field ä¿¡æ¯ï¼Œ00 15ï¼ˆ21ï¼‰å’Œ 00 16ï¼ˆ22ï¼‰ è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #21 å’Œ # 22 é¡¹æ¥è·å¾—è¿™ä¸ªæˆå‘˜å˜é‡çš„ã€æ‰€å±ç±»å‹ã€‘å’Œã€æˆå‘˜å˜é‡åã€‘

![image-20230322190403165](https://img-
blog.csdnimg.cn/img_convert/d44c746c2f2cdd278b70994889d8a84b.png)

    * ç¬¬#3é¡¹ 08 è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡åç§°ï¼Œ00 17ï¼ˆ23ï¼‰è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #23 é¡¹

![image-20230322190647360](https://img-
blog.csdnimg.cn/img_convert/3c8c6501275ca1295fb45231effeec0a.png)

    * ç¬¬#4é¡¹ 0a è¡¨ç¤ºä¸€ä¸ª Method ä¿¡æ¯ï¼Œ00 18ï¼ˆ24ï¼‰ å’Œ 00 19ï¼ˆ25ï¼‰è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #24 å’Œ #25é¡¹æ¥è·å¾—è¿™ä¸ªæ–¹æ³•çš„ã€æ‰€å±ç±»ã€‘å’Œã€æ–¹æ³•åã€‘

![image-20230322190807282](https://img-
blog.csdnimg.cn/img_convert/dc3f61673298928d5fff204a47d51930.png)

    * ç¬¬#5é¡¹ 07 è¡¨ç¤ºä¸€ä¸ª Class ä¿¡æ¯ï¼Œ00 1aï¼ˆ26ï¼‰ è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #26 é¡¹

![image-20230322191054297](https://img-
blog.csdnimg.cn/img_convert/9edcc0b98c8275c199de10d8070bad95.png)

    * ç¬¬#6é¡¹ 07 è¡¨ç¤ºä¸€ä¸ª Class ä¿¡æ¯ï¼Œ00 1bï¼ˆ27ï¼‰ è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #27 é¡¹

![image-20230322191226622](https://img-
blog.csdnimg.cn/img_convert/7452e1fe9dc568673439e7d65206f7c4.png)

    * ç¬¬#7é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 06 è¡¨ç¤ºé•¿åº¦ï¼Œ3c 69 6e 69 74 3e æ˜¯ã€ ã€‘

![image-20230322191353244](https://img-
blog.csdnimg.cn/img_convert/439e1953d21c9686ad6804d835d148d0.png)

    * ç¬¬#8é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 03 è¡¨ç¤ºé•¿åº¦ï¼Œ28 29 56 æ˜¯ã€()Vã€‘å…¶å®å°±æ˜¯è¡¨ç¤ºæ— å‚ã€æ— è¿”å›å€¼

![image-20230322191903217](https://img-
blog.csdnimg.cn/img_convert/5080cbaaf19a1b0a23660d5b8b31ef80.png)

    * ç¬¬#9é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 04 è¡¨ç¤ºé•¿åº¦ï¼Œ43 6f 64 65 æ˜¯ã€Codeã€‘

![image-20230322191958863](https://img-
blog.csdnimg.cn/img_convert/ecc137c0370f4371a9c4812c0f0a162d.png)

    * ç¬¬#10é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 0fï¼ˆ15ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œ4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65æ˜¯ã€LineNumberTableã€‘

![image-20230322192123600](https://img-
blog.csdnimg.cn/img_convert/0d3697271a754c4a5531e64cf839d013.png)

    * ç¬¬#11é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 12ï¼ˆ18ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œ4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65æ˜¯ã€LocalVariableTableã€‘

![image-20230322192333501](https://img-
blog.csdnimg.cn/img_convert/be5dd1082ec04ddd6e7f5d6f9eb4c404.png)

    * ç¬¬#12é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 04 è¡¨ç¤ºé•¿åº¦ï¼Œ74 68 69 73 æ˜¯ã€thisã€‘

![image-20230322192553931](https://img-
blog.csdnimg.cn/img_convert/cdbe9eb67dee3f841125ef6e5ac72722.png)

    * ç¬¬#13é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 18ï¼ˆ24ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€Lorg/example/HeloWorld;ã€‘

![image-20230322192722291](https://img-
blog.csdnimg.cn/img_convert/aa234764aab4b97b023ca4cdc2da3898.png)

    * ç¬¬#14é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 04 è¡¨ç¤ºé•¿åº¦ï¼Œ6D 61 69 6Eæ˜¯ã€mainã€‘

![image-20230322193142581](https://img-
blog.csdnimg.cn/img_convert/b0184ed970fc601e2a5b184fb842fa6b.png)

    * ç¬¬#15é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 16ï¼ˆ22ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€([Ljava/lang/String;)Vã€‘å…¶å®å°±æ˜¯å‚æ•°ä¸ºå­—ç¬¦ä¸²æ•°ç»„ï¼Œæ— è¿”å›å€¼

![image-20230322193348562](https://img-
blog.csdnimg.cn/img_convert/1b8672d5820b02732f9344c4003fa45b.png)

    * ç¬¬#16é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 04 è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€argsã€‘

![image-20230322193635966](https://img-
blog.csdnimg.cn/img_convert/3562ee0c958b74bfbbe645dd98a69dd0.png)

    * ç¬¬#17é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 13ï¼ˆ19ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€[Ljava/lang/String;ã€‘

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-
GHE5d5zF-1679980231499)(https://pic-1307534554.cos.ap-
chongqing.myqcloud.com/img/image-20230322193804022.png)]

    * ç¬¬#18é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 0Aï¼ˆ10ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€SourceFileã€‘

![image-20230322194200172](https://img-
blog.csdnimg.cn/img_convert/cc24653306aa17ab1e086750ec1c2120.png)

    * ç¬¬#19é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 0fï¼ˆ15ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€HelloWorld.javaã€‘

![image-20230322194729624](https://img-
blog.csdnimg.cn/img_convert/3b7bcd2ecaa9b3d4f56e11a8f6b63f24.png)

    * ç¬¬#20é¡¹0c è¡¨ç¤ºä¸€ä¸ª ã€å+ç±»å‹ã€‘ï¼Œ00 07 00 08 å¼•ç”¨äº†å¸¸é‡æ± ä¸­ #7 #8 ä¸¤é¡¹

![image-20230322194910846](https://img-
blog.csdnimg.cn/img_convert/d3d00b92c6d7feb225f00acb26f1e8e5.png)

    * ç¬¬#21é¡¹ 07 è¡¨ç¤ºä¸€ä¸ª Class ä¿¡æ¯ï¼Œ00 1cï¼ˆ28ï¼‰ å¼•ç”¨äº†å¸¸é‡æ± ä¸­ #28 é¡¹

![image-20230322195113486](https://img-
blog.csdnimg.cn/img_convert/f0f69d8ce21ceaf58b17d2d19b5e414d.png)

    * ç¬¬#22é¡¹ 0c è¡¨ç¤ºä¸€ä¸ªã€å+ç±»å‹ã€‘00 1dï¼ˆ29ï¼‰ 00 1e ï¼ˆ30ï¼‰å¼•ç”¨äº†å¸¸é‡æ± ä¸­ #29 #30ä¸¤é¡¹

![image-20230322195215374](https://img-
blog.csdnimg.cn/img_convert/4c3b627c6c7f52d4af194a0eacb3479b.png)

    * ç¬¬#23é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 0bï¼ˆ11ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€hello worldã€‘

![image-20230322195444628](https://img-
blog.csdnimg.cn/img_convert/6cefcc7210a7ef6f4673bb060abb5092.png)

    * ç¬¬#24é¡¹ 07 è¡¨ç¤ºä¸€ä¸ª Class ä¿¡æ¯ï¼Œ00 1Fï¼ˆ31ï¼‰ å¼•ç”¨äº†å¸¸é‡æ± ä¸­ #31 é¡¹

![image-20230322195606493](https://img-
blog.csdnimg.cn/img_convert/ad3c457d6ae627a821f3313c97c2d1cb.png)

    * ç¬¬#25é¡¹ 0c è¡¨ç¤ºä¸€ä¸ªã€å+ç±»å‹ã€‘00 20ï¼ˆ32ï¼‰ 00 21ï¼ˆ33ï¼‰å¼•ç”¨äº†å¸¸é‡æ± ä¸­ #32 #33 ä¸¤é¡¹

![image-20230322195830948](https://img-
blog.csdnimg.cn/img_convert/b122494716943385d04b25055f99e14f.png)

    * ç¬¬#26é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 16ï¼ˆ22ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€org/example/HelloWorldã€‘

![image-20230322200020321](https://img-
blog.csdnimg.cn/img_convert/bea8d25a83b099b576ace8d6c9d3cc01.png)

    * ç¬¬#27é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 10ï¼ˆ16ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€java/lang/Objectã€‘

![image-20230322200337409](https://img-
blog.csdnimg.cn/img_convert/6af8326a62bc29a5ef7ff6fba1d5a0ca.png)

    * ç¬¬#28é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 10ï¼ˆ16ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€java/lang/Systemã€‘

![image-20230322200448928](https://img-
blog.csdnimg.cn/img_convert/a1cdd21f00831a0528579ace6b0e9889.png)

    * ç¬¬#29é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 03 è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€outã€‘

![image-20230322200551345](https://img-
blog.csdnimg.cn/img_convert/bf1370c7f46c8bc23e9d2edcf8617034.png)

    * ç¬¬#30é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 15ï¼ˆ21ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€Ljava/io/PrintStream;ã€‘

![image-20230322200648865](https://img-
blog.csdnimg.cn/img_convert/4b698def1a557f5f21e9b3f426ee5395.png)

    * ç¬¬#31é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 13ï¼ˆ19ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€java/io/PrintStreamã€‘

![image-20230322200842783](https://img-
blog.csdnimg.cn/img_convert/9276e420fcc6f41346b070f9ca7a0fd1.png)

    * ç¬¬#32é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 07 è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€printlnã€‘

![image-20230322201004865](https://img-
blog.csdnimg.cn/img_convert/3f48e516cee05a559de6b904e7512ce5.png)

    * ç¬¬#33é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 15ï¼ˆ21ï¼‰ è¡¨ç¤ºé•¿åº¦ï¼Œæ˜¯ã€(Ljava/lang/String;)Vã€‘

![image-20230322201114055](https://img-
blog.csdnimg.cn/img_convert/30bbbfd48dad3132aaa55417bb45c107.png)

4. **è®¿é—®æ ‡è¯†ä¸ç»§æ‰¿ä¿¡æ¯**

**è®¿é—®æ ‡è¯†ç¬¦ï¼š**

00 21 è¡¨ç¤ºç­‰ä»·äºã€0x0001 + 0x0020ã€‘è¡¨ç¤ºè¯¥Classæ˜¯ä¸€ä¸ªå…¬å…±çš„ç±»ã€public classã€‘

![image-20230322210828403](https://img-
blog.csdnimg.cn/img_convert/a99b288132b7c60c5e7f1a0b2a6509d5.png)

 **Flag Name** | **Value** | **Interpretation**                                 
---------------|-----------|----------------------------------------------------  
 ACC_PUBLIC    | 0x0001    | Declared public ; may be accessed from outside its 

package.  
ACC_FINAL| 0x0010| Declared final ; no subclasses allowed.  
ACC_SUPER| 0x0020| Treat superclass methods specially when invoked by the
_invokespecial_ instruction.  
ACC_INTERFACE| 0x0200| Is an interface, not a class.  
ACC_ABSTRACT| 0x0400| Declared abstract ; must not be instantiated.  
ACC_SYNTHETIC| 0x1000| Declared synthetic; not present in the source code.  
ACC_ANNOTATION| 0x2000| Declared as an annotation type.  
ACC_ENUM| 0x4000| Declared as an enum type.

**ç±»åï¼š**

00 05 è¡¨ç¤ºæ ¹æ®å¸¸é‡æ± ä¸­ #5 æ‰¾åˆ°æœ¬ç±»å…¨é™å®šå

![image-20230322211439671](https://img-
blog.csdnimg.cn/img_convert/b83eedc319fe5fbb8d1b5deed8a49888.png)

**çˆ¶ç±»åï¼š**

00 06 è¡¨ç¤ºæ ¹æ®å¸¸é‡æ± ä¸­ #6 æ‰¾åˆ°çˆ¶ç±»å…¨é™å®šå

![image-20230322211531895](https://img-
blog.csdnimg.cn/img_convert/19f53fe55ca0a48f9afc803483dd6bbf.png)

**æ¥å£æ•°é‡ï¼š**

00 00 è¡¨ç¤ºæ¥å£çš„æ•°é‡ï¼Œæœ¬ç±»ä¸º 0

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-
qEDlWg4V-1679980231512)(https://pic-1307534554.cos.ap-
chongqing.myqcloud.com/img/image-20230322211704581.png)]

5. **Field ä¿¡æ¯**

00 00 è¡¨ç¤ºæˆå‘˜å˜é‡æ•°é‡ï¼Œæœ¬ç±»ä¸º 0

![image-20230322212055037](https://img-
blog.csdnimg.cn/img_convert/61ceea6352f4b4d7fc0340c1ef7e6c95.png)

 **FieldType** | **Type** | **Interpretation**                                                   
---------------|----------|----------------------------------------------------------------------  
 B             | byte     | signed byte                                                          
 C             | char     | Unicode character code point in the Basic Multilingual Plane,encoded 

with UTF-16  
D| double| double-precision flfloating-point value  
F| float| single-precision flfloating-point value  
I| int| integer  
J| long| long integer  
L _ClassName_ ;| reference| an instance of class _ClassName_  
S| short| signed short  
Z| boolean| true or false  
[| reference| one array dimension

6. **Method** **ä¿¡æ¯**

**æ–¹æ³•æ•°é‡:**

00 02 è¡¨ç¤ºæ–¹æ³•æ•°é‡ï¼Œæœ¬ç±»ä¸º 2

![image-20230322212741225](https://img-
blog.csdnimg.cn/img_convert/3187e9a62644a47afcde65883c54508d.png)

**æ–¹æ³•ä¿¡æ¯ï¼š**

ä¸€ä¸ªæ–¹æ³•ç”± è®¿é—®ä¿®é¥°ç¬¦ï¼Œåç§°ï¼Œå‚æ•°æè¿°ï¼Œæ–¹æ³•å±æ€§æ•°é‡ï¼Œæ–¹æ³•å±æ€§ç»„æˆï¼š

_**æ–¹æ³•ä¸€ï¼š**_

    * è®¿é—®ä¿®é¥°ç¬¦ï¼š 00 01 ï¼Œæœ¬ç±»ä¸­æ˜¯ ã€ACC_PUBLIC ã€‘public

![image-20230322214356199](https://img-
blog.csdnimg.cn/img_convert/8e57d8a75ac543e1779bf2496d165c51.png)

    * æ–¹æ³•åç§°ï¼š00 07 ã€ã€‘ ä»£è¡¨å¼•ç”¨äº†å¸¸é‡æ±  #07 é¡¹ä½œä¸ºæ–¹æ³•åç§°

![image-20230322214706845](https://img-
blog.csdnimg.cn/img_convert/bb8f6f11a9336fd9df51219625d750e1.png)

    * å‚æ•°æè¿°ï¼š00 08 ã€()Vã€‘ä»£è¡¨å¼•ç”¨äº†å¸¸é‡æ±  #08 é¡¹ä½œä¸ºæ–¹æ³•å‚æ•°æè¿°

![image-20230322214944575](https://img-
blog.csdnimg.cn/img_convert/a9e3213a5adeeaf64bd7d87b0ac6a77b.png)

    * æ–¹æ³•å±æ€§æ•°é‡ï¼š00 01 ä»£è¡¨æ–¹æ³•å±æ€§æ•°é‡ï¼Œæœ¬æ–¹æ³•æ˜¯ 1

![image-20230322215324390](https://img-
blog.csdnimg.cn/img_convert/bdddff603fe83f1f418fd688f8240f1c.png)

    * ä»£è¡¨æ–¹æ³•å±æ€§ï¼š

      * 00 09 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #09 é¡¹ï¼Œå‘ç°æ˜¯ã€Codeã€‘å±æ€§

![image-20230322215439589](https://img-
blog.csdnimg.cn/img_convert/f486416d06dc08a34e73d79e3ec5558b.png)

      * 00 00 00 2f è¡¨ç¤ºæ­¤å±æ€§çš„é•¿åº¦æ˜¯ 47

![image-20230322215556222](https://img-
blog.csdnimg.cn/img_convert/d4d2939062c95949e40709d281f1a208.png)

      * 00 01 è¡¨ç¤ºã€æ“ä½œæ•°æ ˆã€‘æœ€å¤§æ·±åº¦ æœ¬æ–¹æ³•æ˜¯ 1

![image-20230322215732004](https://img-
blog.csdnimg.cn/img_convert/c1282d9f152a715e39ecd3d55f842fba.png)

      * 00 01 è¡¨ç¤ºã€å±€éƒ¨å˜é‡è¡¨ã€‘æœ€å¤§æ§½ï¼ˆslotï¼‰æ•° æœ¬æ–¹æ³•æ˜¯1

![image-20230322220215816](https://img-
blog.csdnimg.cn/img_convert/8fc267e6216d77a499343dbff8ddcaf6.png)

      * 00 00 00 05 è¡¨ç¤ºå­—èŠ‚ç é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 5

![image-20230322220229046](https://img-
blog.csdnimg.cn/img_convert/2e24c73f764a241a255e22cd21dd2776.png)

      * 2A B7 00 01 B1 æ˜¯å­—èŠ‚ç æŒ‡ä»¤

![image-20230322220254073](https://img-
blog.csdnimg.cn/img_convert/ac5fabcccab476727c81ccdb53f1a574.png)

      * 00 00 00 02 è¡¨ç¤ºæ–¹æ³•ç»†èŠ‚å±æ€§æ•°é‡ï¼Œæœ¬ä¾‹æ˜¯ 2

![image-20230322220750842](https://img-
blog.csdnimg.cn/img_convert/00c72946a09a77099d15a705d1a9c998.png)

      * 00 0A è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #10 é¡¹ï¼Œå‘ç°æ˜¯ã€LineNumberTableã€‘å±æ€§

![image-20230322220824191](https://img-
blog.csdnimg.cn/img_convert/9ef2bb4e87afec52583b7dae23061931.png)

        * 00 00 00 06 è¡¨ç¤ºæ­¤å±æ€§çš„æ€»é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 6

![image-20230322220934196](https://img-
blog.csdnimg.cn/img_convert/881a400dad9398350302a0ca8fc35077.png)

        * 00 01 è¡¨ç¤ºã€LineNumberTableã€‘é•¿åº¦

![image-20230322221004311](https://img-
blog.csdnimg.cn/img_convert/d3680cd30a53e13ad5e5a055923ba14b.png)

        * 00 00 è¡¨ç¤ºã€å­—èŠ‚ç ã€‘è¡Œå· 00 09 è¡¨ç¤ºã€java æºç ã€‘è¡Œå·

![image-20230322221029665](https://img-
blog.csdnimg.cn/img_convert/86039265d278109382b3c0d84a21b99b.png)

![image-20230322221038072](https://img-
blog.csdnimg.cn/img_convert/df263f5fecf9318b7c7e36813fb17c80.png)

      * 00 0b è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #11 é¡¹ï¼Œå‘ç°æ˜¯ã€LocalVariableTableã€‘å±æ€§

![image-20230322221438278](https://img-
blog.csdnimg.cn/img_convert/739c90b6c6082989c2b2ea7384774653.png)

        * 00 00 00 0c è¡¨ç¤ºæ­¤å±æ€§çš„æ€»é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 12

![image-20230322222009659](https://img-
blog.csdnimg.cn/img_convert/b463982adc160d126689ed5c137cc6a6.png)

        * 00 01 è¡¨ç¤ºã€LocalVariableTableã€‘é•¿åº¦

![image-20230322222019094](https://img-
blog.csdnimg.cn/img_convert/eac61d8a5c40e27da26e61fae4232a50.png)

        * 00 00 è¡¨ç¤ºå±€éƒ¨å˜é‡ç”Ÿå‘½å‘¨æœŸå¼€å§‹ï¼Œç›¸å¯¹äºå­—èŠ‚ç çš„åç§»é‡

![image-20230322222027355](https://img-
blog.csdnimg.cn/img_convert/8e82e75edb631a1634502cb3fc83da83.png)

        * 00 05 è¡¨ç¤ºå±€éƒ¨å˜é‡è¦†ç›–çš„èŒƒå›´é•¿åº¦

![image-20230322222037416](https://img-
blog.csdnimg.cn/img_convert/7f44a7acae5bc8e4f78ea0743819cf9d.png)

        * 00 0c è¡¨ç¤ºå±€éƒ¨å˜é‡åç§°ï¼Œæœ¬ä¾‹å¼•ç”¨äº†å¸¸é‡æ±  #12 é¡¹ï¼Œæ˜¯ã€thisã€‘

![image-20230322222044734](https://img-
blog.csdnimg.cn/img_convert/d999dc442d8582339fedc77ec8192f6e.png)

        * 00 0d è¡¨ç¤ºå±€éƒ¨å˜é‡çš„ç±»å‹ï¼Œæœ¬ä¾‹å¼•ç”¨äº†å¸¸é‡æ±  #13 é¡¹ï¼Œæ˜¯ã€Lorg/example/HeloWorld;ã€‘

![image-20230322222052895](https://img-
blog.csdnimg.cn/img_convert/270000413d054dfebf30a561eec349b1.png)

        * 00 00 è¡¨ç¤ºå±€éƒ¨å˜é‡å æœ‰çš„æ§½ä½ï¼ˆslotï¼‰ç¼–å·ï¼Œæœ¬ä¾‹æ˜¯ 0

![image-20230322222104380](https://img-
blog.csdnimg.cn/img_convert/a590df5ddde303a94e21177fd53a31f7.png)

_**æ–¹æ³•äºŒï¼š**_

    * è®¿é—®ä¿®é¥°ç¬¦ï¼š00 09 ï¼Œæœ¬ç±»ä¸­æ˜¯ã€00 01 + 00 08ã€‘ public static
    * åç§°ï¼š00 0E ä»£è¡¨å¼•ç”¨äº†å¸¸é‡æ±  #14 é¡¹ä½œä¸ºæ–¹æ³•åç§°ã€mainã€‘
    * å‚æ•°æè¿°ï¼š00 0F ä»£è¡¨å¼•ç”¨äº†å¸¸é‡æ±  #15 é¡¹ä½œä¸ºæ–¹æ³•å‚æ•°æè¿°ã€([Ljava/lang/String;)Vã€‘
    * æ–¹æ³•å±æ€§æ•°é‡: 00 01 ä»£è¡¨æ–¹æ³•å±æ€§æ•°é‡ï¼Œæœ¬æ–¹æ³•æ˜¯ 1
    * æ–¹æ³•å±æ€§ç»„æˆ: 
      * 00 09 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #09 é¡¹ï¼Œå‘ç°æ˜¯ã€Codeã€‘å±æ€§
      * 00 00 00 37 è¡¨ç¤ºæ­¤å±æ€§çš„é•¿åº¦æ˜¯ 55
      * 00 02 è¡¨ç¤ºã€æ“ä½œæ•°æ ˆã€‘æœ€å¤§æ·±åº¦
      * 00 01 è¡¨ç¤ºã€å±€éƒ¨å˜é‡è¡¨ã€‘æœ€å¤§æ§½ï¼ˆslotï¼‰æ•°
      * 00 00 00 09 è¡¨ç¤ºå­—èŠ‚ç é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 9
      * b2 00 02 12 03 b6 00 04 b1 æ˜¯å­—èŠ‚ç æŒ‡ä»¤
      * 00 00 00 02 è¡¨ç¤ºæ–¹æ³•ç»†èŠ‚å±æ€§æ•°é‡ï¼Œæœ¬ä¾‹æ˜¯ 2
      * 00 0a è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #10 é¡¹ï¼Œå‘ç°æ˜¯ã€LineNumberTableã€‘å±æ€§ 
        * 00 00 00 0a è¡¨ç¤ºæ­¤å±æ€§çš„æ€»é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 10
        * 00 02 è¡¨ç¤ºã€LineNumberTableã€‘é•¿åº¦
        * 00 00 è¡¨ç¤ºã€å­—èŠ‚ç ã€‘è¡Œå· 00 0B è¡¨ç¤ºã€java æºç ã€‘è¡Œå·
        * 00 08 è¡¨ç¤ºã€å­—èŠ‚ç ã€‘è¡Œå· 00 0C è¡¨ç¤ºã€java æºç ã€‘è¡Œå·
      * 00 0b è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #11 é¡¹ï¼Œå‘ç°æ˜¯ã€LocalVariableTableã€‘å±æ€§ 
        * 00 00 00 0c è¡¨ç¤ºæ­¤å±æ€§çš„æ€»é•¿åº¦ï¼Œæœ¬ä¾‹æ˜¯ 12
        * 00 01 è¡¨ç¤ºã€LocalVariableTableã€‘é•¿åº¦
        * 00 00 è¡¨ç¤ºå±€éƒ¨å˜é‡ç”Ÿå‘½å‘¨æœŸå¼€å§‹ï¼Œç›¸å¯¹äºå­—èŠ‚ç çš„åç§»é‡
        * 00 09 è¡¨ç¤ºå±€éƒ¨å˜é‡è¦†ç›–çš„èŒƒå›´é•¿åº¦
        * 00 10 è¡¨ç¤ºå±€éƒ¨å˜é‡åç§°ï¼Œæœ¬ä¾‹å¼•ç”¨äº†å¸¸é‡æ±  #16 é¡¹ï¼Œæ˜¯ã€argsã€‘
        * 00 11 è¡¨ç¤ºå±€éƒ¨å˜é‡çš„ç±»å‹ï¼Œæœ¬ä¾‹å¼•ç”¨äº†å¸¸é‡æ±  #17 é¡¹ï¼Œæ˜¯ã€[Ljava/lang/String;ã€‘
        * 00 00 è¡¨ç¤ºå±€éƒ¨å˜é‡å æœ‰çš„æ§½ä½ï¼ˆslotï¼‰ç¼–å·ï¼Œæœ¬ä¾‹æ˜¯ 0

7. **é™„åŠ å±æ€§**

    * 00 01 è¡¨ç¤ºé™„åŠ å±æ€§æ•°é‡

    * 00 12 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #18 é¡¹ï¼Œå³ã€SourceFileã€‘

    * 00 00 00 02 è¡¨ç¤ºæ­¤å±æ€§çš„é•¿åº¦

    * 00 13 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #19 é¡¹ï¼Œå³ã€HelloWorld.javaã€‘

![image-20230322224439774](https://img-
blog.csdnimg.cn/img_convert/42627177d59a6cc04a6e199e8184fe87.png)

### 3.2 å­—èŠ‚ç æŒ‡ä»¤

#### **3.2.1 å…¥é—¨**

æ¥ç€ä¸Šä¸€èŠ‚ï¼Œç ”ç©¶ä¸€ä¸‹ä¸¤ç»„å­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸€ä¸ªæ˜¯

public org.example.HeloWorld();æ„é€ æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤: 2A B7 00 01 B1

1. 2a => _aload_0_ åŠ è½½ slot 0 çš„å±€éƒ¨å˜é‡ï¼Œå³ thisï¼Œåšä¸ºä¸‹é¢çš„ _invokespecial_ æ„é€ æ–¹æ³•è°ƒç”¨çš„å‚æ•°
2. b7 => _invokespecial_ é¢„å¤‡è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œå“ªä¸ªæ–¹æ³•å‘¢ï¼Ÿ
3. 00 01 å¼•ç”¨å¸¸é‡æ± ä¸­ #1 é¡¹ï¼Œå³ã€ Method java/lang/Object.â€œâ€ğŸ˜¦)V ã€‘
4. b1 è¡¨ç¤ºè¿”å›

å¦ä¸€ä¸ªæ˜¯ public static void main(java.lang.String[]); ä¸»æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤:

    b2 00 02 12 03 b6 00 04 b1

1. b2 => _getstatic_ ç”¨æ¥åŠ è½½é™æ€å˜é‡ï¼Œå“ªä¸ªé™æ€å˜é‡å‘¢ï¼Ÿ
2. 00 02 å¼•ç”¨å¸¸é‡æ± ä¸­ #2 é¡¹ï¼Œå³ã€Field java/lang/System.out:Ljava/io/PrintStream;ã€‘
3. 12 => _ldc_ åŠ è½½å‚æ•°ï¼Œå“ªä¸ªå‚æ•°å‘¢ï¼Ÿ
4. 03 å¼•ç”¨å¸¸é‡æ± ä¸­ #3 é¡¹ï¼Œå³ ã€String hello worldã€‘
5. b6 => _invokevirtual_ é¢„å¤‡è°ƒç”¨æˆå‘˜æ–¹æ³•ï¼Œå“ªä¸ªæ–¹æ³•å‘¢ï¼Ÿ
6. 00 04 å¼•ç”¨å¸¸é‡æ± ä¸­ #4 é¡¹ï¼Œå³ã€Method java/io/PrintStream.println:(Ljava/lang/String;)Vã€‘
7. b1 è¡¨ç¤ºè¿”å›

å‚è€ƒæŒ‡ä»¤ï¼šhttps://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html

#### **3.2.2 javap å·¥å…·**

* è‡ªå·±åˆ†æç±»æ–‡ä»¶ç»“æ„å¤ªéº»çƒ¦äº†ï¼ŒOracle æä¾›äº† javap å·¥å…·æ¥åç¼–è¯‘ class æ–‡ä»¶

      PS F:\code\01-jdk8\target\classes\org\example> javap -v HelloWorld.class
  Classfile /F:/code/01-jdk8/target/classes/org/example/HelloWorld.class
  Last modified 2023-3-22; size 557 bytes
  MD5 checksum 57c168fae73b3812b396f260776e1773
  Compiled from "HelloWorld.java"
  public class org.example.HelloWorld
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
  Constant pool:
  #1 = Methodref #6.#20 // java/lang/Object."":()V
  #2 = Fieldref #21.#22 // java/lang/System.out:Ljava/io/PrintStream;
  #3 = String #23 // hello world
  #4 = Methodref #24.#25 // java/io/PrintStream.println:(Ljava/lang/String;)V
  #5 = Class #26 // org/example/HelloWorld
  #6 = Class #27 // java/lang/Object
  #7 = Utf8               
  #8 = Utf8               ()V
  #9 = Utf8 Code
  #10 = Utf8 LineNumberTable
  #11 = Utf8 Lo alVariableTable
  #12 = Utf8 this
  #13 = Utf8 Lorg/example/HelloWorld;
  #14 = Utf8 main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8 args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8 SourceFile
  #19 = Utf8 HelloWorld.java
  #20 = NameAndType #7:#8 // "":()V
  #21 = Class #28 // java/lang/System
  #22 = NameAndType #29:#30 // out:Ljava/io/PrintStream;
  #23 = Utf8 hello world
  #24 = Class #31 // java/io/PrintStream
  #25 = NameAndType #32:#33 // println:(Ljava/lang/String;)V
  #26 = Utf8 org/example/HelloWorld
  #27 = Utf8 java/lang/Object
  #28 = Utf8 java/lang/System
  #29 = Utf8 out
  #30 = Utf8 Ljava/io/PrintStream;
  #31 = Utf8 java/io/PrintStream
  #32 = Utf8 println
  #33 = Utf8               (Ljava/lang/String;)V
  {
  public org.example.HelloWorld();
  descriptor: ()V
  flags: ACC_PUBLIC
  Code:
  stack=1, locals=1, args_size=1
  0: aload_0
  1: invokespecial #1 // Method java/lang/Object."":()V
  4: return
  LineNumberTable:
  line 9: 0
  Error: unknown attribute
  Lo alVariableTable: length = 0xC
  00 01 00 00 00 05 00 0C 00 0D 00 00

  public static void main(java.lang.String[]);
  descriptor: ([Ljava/lang/String;)V
  flags: ACC_PUBLIC, ACC_STATIC
  Code:
  stack=2, locals=1, args_size=1
  0: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream;
  3: ldc #3 // String hello world
  5: invokevirtual #4 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
  8: return
  LineNumberTable:
  line 11: 0
  line 12: 8
  Error: unknown attribute
  Lo alVariableTable: length = 0xC
  00 01 00 00 00 09 00 10 00 11 00 00
  }
  SourceFile: "HelloWorld.java"

#### **3.2.3 å›¾è§£æ–¹æ³•æ‰§è¡Œæµç¨‹**

1. **åŸå§‹** **java** **ä»£ç **

   package org.example;
   /**
   *æ¼”ç¤º å­—èŠ‚ç æŒ‡ä»¤ å’Œ æ“ä½œæ•°æ ˆã€å¸¸é‡æ± çš„å…³ç³»
   */
   public class Demo3_2_3 {
   public static void main(String[] args) {
   int a = 10;
   int b = Short.MAX_VALUE + 1;
   int c = a + b;
   System.out.println(c);
   }
   }


2. **ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶**

   F:\code\01-jdk8\target\classes\org\example>javap -v Demo3_2_3.class
   Classfile /F:/code/01-jdk8/target/classes/org/example/Demo3_2_3.class
   Last modified 2023-3-22; size 613 bytes
   MD5 checksum fe8db4afd14d848f69b4b945e4e93751
   Compiled from "Demo3_2_3.java"
   public class org.example.Demo3_2_3
   minor version: 0
   major version: 52
   flags: ACC_PUBLIC, ACC_SUPER
   Constant pool:
   #1 = Methodref #7.#25 // java/lang/Object."":()V
   #2 = Class #26 // java/lang/Short
   #3 = Integer 32768
   #4 = Fieldref #27.#28 // java/lang/System.out:Ljava/io/PrintStream;
   #5 = Methodref #29.#30 // java/io/PrintStream.println:(I)V
   #6 = Class #31 // org/example/Demo3_2_3
   #7 = Class #32 // java/lang/Object
   #8 = Utf8               
   #9 = Utf8               ()V
   #10 = Utf8 Code
   #11 = Utf8 LineNumberTable
   #12 = Utf8 LocalVariableTable
   #13 = Utf8 this
   #14 = Utf8 Lorg/example/Demo3_2_3;
   #15 = Utf8 main
   #16 = Utf8               ([Ljava/lang/String;)V
   #17 = Utf8 args
   #18 = Utf8               [Ljava/lang/String;
   #19 = Utf8 a
   #20 = Utf8 I
   #21 = Utf8 b
   #22 = Utf8 c
   #23 = Utf8 SourceFile
   #24 = Utf8 Demo3_2_3.java
   #25 = NameAndType #8:#9 // "":()V
   #26 = Utf8 java/lang/Short
   #27 = Class #33 // java/lang/System
   #28 = NameAndType #34:#35 // out:Ljava/io/PrintStream;
   #29 = Class #36 // java/io/PrintStream
   #30 = NameAndType #37:#38 // println:(I)V
   #31 = Utf8 org/example/Demo3_2_3
   #32 = Utf8 java/lang/Object
   #33 = Utf8 java/lang/System
   #34 = Utf8 out
   #35 = Utf8 Ljava/io/PrintStream;
   #36 = Utf8 java/io/PrintStream
   #37 = Utf8 println
   #38 = Utf8               (I)V
   {
   public org.example.Demo3_2_3();
   descriptor: ()V
   flags: ACC_PUBLIC
   Code:
   stack=1, locals=1, args_size=1
   0: aload_0
   1: invokespecial #1 // Method java/lang/Object."":()V
   4: return
   LineNumberTable:
   line 5: 0
   LocalVariableTable:
   Start Length Slot Name Signature
   0 5 0 this Lorg/example/Demo3_2_3;

   public static void main(java.lang.String[]);
   descriptor: ([Ljava/lang/String;)V
   flags: ACC_PUBLIC, ACC_STATIC
   Code:
   stack=2, locals=4, args_size=1
   0: bipush 10
   2: istore_1
   3: ldc #3 // int 32768
   5: istore_2
   6: iload_1
   7: iload_2
   8: iadd
   9: istore_3
   10: getstatic #4 // Field java/lang/System.out:Ljava/io/PrintStream;
   13: iload_3
   14: invokevirtual #5 // Method java/io/PrintStream.println:(I)V
   17: return
   LineNumberTable:
   line 7: 0
   line 8: 3
   line 9: 6
   line 10: 10
   line 11: 17
   LocalVariableTable:
   Start Length Slot Name Signature
   0 18 0 args   [Ljava/lang/String;
   3 15 1 a I
   6 12 2 b I
   10 8 3 c I
   }
   SourceFile: "Demo3_2_3.java"


3. **å¸¸é‡æ± è½½å…¥è¿è¡Œæ—¶å¸¸é‡æ± **

![image-20230322232553830](https://img-
blog.csdnimg.cn/img_convert/b0e1ceb9883b1ee3c97ce1f5048ec7d6.png)

4. **æ–¹æ³•å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒº**

![image-20230322232951272](https://img-
blog.csdnimg.cn/img_convert/a9199ff491f746c49a92badb7d9f0d54.png)

5. **main** **çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œåˆ†é…æ ˆå¸§å†…å­˜**

ï¼ˆstack=2ï¼Œlocals=4ï¼‰

![image-20230322233027223](https://img-
blog.csdnimg.cn/img_convert/06f208f29f916f43e2b6ae2c3fc1aa19.png)

6. **æ‰§è¡Œå¼•æ“å¼€å§‹æ‰§è¡Œå­—èŠ‚ç **

**bipush 10**

    * å°†ä¸€ä¸ª byte å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰ï¼Œç±»ä¼¼çš„æŒ‡ä»¤è¿˜æœ‰
    * sipush å°†ä¸€ä¸ª short å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰
    * ldc å°†ä¸€ä¸ª int å‹å…¥æ“ä½œæ•°æ ˆ
    * ldc2_w å°†ä¸€ä¸ª long å‹å…¥æ“ä½œæ•°æ ˆï¼ˆåˆ†ä¸¤æ¬¡å‹å…¥ï¼Œå› ä¸º long æ˜¯ 8 ä¸ªå­—èŠ‚ï¼‰
    * è¿™é‡Œå°çš„æ•°å­—éƒ½æ˜¯å’Œå­—èŠ‚ç æŒ‡ä»¤å­˜åœ¨ä¸€èµ·ï¼Œè¶…è¿‡ short èŒƒå›´çš„æ•°å­—å­˜å…¥äº†å¸¸é‡æ± 

![image-20230322233213607](https://img-
blog.csdnimg.cn/img_convert/dfdb08553a1f15d612e9e527d6ffd74b.png)

**istore_1**

    * å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1

![image-20230322233352360](https://img-
blog.csdnimg.cn/img_convert/abf9045646aabd36098f1ee0a872d6d8.png)

**ldc #3**

    * ä»å¸¸é‡æ± åŠ è½½ #3 æ•°æ®åˆ°æ“ä½œæ•°æ ˆ

    * **æ³¨æ„** Short.MAX_VALUE æ˜¯ 32767ï¼Œæ‰€ä»¥ 32768 = Short.MAX_VALUE + 1 å®é™…æ˜¯åœ¨ç¼–è¯‘æœŸé—´è®¡ç®—å¥½çš„

![image-20230322233708705](https://img-
blog.csdnimg.cn/img_convert/94a569353d524d971d5331bcde669c24.png)

**istore_2**

    * å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2

![image-20230322233750833](https://img-
blog.csdnimg.cn/img_convert/ccd3876aa7db438bf82ee58046d23ab2.png)

**iload_1**

![image-20230322233833279](https://img-
blog.csdnimg.cn/img_convert/881f0f2f21496af7c23a2d51d7f12e2f.png)

**iload_2**

![image-20230322233853006](https://img-
blog.csdnimg.cn/img_convert/8db84985a16583f6e189c564c127ff46.png)

**iadd**

![image-20230322233918425](https://img-
blog.csdnimg.cn/img_convert/014e006e4bac8fec6440dd312c7b6cf3.png)

**istore_3**

    * å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 3

![image-20230322233934574](https://img-
blog.csdnimg.cn/img_convert/d3feb38f3f9bd7ad76cbccb6e4374e77.png)

![image-20230322234001854](https://img-
blog.csdnimg.cn/img_convert/263e69ced05dafeef0ccfe26801dff7e.png)

**getstatic #4**

![image-20230322234023327](https://img-
blog.csdnimg.cn/img_convert/1826fea9f97cb7a3ae292d42906d581b.png)

![image-20230322234102629](https://img-
blog.csdnimg.cn/img_convert/45639121e735bac0079074d4035ad3ad.png)

**iload_3**

![image-20230322234135800](https://img-
blog.csdnimg.cn/img_convert/d1b6627c0c789f7ddbedbe23824e134f.png)

**invokevirtual #5**

    * æ‰¾åˆ°å¸¸é‡æ±  #5 é¡¹
    * å®šä½åˆ°æ–¹æ³•åŒº java/io/PrintStream.println:(I)V æ–¹æ³•
    * ç”Ÿæˆæ–°çš„æ ˆå¸§ï¼ˆåˆ†é… localsã€stackç­‰ï¼‰
    * ä¼ é€’å‚æ•°ï¼Œæ‰§è¡Œæ–°æ ˆå¸§ä¸­çš„å­—èŠ‚ç 

![image-20230322234246703](https://img-
blog.csdnimg.cn/img_convert/d12b1c07f2c75833b0d5be37ca562f3f.png)

    * æ‰§è¡Œå®Œæ¯•ï¼Œå¼¹å‡ºæ ˆå¸§

    * æ¸…é™¤ main æ“ä½œæ•°æ ˆå†…å®¹

![image-20230322234344280](https://img-
blog.csdnimg.cn/img_convert/2507728c34757973c370ea4f3c2a4253.png)

**return**

    * å®Œæˆ main æ–¹æ³•è°ƒç”¨ï¼Œå¼¹å‡º main æ ˆå¸§
    * ç¨‹åºç»“æŸ

#### 3.2.4 **åˆ†æ** **i++**

> ç›®çš„ï¼šä»å­—èŠ‚ç è§’åº¦åˆ†æ a++ ç›¸å…³é¢˜ç›®

1. æºç ï¼š

   package org.example;
   /**
    * ä»å­—èŠ‚ç è§’åº¦åˆ†æ a++
      */
      public class Demo3_2_4 {
      public static void main(String[] args) {
      int a = 10;
      int b = a++ + ++a + a--;
      System.out.println(a);
      System.out.println(b);
      }
      }


2. å­—èŠ‚ç ï¼š

   public static void main(java.lang.String[]);
   descriptor: ([Ljava/lang/String;)V
   flags: ACC_PUBLIC, ACC_STATIC
   Code:
   stack=2, locals=3, args_size=1
   0: bipush 10
   2: istore_1
   3: iload_1
   4: iinc 1, 1
   7: iinc 1, 1
   10: iload_1
   11: iadd
   12: iload_1
   13: iinc 1, -1
   16: iadd
   17: istore_2
   18: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream;
   21: iload_1
   22: invokevirtual #3 // Method java/io/PrintStream.println:(I)V
   25: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream;
   28: iload_2
   29: invokevirtual #3 // Method java/io/PrintStream.println:(I)V
   32: return
   LineNumberTable:
   line 7: 0
   line 8: 3
   line 9: 18
   line 10: 25
   line 11: 32
   LocalVariableTable:
   Start Length Slot Name Signature
   0 33 0 args   [Ljava/lang/String;
   3 30 1 a I
   18 15 2 b I


3. åˆ†æï¼š

    * æ³¨æ„ iinc æŒ‡ä»¤æ˜¯ç›´æ¥åœ¨å±€éƒ¨å˜é‡ slot ä¸Šè¿›è¡Œè¿ç®—
    * a++ å’Œ ++a çš„åŒºåˆ«æ˜¯å…ˆæ‰§è¡Œ iload è¿˜æ˜¯ å…ˆæ‰§è¡Œ iinc

![image-20230322235442105](https://img-
blog.csdnimg.cn/img_convert/a709d73a73c6aaeea1d3655493c45f57.png)

![image-20230322235621083](https://img-
blog.csdnimg.cn/img_convert/9c488d8952c96d749d7583ed42c5090e.png)

![image-20230322235728800](https://img-
blog.csdnimg.cn/img_convert/056295a7b0b3e0c33be70fe8c1d45c86.png)

![image-20230322235809539](https://img-
blog.csdnimg.cn/img_convert/628110f2561b61cd4c32464831e5fce1.png)

![image-20230322235852668](https://img-
blog.csdnimg.cn/img_convert/45cb1ca595d2cfa303d9d0ae7d58cc0d.png)

![image-20230323000030541](https://img-
blog.csdnimg.cn/img_convert/888c28c995e26c86b7f56d112fbfa718.png)

![image-20230323000042668](https://img-
blog.csdnimg.cn/img_convert/3ddd80cbb9d897b09aaff0a6280f43a0.png)

![image-20230323000103174](https://img-
blog.csdnimg.cn/img_convert/9390ff44eef1225b22c4a25f5a6515d8.png)

![image-20230323000114597](https://img-
blog.csdnimg.cn/img_convert/4544290bfc72088353d10bcec92e8915.png)

![image-20230323000130301](https://img-
blog.csdnimg.cn/img_convert/5fe38b3f8cc6214eb8039a7821f682a4.png)

![image-20230323000141764](https://img-
blog.csdnimg.cn/img_convert/ae412a7a7679386969d5b08ddf9d0f37.png)

#### 3.2.5 **æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤**

 æŒ‡ä»¤   | åŠ©è®°ç¬¦       | å«ä¹‰           
------|-----------|--------------  
 0x99 | ifeq      | åˆ¤æ–­æ˜¯å¦ == 0    
 0x9a | ifne      | åˆ¤æ–­æ˜¯å¦ != 0    
 0x9b | iflt      | åˆ¤æ–­æ˜¯å¦ < 0     
 0x9c | ifge      | åˆ¤æ–­æ˜¯å¦ >= 0    
 0x9d | ifgt      | åˆ¤æ–­æ˜¯å¦ > 0     
 0x9e | ifle      | åˆ¤æ–­æ˜¯å¦ <= 0    
 0x9f | if_icmpeq | ä¸¤ä¸ªintæ˜¯å¦ ==   
 0xa0 | if_icmpne | ä¸¤ä¸ªintæ˜¯å¦ !=   
 0xa1 | if_icmplt | ä¸¤ä¸ªintæ˜¯å¦ <    
 0xa2 | if_icmpge | ä¸¤ä¸ªintæ˜¯å¦ >=   
 0xa3 | if_icmpgt | ä¸¤ä¸ªintæ˜¯å¦ >    
 0xa4 | if_icmple | ä¸¤ä¸ªintæ˜¯å¦ <=   
 0xa5 | if_acmpeq | ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦ ==    
 0xa6 | if_acmpne | ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦ !=    
 0xc6 | ifnull    | åˆ¤æ–­æ˜¯å¦ == null 
 0xc7 | ifnonnull | åˆ¤æ–­æ˜¯å¦ != null 

> å‡ ç‚¹è¯´æ˜ï¼š
>
>   * byteï¼Œshortï¼Œchar éƒ½ä¼šæŒ‰ int æ¯”è¾ƒï¼Œå› ä¸ºæ“ä½œæ•°æ ˆéƒ½æ˜¯ 4 å­—èŠ‚
>   * goto ç”¨æ¥è¿›è¡Œè·³è½¬åˆ°æŒ‡å®šè¡Œå·çš„å­—èŠ‚ç 
>

**æºç ï¼š**

    package org.example;
    /**
     * æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤:ç»ƒä¹ 
     */
    public class Demo3_2_5 {
        public static void main(String[] args) {
            int a = 0;
            if (a == 0) {
                a = 10;
            } else {
                a = 20;
            }
        }
    }

**å­—èŠ‚ç å¹¶åˆ†æï¼š**

    		0: iconst_0   //æŠŠ0å…¥æ“ä½œç¬¦æ ˆä¸­
             1: istore_1  //æ ˆé¡¶çš„æ•°æ®èµ‹å€¼ç»™slot 1ä¸­çš„a (a=0)
             2: iload_1		//slot_1ä¸­çš„æ•°æ®å…¥æ ˆ
             3: ifne          12 //åˆ¤æ–­æ ˆé¡¶çš„æ•°æ®æ˜¯å¦ç­‰äº0ï¼Œå¦‚æœç­‰äºé›¶å¾€ä¸‹æ‰§è¡Œï¼Œåä¹‹è·³è½¬åˆ°								æŒ‡ä»¤ä½ç½®12ï¼ˆ 12: bipush        20ï¼‰
             6: bipush        10 //10å…¥æ ˆ
             8: istore_1		//æ ˆé¡¶çš„æ•°æ®èµ‹å€¼ç»™slot_1ä¸­çš„a (a=10)
             9: goto          15 //ç›´æ¥è·³è½¬åˆ°æŒ‡ä»¤ä½ç½® 15ï¼ˆ15: returnï¼‰
            12: bipush        20 //20å…¥æ ˆ
            14: istore_1		//æ ˆé¡¶çš„æ•°æ®èµ‹å€¼ç»™slot_1ä¸­çš„a (a=20)
            15: return			//é€€å‡ºç¨‹åº

> æ€è€ƒï¼šä»¥ä¸Šæ¯”è¾ƒæŒ‡ä»¤ä¸­æ²¡æœ‰ longï¼Œflfloatï¼Œdouble çš„æ¯”è¾ƒï¼Œé‚£ä¹ˆå®ƒä»¬è¦æ¯”è¾ƒæ€ä¹ˆåŠï¼Ÿå‚è€ƒ
> https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp

#### 3.2.6 **å¾ªç¯æ§åˆ¶æŒ‡ä»¤**

**æºç ï¼š**

    public class Demo_01 {
        public static void main(String[] args) {
            int a = 0;
            while (a < 10) {
                a++;
            }
        }
    }

**å­—èŠ‚ç å¹¶åˆ†æ**

      		0: iconst_0      		//å…¥æ ˆ0
             1: istore_1			//å‡ºæ ˆï¼Œå¹¶èµ‹å€¼ç»™a a=0
             2: iload_1				//å…¥æ ˆaçš„å€¼
             3: bipush        10	//å…¥æ ˆ10
             5: if_icmpge     14	//å‡ºæ ˆä¸¤ä¸ªæ•°æ¯”è¾ƒï¼Œå¦‚æœæˆç«‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œåä¹‹è·³è½¬åˆ°14:return
             8: iinc          1, 1  //slot[1]ä½ç½®çš„æ•°+1 ï¼Œå°±æ˜¯a=a+1
            11: goto          2		//è·³è½¬åˆ°2ï¼šiload_1
            14: return				//ç»“æŸæ–¹æ³•

* do-while,foræ‰§è¡Œçš„å­—èŠ‚ç ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢åˆ†æï¼Œå¹¶ä¸”æ¯”è¾ƒ while å’Œ for çš„å­—èŠ‚ç ï¼Œå‘ç°å®ƒä»¬æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ®Šé€”ä¹Ÿèƒ½åŒå½’

**ç»ƒä¹ ï¼š**

_æºç ï¼š_

    public class Demo_02 {
        public static void main(String[] args) {
            int i = 0;
            int x = 0;
            while (i < 10) {
                x = x++;
                i++;
            }
            System.out.println(x);//è¾“å‡ºï¼š0
        }
    }

å­—èŠ‚ç å¹¶åˆ†æï¼š

    0: iconst_0					//å…¥æ ˆï¼š0
    1: istore_1					//å‡ºæ ˆï¼Œå¹¶èµ‹å€¼ç»™slot[1] i=0
    2: iconst_0					//å…¥æ ˆï¼š0
    3: istore_2					//å‡ºæ ˆï¼Œå¹¶èµ‹å€¼slot[2] x=0
    4: iload_1					//slot[1]çš„å€¼å…¥æ ˆ
    5: bipush        10			//å…¥æ ˆ10
    7: if_icmpge     21			//å‡ºæ ˆä¸¤ä¸ªæ•°å¹¶æ¯”è¾ƒï¼Œæ»¡è¶³æ¡ä»¶ç»§ç»­ï¼Œåä¹‹è·³è½¬åˆ°21:getstatic     #2 
    10: iload_2					//slot[2]çš„å€¼å…¥æ ˆ
    11: iinc          2, 1		//slot[2]å€¼è‡ªå¢
    14: istore_2				//å‡ºæ ˆå¹¶èµ‹å€¼ç»™slot[2] 
    15: iinc          1, 1		//slot[1]å€¼è‡ªå¢
    18: goto          4			//è·³è½¬åˆ°4ï¼š
    21: getstatic     #2          // System.outå¯¹è±¡å…¥æ ˆField java/lang/System.out:Ljava/io/PrintStream;
    24: iload_2					//slot[2]çš„å€¼å…¥æ ˆ
    25: invokevirtual #3                  //Method java/io/PrintStream.println:(I)V
    28: return

#### 3.2.7 æ„é€ æ–¹æ³•

**ç¬¬ä¸€ç±»ï¼š()V**

_**æºç ï¼š**_

    public class Demo_03 {
        static int i = 10;
    
        static {
            i = 20;
        }
    
        static {
            i = 30;
        }
    }

> Javaæ˜¯æ‡’åŠ è½½ï¼Œåˆ›å»ºçš„ç±»ä¸ä¼šç›´æ¥ç¼–è¯‘å¹¶äº§ç”Ÿå¯¹åº”çš„classæ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†å¾—åˆ°è¿™ä¸ªç±»çš„classï¼Œåœ¨å…¶ä»–çš„ç±»ä¸­åˆ›å»ºè¯¥ç±»çš„å¯¹åº”çš„å¯¹è±¡å°±å¥½äº†ï¼šDemo_03
> demo_03 = new Demo_03();

_**å­—èŠ‚ç å¹¶åˆ†æï¼š**_

* ç¼–è¯‘å™¨ä¼šæŒ‰ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ static é™æ€ä»£ç å—å’Œé™æ€æˆå‘˜èµ‹å€¼çš„ä»£ç ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ–¹  
  æ³• ()V ï¼š

    {
      static int i;
        descriptor: I
        flags: ACC_STATIC
    
      public com.exp.test01.Demo_03();
        descriptor: ()V
        flags: ACC_PUBLIC
        Code:
          stack=1, locals=1, args_size=1
             0: aload_0
             1: invokespecial #1          //è°ƒç”¨æ–¹æ³• Method java/lang/Object."":()V
             4: return
          LineNumberTable:
            line 3: 0
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                0       5     0  this   Lcom/exp/test01/Demo_03;
    
      static {};
        descriptor: ()V
        flags: ACC_STATIC
        Code:
          stack=1, locals=0, args_size=0
             0: bipush        10		//å…¥æ ˆ10
             2: putstatic     #2         //å‡ºæ ˆï¼Œå¹¶è¯¥å€¼èµ‹å€¼åˆ°å¸¸é‡æ± ä¸­çš„å˜é‡ Field i:I
             5: bipush        20		//å…¥æ ˆ20
             7: putstatic     #2          // å‡ºæ ˆï¼Œå¹¶è¯¥å€¼èµ‹å€¼åˆ°å¸¸é‡æ± ä¸­çš„å˜é‡  Field i:I
            10: bipush        30		//å…¥æ ˆ20
            12: putstatic     #2         //å‡ºæ ˆï¼Œå¹¶è¯¥å€¼èµ‹å€¼åˆ°å¸¸é‡æ± ä¸­çš„å˜é‡ Field i:I
            15: return
          LineNumberTable:
            line 4: 0
            line 7: 5
            line 11: 10
            line 12: 15
    }

> å¯ä»¥è°ƒæ•´ä¸€ä¸‹ static å˜é‡å’Œé™æ€ä»£ç å—çš„ä½ç½®ï¼Œè§‚å¯Ÿå­—èŠ‚ç çš„æ”¹åŠ¨ï¼ˆä¸‹é¢æ˜¯static å˜é‡æ”¾åˆ°æœ€ä¸‹é¢å¾—åˆ°çš„å­—èŠ‚ç ï¼‰
>
> 0: bipush 20  
> 2: putstatic #2 // Field i:I  
> 5: bipush 30  
> 7: putstatic #2 // Field i:I  
> 10: bipush 10  
> 12: putstatic #2 // Field i:I  
> 15: return

**ç¬¬äºŒç±»ï¼š()V**

_æºç ï¼š_

    public class Demo_04 {
        private String a = "s1";
    
        {
            b = 20;
        }
    
        private int b = 10;
    
        {
            a = "s2";
        }
    
        public Demo_04(String a, int b) {
            this.a = a;
            this.b = b;
        }
    
        public static void main(String[] args) {
            Demo_04 demo_04 = new Demo_04("ss", 27);
            System.out.println(demo_04.a); // ss
            System.out.println(demo_04.b);// 27
        }
    }

_å­—èŠ‚ç å¹¶åˆ†æ_

* ç¼–è¯‘å™¨ä¼šæŒ‰ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ {} ä»£ç å—å’Œæˆå‘˜å˜é‡èµ‹å€¼çš„ä»£ç ï¼Œå½¢æˆæ–°çš„æ„é€ æ–¹æ³•ï¼Œä½†åŸå§‹æ„é€ æ–¹æ³•å†…çš„ä»£ç æ€»æ˜¯åœ¨æœ€å

    {
      public com.exp.test01.Demo_04(java.lang.String, int);
        descriptor: (Ljava/lang/String;I)V
        flags: ACC_PUBLIC
        Code:
          stack=2, locals=3, args_size=3
             0: aload_0				//this å…¥æ ˆ
             1: invokespecial #1      //è°ƒç”¨çˆ¶ç±»æ„é€ ï¼šsuper.()V Methodjava/lang/Object."":()V
             4: aload_0				//this å…¥æ ˆ
             5: ldc           #2      // s1 å…¥æ ˆ
             7: putfield      #3       //å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.a = "s1": Field a:Ljava/lang/String;
            10: aload_0				//this å…¥æ ˆ
            11: bipush        20		//å…¥æ ˆ;20
            13: putfield      #4         // å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.b = 20 Field b:I
            16: aload_0				   //this å…¥æ ˆ
            17: bipush        10		//å…¥æ ˆ10
            19: putfield      #4         // å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.b = 10 Field b:I
            22: aload_0					//this å…¥æ ˆ
            23: ldc           #5         // "s2" å…¥æ ˆ String s2
            25: putfield      #3         // å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.a = "s2" Field a:Ljava/lang/String;
            28: aload_0					//---------------------æ—§çš„æ„é€ æ–¹æ³•-------------------------
            29: aload_1					//slot[1]å…¥æ ˆ :"ss"
            30: putfield      #3           // å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.a = "ss"Field a:Ljava/lang/String;
            33: aload_0						//this å…¥æ ˆ
            34: iload_2						slot[2]å…¥æ ˆ :27
            35: putfield      #4            // å‡ºæ ˆå¹¶èµ‹å€¼ç»™æˆå‘˜å˜é‡this.b = 27 Field b:I------------------
            38: return
          LineNumberTable:
            line 16: 0
            line 4: 4
            line 7: 10
            line 10: 16
            line 13: 22
            line 17: 28
            line 18: 33
            line 19: 38
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                0      39     0  this   Lcom/exp/test01/Demo_04;
                0      39     1     a   Ljava/lang/String;
                0      39     2     b   I
    
      public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
          stack=4, locals=2, args_size=1
             0: new           #6                  // class com/exp/test01/Demo_04
             3: dup
             4: ldc           #7                  // String ss
             6: bipush        27
             8: invokespecial #8                  // Method "":(Ljava/lang/String;I)V
            11: astore_1
            12: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
            15: aload_1
            16: getfield      #3                  // Field a:Ljava/lang/String;
            19: invokevirtual #10                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
            22: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
            25: aload_1
            26: getfield      #4                  // Field b:I
            29: invokevirtual #11                 // Method java/io/PrintStream.println:(I)V
            32: return
          LineNumberTable:
            line 22: 0
            line 23: 12
            line 24: 22
            line 25: 32
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                0      33     0  args   [Ljava/lang/String;
               12      21     1 demo_04   Lcom/exp/test01/Demo_04;
    }

#### 3.2.8 æ–¹æ³•è°ƒç”¨

**æºç ï¼š**

    public class Demo_05 {
        public Demo_05() {
        }
    
        private void test01() {
        }
    
        private final void test02() {
        }
    
        public void test03() {
        }
    
        public static void test04() {
    
        }
    
        public static void main(String[] args) {
            Demo_05 demo_05 = new Demo_05();
            demo_05.test01();
            demo_05.test02();
            demo_05.test03();
            demo_05.test04();
            Demo_05.test04();
        }
    }

**å­—èŠ‚ç å¹¶åˆ†æï¼š**

     0: new           #2                  // class com/exp/test01/Demo_05
    3: dup
    4: invokespecial #3                  // Method "":()V
    7: astore_1
    8: aload_1
    9: invokespecial #4                  // Method test01:()V
    12: aload_1
    13: invokespecial #5                  // Method test02:()V
    16: aload_1
    17: invokevirtual #6                  // Method test03:()V
    20: aload_1
    21: pop
    22: invokestatic  #7                  // Method test04:()V
    25: invokestatic  #7                  // Method test04:()V
    28: return

* new æ˜¯åˆ›å»ºã€å¯¹è±¡ã€‘ï¼Œç»™å¯¹è±¡åˆ†é…å †å†…å­˜ï¼Œæ‰§è¡ŒæˆåŠŸä¼šå°†ã€å¯¹è±¡å¼•ç”¨ã€‘å‹å…¥æ“ä½œæ•°æ ˆ
* dup æ˜¯èµ‹å€¼æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œæœ¬ä¾‹å³ä¸ºã€å¯¹è±¡å¼•ç”¨ã€‘ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½å¼•ç”¨å‘¢ï¼Œä¸€ä¸ªæ˜¯è¦é…åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³•
  â€œâ€ğŸ˜¦)V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼Œå¦ä¸€ä¸ªè¦é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡
* æœ€ç»ˆæ–¹æ³•ï¼ˆfinalï¼‰ï¼Œç§æœ‰æ–¹æ³•ï¼ˆprivateï¼‰ï¼Œæ„é€ æ–¹æ³•éƒ½æ˜¯ç”± invokespecial æŒ‡ä»¤æ¥è°ƒç”¨ï¼Œå±äºé™æ€ç»‘å®š
* æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äºåŠ¨æ€ç»‘å®šï¼Œå³æ”¯æŒå¤šæ€
* æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦ã€å¯¹è±¡å¼•ç”¨ã€‘æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ d.test4();
  æ˜¯é€šè¿‡ã€å¯¹è±¡å¼•ç”¨ã€‘è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨invokestatic ä¹‹å‰æ‰§è¡Œäº† pop æŒ‡ä»¤ï¼ŒæŠŠã€å¯¹è±¡å¼•ç”¨ã€‘ä»æ“ä½œæ•°æ ˆå¼¹æ‰äº†
* è¿˜æœ‰ä¸€ä¸ªæ‰§è¡Œ invokespecial çš„æƒ…å†µæ˜¯é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•

#### 3.2.9 å¤šæ€åŸç†

_**æºç ï¼š**_

    package com.exp.test01;
    
    import java.io.IOException;
    
    /**
     *æ¼”ç¤ºå¤šæ€åŸç†ï¼Œæ³¨æ„å…ˆåŠ ä¸Šä¸€ä¸‹JVMå‚æ•°ï¼Œç¦ç”¨æŒ‡é’ˆå‹ç¼©
     * -XX:-UseCompressedOops -XX:-UseCompressedClassPointers
     */
    public class Demo_06 {
        public static void test(Animal animal) {
            animal.eat();
            System.out.println(animal);
        }
    
        public static void main(String[] args) throws IOException {
            Animal cat = new Cat();
            Animal dog = new Dog();
            test(cat);
            test(dog);
            System.in.read();
        }
    }
    
    abstract class Animal {
        public abstract void eat();
    
        @Override
        public String toString() {
            return "æˆ‘æ˜¯" + this.getClass().getSimpleName();
        }
    }
    
    class Dog extends Animal {
        @Override
        public void eat() {
            System.out.println("å•ƒéª¨å¤´");
        }
    }
    
    class Cat extends Animal {
        @Override
        public void eat() {
            System.out.println("åƒé±¼");
        }
    }

1. è¿è¡Œä»£ç 

    * åœåœ¨ System.in.read() æ–¹æ³•ä¸Šï¼Œè¿™æ—¶è¿è¡Œ jps è·å–è¿›ç¨‹ id

![image-20230327012536023](https://img-
blog.csdnimg.cn/img_convert/a93043b1447f88e820df3034572ae36d.png)

2. è¿è¡Œ HSDB å·¥å…·

    * è¿›å…¥ JDK å®‰è£…ç›®å½•ï¼Œæ‰§è¡Œ

`java -cp ./lib/sa-jdi.jar sun.jvm.hotspot.HSDB`

    * è¿›å…¥å›¾å½¢ç•Œé¢ attach è¿›ç¨‹ id

![image-20230327004943965](https://img-
blog.csdnimg.cn/img_convert/75cc2614d592858a208779edfed62a82.png)

3. æŸ¥æ‰¾æŸä¸ªå¯¹è±¡

    * æ‰“å¼€ Tools -> Find Object By Query

è¾“å…¥ select d from com.exp.test01.Dog d ç‚¹å‡» Execute æ‰§è¡Œ ç‚¹å‡» Execute æ‰§è¡Œ

æŸ¥åˆ°çš„æ˜¯è¯¥å¯¹è±¡çš„å†…å­˜ä¸­æŒ‡é’ˆåœ°å€

![image-20230327012708354](https://img-
blog.csdnimg.cn/img_convert/3b120dfedf35685e5fe8fb0080a94024.png)

4. æŸ¥çœ‹å¯¹è±¡å†…å­˜ç»“æ„

    * ç‚¹å‡»è¶…é“¾æ¥å¯ä»¥çœ‹åˆ°å¯¹è±¡çš„å†…å­˜ç»“æ„ï¼Œæ­¤å¯¹è±¡æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œå› æ­¤åªæœ‰å¯¹è±¡å¤´çš„ 16 å­—èŠ‚ï¼Œå‰ 8 å­—èŠ‚æ˜¯MarkWordï¼Œå 8 å­—èŠ‚å°±æ˜¯å¯¹è±¡çš„ Class æŒ‡é’ˆã€‚ä½†ç›®å‰çœ‹ä¸åˆ°å®ƒçš„å®é™…åœ°å€ã€‚

![image-20230327012746849](https://img-
blog.csdnimg.cn/img_convert/2293a18eb657710c6a944e7980dedf10.png)

5. æŸ¥çœ‹å¯¹è±¡ Class çš„å†…å­˜åœ°å€

æ–¹æ³•ä¸€ï¼š

    * å¯ä»¥é€šè¿‡ Windows -> Console è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œæ‰§è¡Œ

mem 0x0000000741354d00 2

mem æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° 1 æ˜¯å¯¹è±¡åœ°å€ï¼Œå‚æ•° 2 æ˜¯æŸ¥çœ‹ 2 è¡Œï¼ˆå³ 16 å­—èŠ‚ï¼‰

_ç»“æœä¸­ç¬¬äºŒè¡Œ 0x00000000f800c1c1 å³ä¸º Class çš„å†…å­˜åœ°å€ã€‚ã€‚ã€‚_

> å‘ç°æˆ‘æŸ¥å‡ºæ¥çš„å†…å­˜åœ°å€ä¸å¯¹ï¼Œæš‚æ—¶æ²¡æŸ¥åˆ°åŸå›  æ­£ç¡®åœ°å€åº”è¯¥æ˜¯ï¼š
> [0x00000007c0060e08](klass=0x00000007c0060e08)

æ–¹æ³•äºŒï¼š

    * Tools -> Class Browser è¾“å…¥ Dog æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æœ

![image-20230327013356596](https://img-
blog.csdnimg.cn/img_convert/634f40ba82d0848d49c126125207b234.png)

6. æŸ¥çœ‹ç±»çš„ vtable

    * æ— è®ºé€šè¿‡å“ªç§æ–¹æ³•æ‰¾åˆ°å†…å­˜åœ°å€ï¼Œéƒ½å¯ä»¥æ‰¾åˆ°å¾—åˆ°å†…å­˜åœ°å€0x00000007c0060e08

    * Tools ->Inspector [ Alt+R] è¿›å…¥ Inspector å·¥å…·ï¼Œè¾“å…¥åˆšæ‰çš„ Class å†…å­˜åœ°å€

![image-20230327013305508](https://img-
blog.csdnimg.cn/img_convert/97d84ec31d354186195c0d9080d5d637.png)

    * ç„¶å çœ‹åˆ°Dog Class çš„ vtable é•¿åº¦ä¸º 6ï¼Œæ„æ€å°±æ˜¯ Dog ç±»æœ‰ 6 ä¸ªè™šæ–¹æ³•ï¼ˆå¤šæ€ç›¸å…³çš„ï¼Œfinalï¼Œstatic ä¸ä¼šåˆ—å…¥ï¼‰ã€‚

![image-20230327013544678](https://img-
blog.csdnimg.cn/img_convert/f2ef22ef66e29c2f7c358a8794abf2ff.png)

é‚£ä¹ˆè¿™ 6 ä¸ªæ–¹æ³•éƒ½æ˜¯è°å‘¢ï¼Ÿä» Class çš„èµ·å§‹åœ°å€å¼€å§‹ç®—ï¼Œåç§» 0x1b8 å°±æ˜¯ vtable çš„èµ·å§‹åœ°å€ï¼Œè¿›è¡Œè®¡ç®—å¾—åˆ°ï¼š

        0x00000007c0060e08
                0x1b8 +
    --------------------
    0x00000007c0060fc0

é€šè¿‡ Windows -> Console è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œæ‰§è¡Œ

        mem 0x00000007c0060fc0 6
    0x00000007c0060fc0: 0x000002c9d3790c10 
    0x00000007c0060fc8: 0x000002c9d37906e8 
    0x00000007c0060fd0: 0x000002c9d3b93088 
    0x00000007c0060fd8: 0x000002c9d3790640 
    0x00000007c0060fe0: 0x000002c9d3790778 
    0x00000007c0060fe8: 0x000002c9d3b93658 

å°±å¾—åˆ°äº† 6 ä¸ªè™šæ–¹æ³•çš„å…¥å£åœ°å€

7. éªŒè¯æ–¹æ³•åœ°å€

    * é€šè¿‡ Tools -> Class Browser æŸ¥çœ‹æ¯ä¸ªç±»çš„æ–¹æ³•å®šä¹‰ï¼Œæ¯”è¾ƒå¯çŸ¥

![image-20230327020141911](https://img-
blog.csdnimg.cn/img_convert/5af5ae642f61dbf854866c212548d6cf.png)

å‘ç°eat() æ–¹æ³•æ˜¯ Dog ç±»è‡ªå·±çš„

![image-20230327020433084](https://img-
blog.csdnimg.cn/img_convert/e005d21fbe9734bd43313ff6eea583a7.png)

å‘ç°toString()æ–¹æ³•æ˜¯ Animal ç±»çš„

![image-20230327020848676](https://img-
blog.csdnimg.cn/img_convert/af46dfb72aa712c3c301fc769ccee6ba.png)

å‘ç°å‰©ä½™çš„å››ä¸ªæ–¹æ³•ï¼ˆfinalizeï¼Œequalsï¼ŒhashCodeï¼Œcloneï¼‰éƒ½æ˜¯è°ƒç”¨Objectç±»ä¸­çš„æ–¹æ³•ã€‚

8. å°ç»“ï¼š

å½“æ‰§è¡Œ invokevirtual æŒ‡ä»¤æ—¶ï¼Œ

    1. å…ˆé€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨æ‰¾åˆ°å¯¹è±¡
    2. åˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡çš„å®é™… Class
    3. Class ç»“æ„ä¸­æœ‰ vtableï¼Œå®ƒåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µå°±å·²ç»æ ¹æ®æ–¹æ³•çš„é‡å†™è§„åˆ™ç”Ÿæˆå¥½äº†
    4. æŸ¥è¡¨å¾—åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€
    5. æ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 

#### 3.2.10 å¼‚å¸¸å¤„ç†

**1.try-catch**

**æºç ï¼š**

    public class Demo_07 {
        public static void main(String[] args) {
            int i = 0;
            try {
                i = 10;
            } catch (Exception e) {
                i = 20;
            }
        }
    }

**å­—èŠ‚ç å¹¶åˆ†æï¼š**

    {
      public com.exp.test01.Demo_07();
        descriptor: ()V           //æ„é€ æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­ä¸é‡è¦
        flags: ACC_PUBLIC
        Code:
          stack=1, locals=1, args_size=1
             0: aload_0
             1: invokespecial #1                  // Method java/lang/Object."":()V
             4: return
          LineNumberTable:
            line 3: 0
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                0       5     0  this   Lcom/exp/test01/Demo_07;
    
      public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
          stack=1, locals=3, args_size=1
             0: iconst_0			//0->æ“ä½œç¬¦æ ˆ
             1: istore_1			//0<-æ“ä½œç¬¦æ ˆ <=> i=0
             2: bipush        10	//10->æ“ä½œç¬¦æ ˆ
             4: istore_1			//10<-æ“ä½œç¬¦æ ˆ <=> i=10
             5: goto          12	//-->return
             8: astore_2			//e->æ“ä½œç¬¦æ ˆ
             9: bipush        20	//20->æ“ä½œç¬¦æ ˆ
            11: istore_1			//20<-æ“ä½œç¬¦æ ˆ <=> i=20
            12: return				//ç»“æŸç¨‹åº
          Exception table:		//å¼‚å¸¸è¡¨
             from    to  target type
                 2     5     8   Class java/lang/Exception //è¯´æ˜ï¼šè¦æ£€æµ‹ç¬¬äºŒè¡Œåˆ°ç¬¬äº”è¡Œçš„ä»£ç [2,5)ï¼Œå¦‚æœ
                      									//å‡ºç°å¼‚ï¼Œå…ˆå¼‚å¸¸ç±»å‹åŒ¹é…ï¼Œç„¶åè¿›å…¥ç¬¬å…«è¡Œç»§ç»­æ‰§è¡Œ
          LineNumberTable:
            line 5: 0
            line 7: 2
            line 10: 5
            line 8: 8
            line 9: 9
            line 11: 12
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                9       3     2     e   Ljava/lang/Exception;
                0      13     0  args   [Ljava/lang/String;
                2      11     1     i   I
          StackMapTable: number_of_entries = 2
            frame_type = 255 /* full_frame */
              offset_delta = 8
              locals = [ class "[Ljava/lang/String;", int ]
              stack = [ class java/lang/Exception ]
            frame_type = 3 /* same */
    }

* å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ª Exception table çš„ç»“æ„ï¼Œ[from, to) æ˜¯å‰é—­åå¼€çš„æ£€æµ‹èŒƒå›´ï¼Œä¸€æ—¦è¿™ä¸ªèŒƒå›´å†…çš„å­—èŠ‚ç æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œåˆ™é€šè¿‡
  type åŒ¹é…å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœä¸€è‡´ï¼Œè¿›å…¥ target æ‰€æŒ‡ç¤ºè¡Œå·
* 8 è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ astore_2 æ˜¯å°†å¼‚å¸¸å¯¹è±¡å¼•ç”¨å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2 ä½ç½®

**2.å¤šä¸ª single-catch å—çš„æƒ…å†µ**

**æºç ï¼š**

    public class Demo_08 {
        public static void main(String[] args) {
            int i = 0;
            try {
                i = 10;
            } catch (ArithmeticException e) {
                i = 30;
            } catch (NullPointerException e) {
                i = 40;
            } catch (Exception e) {
                i = 50;
            }
        }
    }

**å­—èŠ‚ç å¹¶åˆ†æï¼š**

      	stack=1, locals=3, args_size=1
             0: iconst_0
             1: istore_1
             2: bipush        10
             4: istore_1
             5: goto          26
             8: astore_2
             9: bipush        30
            11: istore_1
            12: goto          26
            15: astore_2
            16: bipush        40
            18: istore_1
            19: goto          26
            22: astore_2
            23: bipush        50
            25: istore_1
            26: return
          Exception table: //å¼‚å¸¸è¡¨ï¼šå¯ä»¥å‘ç°ä»–ä»¬éƒ½æ˜¯æ£€æµ‹åŒä¸€ä¸ªä»£ç æ®µï¼Œå¹¶ä¸”æ ¹æ®typeåŒ¹é…å¹¶è·³è½¬åˆ°å¯¹åº”çš„ä½ç½®ç»§ç»­æ‰§è¡Œ
             from    to  target type   
                 2     5     8   Class java/lang/ArithmeticException
                 2     5    15   Class java/lang/NullPointerException
                 2     5    22   Class java/lang/Exception
          LineNumberTable:
            line 5: 0
            line 7: 2
            line 14: 5
            line 8: 8
            line 9: 9
            line 14: 12
            line 10: 15
            line 11: 16
            line 14: 19
            line 12: 22
            line 13: 23
            line 15: 26
          LocalVariableTable: //å±€éƒ¨å˜é‡è¡¨ï¼šå‘ç°eçš„å­˜å‚¨è¿‡ç¨‹ä¸­åº”ç”¨äº†å¡æ§½çš„å¤ç”¨
            Start  Length  Slot  Name   Signature
                9       3     2     e   Ljava/lang/ArithmeticException; 
               16       3     2     e   Ljava/lang/NullPointerException;
               23       3     2     e   Ljava/lang/Exception;
                0      27     0  args   [Ljava/lang/String;
                2      25     1     i   I

**3.multi-catch çš„æƒ…å†µ**

æºç ï¼š

    public class Demo_09 {
        public static void main(String[] args) {
            try {
                Method test = Demo_09.class.getMethod("test");
                test.invoke(null);
            } catch (NoSuchMethodException | IllegalAccessException |
                     InvocationTargetException e) {
                e.printStackTrace();
            }
        }
    
        public static void test() {
            System.out.println("ok");
        }
    }

å­—èŠ‚ç å¹¶åˆ†æï¼š

     Code:
          stack=3, locals=2, args_size=1
             0: ldc           #2                  // class com/exp/test01/Demo_09
             2: ldc           #3                  // String test
             4: iconst_0
             5: anewarray     #4                  // class java/lang/Class
             8: invokevirtual #5                  // Method java/lang/Class.getMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;
            11: astore_1
            12: aload_1
            13: aconst_null
            14: iconst_0
            15: anewarray     #6                  // class java/lang/Object
            18: invokevirtual #7                  // Method java/lang/reflect/Method.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;
            21: pop
            22: goto          30
            25: astore_1
            26: aload_1
            27: invokevirtual #11                 // Method java/lang/ReflectiveOperationException.printStackTrace:()V
            30: return
          Exception table:
             from    to  target type
                 0    22    25   Class java/lang/NoSuchMethodException
                 0    22    25   Class java/lang/IllegalAccessException
                 0    22    25   Class java/lang/reflect/InvocationTargetException
          LineNumberTable:
            line 9: 0
            line 10: 12
            line 14: 22
            line 11: 25
            line 13: 26
            line 15: 30
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
               12      10     1  test   Ljava/lang/reflect/Method;
               26       4     1     e   Ljava/lang/ReflectiveOperationException;
                0      31     0  args   [Ljava/lang/String;

**4.finally**

æºç ï¼š

    public class Demo_10 {
        public static void main(String[] args) {
            int i = 0;
            try {
                i = 10;
            } catch (Exception e) {
                i = 20;
            } finally {
                i = 30;
            }
        }
    }

å­—èŠ‚ç å¹¶åˆ†æï¼š

     Code:
          stack=1, locals=4, args_size=1
             0: iconst_0			
             1: istore_1			//0-> i
             2: bipush        10	//try-----------------begin----------
             4: istore_1			//10->i
             5: bipush        30	//finally
             7: istore_1			//30->i
             8: goto          27	//return----------------end--------
            11: astore_2			//catch Exception â€”â€”> e -------
            12: bipush        20	//
            14: istore_1			//20->i
            15: bipush        30	//finally
            17: istore_1			//30->i
            18: goto          27	//return------------------------
            21: astore_3			//catch any â€”â€”> slot[3] -------
            22: bipush        30	//finally
            24: istore_1			//30->i
            25: aload_3				//<-slot[3] 
            26: athrow				//throw-----------------------
            27: return
          Exception table:
             from    to  target type
                 2     5    11   Class java/lang/Exception
                 2     5    21   any	//å‰©ä½™çš„å¼‚å¸¸ç±»å‹å¦‚error
                11    15    21   any	//å‰©ä½™çš„å¼‚å¸¸ç±»å‹å¦‚error
          LineNumberTable:
            line 5: 0
            line 7: 2
            line 11: 5
            line 12: 8
            line 8: 11
            line 9: 12
            line 11: 15
            line 12: 18
            line 11: 21
            line 12: 25
            line 13: 27
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
               12       3     2     e   Ljava/lang/Exception;
                0      28     0  args   [Ljava/lang/String;
                2      26     1     i   I

* å¯ä»¥çœ‹åˆ° finally ä¸­çš„ä»£ç è¢«å¤åˆ¶äº† 3 ä»½ï¼Œåˆ†åˆ«æ”¾å…¥ try æµç¨‹ï¼Œcatch æµç¨‹ä»¥åŠ catch å‰©ä½™çš„å¼‚å¸¸ç±»å‹æµç¨‹

#### 3.2.11 finallyç›¸å…³é¢è¯•é¢˜

**1.finally å‡ºç°äº† return**

æºç ï¼š

    public class Demo_11 {
        public static void main(String[] args) {
            int result = test();
            System.out.println(result); //20
        }
    
        public static int test() {
            try {
                return 10;
            } finally {
                return 20;
            }
        }
    }

å­—èŠ‚ç å¹¶åˆ†æï¼š

     stack=1, locals=2, args_size=0
             0: bipush        10	//<-10 å…¥æ ˆ
             2: istore_0			//10 -> slot[0]
             3: bipush        20	//<-20 å…¥æ ˆ
             5: ireturn				//è¿”å›æ ˆé¡¶å…ƒç´  int(20)
             6: astore_1			//catch any->slot[1]----------
             7: bipush        20	//<-20 å…¥æ ˆ
             9: ireturn				//è¿”å›æ ˆé¡¶å…ƒç´  int(20)
          Exception table:
             from    to  target type
                 0     3     6   any

* ç”±äº finally ä¸­çš„ ireturn è¢«æ’å…¥äº†æ‰€æœ‰å¯èƒ½çš„æµç¨‹ï¼Œå› æ­¤è¿”å›ç»“æœè‚¯å®šä»¥ finally çš„ä¸ºå‡†

* è‡³äºå­—èŠ‚ç ä¸­ç¬¬ 2 è¡Œï¼Œä¼¼ä¹æ²¡å•¥ç”¨ï¼Œä¸”ç•™ä¸ªä¼ç¬”ï¼Œçœ‹ä¸‹ä¸ªä¾‹å­

* è·Ÿä¸Šä¾‹ä¸­çš„ finally ç›¸æ¯”ï¼Œå‘ç°æ²¡æœ‰ athrow äº†ï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬ï¼šå¦‚æœåœ¨ finally ä¸­å‡ºç°äº† returnï¼Œä¼šåæ‰å¼‚å¸¸

      public class Demo_12 {
      public static void main(String[] args) {
          int result = test();
          System.out.println(result);//20
      }

      public static int test() {
          try {
              int i = 1 / 0; //æ²¡æœ‰å¼‚å¸¸throw ,åŸå› æ˜¯åœ¨finallyä¸­çš„returnåæ‰è¯¥å¼‚å¸¸
              return 10;
          } finally {
              return 20;
          }
      }
  }

2.finally å¯¹è¿”å›å€¼å½±å“

æºç ï¼š

    public class Demo_13 {
        public static void main(String[] args) {
            int result = test();
            System.out.println(result);//10
        }
    
        public static int test() {
            int i = 10;
            try {
                return i;
            } finally {
                i = 20;
            }
        }
    }

å­—èŠ‚ç å¹¶åˆ†æï¼š

    stack=1, locals=3, args_size=0
             0: bipush        10	//<- 10 æ”¾å…¥æ ˆé¡¶
             2: istore_0			//10->i
             3: iload_0				//<- i(10)
             4: istore_1			//10 -> slot 1ï¼Œæš‚å­˜è‡³ slot 1ï¼Œç›®çš„æ˜¯ä¸ºäº†å›ºå®šè¿”å›å€¼
             5: bipush        20	//<- 20 æ”¾å…¥æ ˆé¡¶
             7: istore_0			// 20 -> i
             8: iload_1				// <- slot 1(10) è½½å…¥ slot 1 æš‚å­˜çš„å€¼
             9: ireturn				// è¿”å›æ ˆé¡¶çš„ int(10)
            10: astore_2			//catch anyå¼•ç”¨-> å…¥æ ˆ ---------
            11: bipush        20	//æ‰§è¡Œfinally 
            13: istore_0			//20->i
            14: aload_2				//anyå¼•ç”¨<- å‡ºæ ˆ
            15: athrow				//æŠ›å¼‚å¸¸
          Exception table:
             from    to  target type
                 3     5    10   any

#### 3.2.12 synchronized

æºç ï¼š

    public class Demo_14 {
        public static void main(String[] args) {
            Object lock = new Object();
            synchronized (lock) {
                System.out.println("ok");
            }
        }
    }

å­—èŠ‚ç æŒ‡ä»¤å’Œåˆ†æï¼š

     public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
          stack=2, locals=4, args_size=1
             0: new           #2                  // class java/lang/Object
             3: dup
             4: invokespecial #1                  // Method java/lang/Object."":()V
             7: astore_1						//lock:å¼•ç”¨ ->lock
             8: aload_1							//<-lock --------synchronized-----
             9: dup								//å¤åˆ¶lockå¼•ç”¨ï¼šä¸€ä¸ªåŠ é”ç”¨ï¼Œå¦ä¸€ä¸ªè§£é”ç”¨
            10: astore_2						//ä¸€ä»½lockå¼•ç”¨ï¼Œæš‚æ—¶å‡ºæ ˆå¹¶æš‚å­˜åˆ°slot 2ä¸­
            11: monitorenter					//monitorenter[lock]:åŠ é”æ“ä½œ
            12: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
            15: ldc           #4                  // String ok
            17: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
            20: aload_2							//å‰é¢æš‚å­˜åˆ°slot 2ä¸­lockå¼•ç”¨å…¥æ ˆ
            21: monitorexit						//monitorexit[lock]:è§£é”æ“ä½œ
            22: goto          30				//return
            25: astore_3						//catchï¼šany - > slot 3
            26: aload_2							//å‰é¢æš‚å­˜åˆ°slot 2ä¸­lockå¼•ç”¨å…¥æ ˆ
            27: monitorexit						//monitorexit[lock]:è§£é”æ“ä½œ
            28: aload_3							//<- slot 3
            29: athrow
            30: return
          Exception table:
             from    to  target type
                12    22    25   any
                25    28    25   any
          LineNumberTable:
            line 5: 0
            line 6: 8
            line 7: 12
            line 8: 20
            line 9: 30
          LocalVariableTable:
            Start  Length  Slot  Name   Signature
                0      31     0  args   [Ljava/lang/String;
                8      23     1  lock   Ljava/lang/Object;

* æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°

### 3.3 ç¼–è¯‘æœŸå¤„ç†

> æ‰€è°“çš„ è¯­æ³•ç³– ï¼Œå…¶å®å°±æ˜¯æŒ‡ java ç¼–è¯‘å™¨æŠŠ *.java æºç ç¼–è¯‘ä¸º *.class
> å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨ç”Ÿæˆå’Œè½¬æ¢çš„ä¸€äº›ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼Œç®—æ˜¯ java ç¼–è¯‘å™¨ç»™æˆ‘ä»¬çš„ä¸€ä¸ªé¢å¤–ç¦åˆ©ï¼ˆç»™ç³–åƒå˜›ï¼‰  
> æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç çš„åˆ†æï¼Œå€ŸåŠ©äº† javap å·¥å…·ï¼Œidea çš„åç¼–è¯‘åŠŸèƒ½ï¼Œidea æ’ä»¶ jclasslib ç­‰å·¥å…·ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è½¬æ¢çš„ç»“æœç›´æ¥å°±æ˜¯
> class å­—èŠ‚ç ï¼Œ **åªæ˜¯ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œç»™å‡ºäº† å‡ ä¹ç­‰ä»· çš„ java æºç æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ç¼–è¯‘å™¨è¿˜ä¼šè½¬æ¢å‡ºä¸­é—´çš„ java æºç ï¼Œåˆ‡è®°ã€‚**

#### 3.3.1 é»˜è®¤æ„é€ å™¨

æºç ï¼š

    public class Candy01 {
    }

ç¼–ç¨‹æˆClassåçš„ä»£ç å¹¶åˆ†æï¼š

    public class Candy01 {
        // è¿™ä¸ªæ— å‚æ„é€ æ˜¯ç¼–è¯‘å™¨å¸®åŠ©æˆ‘ä»¬åŠ ä¸Šçš„
        public Candy01() {
            super(); // å³è°ƒç”¨çˆ¶ç±» Object çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå³è°ƒç”¨ java/lang/Object."":()V
        }
    }

#### 3.3.2 è‡ªåŠ¨æ‹†è£…ç®±

* è¿™ä¸ªç‰¹æ€§æ˜¯ JDK 5 å¼€å§‹åŠ å…¥çš„ï¼Œ ä»£ç ç‰‡æ®µ1 ï¼š

      public class Candy02 {
      public static void main(String[] args) {
          Integer x = 1;
          int y = x;
      }
  }


* è¿™æ®µä»£ç åœ¨ JDK 5 ä¹‹å‰æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå¿…é¡»æ”¹å†™ä¸º ä»£ç ç‰‡æ®µ2 :

      public class Candy2 {
  	public static void main(String[] args) {
  		Integer x = Integer.valueOf(1);
  		int y = x.intValue();
  	}
  }


* æ˜¾ç„¶ä¹‹å‰ç‰ˆæœ¬çš„ä»£ç å¤ªéº»çƒ¦äº†ï¼Œéœ€è¦åœ¨åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹ä¹‹é—´æ¥å›è½¬æ¢(å°¤å…¶æ˜¯é›†åˆç±»ä¸­æ“ä½œçš„éƒ½æ˜¯åŒ…è£…ç±»å‹)
  ã€‚å› æ­¤è¿™äº›è½¬æ¢çš„äº‹å„¿åœ¨JDK5ä»¥åéƒ½æ˜¯ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆã€‚å³ä»£ç ç‰‡æ®µ1éƒ½ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«è½¬åŒ–ä¸ºä»£ç ç‰‡æ®µ2ã€‚

#### 3.3.3 æ³›å‹é›†åˆå–å€¼

* æ³›å‹ä¹Ÿæ˜¯åœ¨ JDK 5 å¼€å§‹åŠ å…¥çš„ç‰¹æ€§ï¼Œä½† java åœ¨ç¼–è¯‘æ³›å‹ä»£ç åä¼šæ‰§è¡Œ **æ³›å‹æ“¦é™¤** çš„åŠ¨ä½œï¼Œå³æ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ä¹‹åå°±ä¸¢å¤±äº†ï¼Œå®é™…çš„ç±»å‹éƒ½å½“åšäº†
  Object ç±»å‹æ¥å¤„ç†ï¼š

      public class Candy03 {

      public static void main(String[] args) {
          List<Integer> list = new ArrayList<>();
          list.add(10); // å®é™…è°ƒç”¨çš„æ˜¯ List.add(Object e)
          Integer x = list.get(0); // å®é™…è°ƒç”¨çš„æ˜¯ Object obj = List.get(int index);
      }
  }


* æ‰€ä»¥åœ¨å–å€¼æ—¶ï¼Œç¼–è¯‘å™¨çœŸæ­£ç”Ÿæˆçš„å­—èŠ‚ç ä¸­ï¼Œè¿˜è¦é¢å¤–åšä¸€ä¸ªç±»å‹è½¬æ¢çš„æ“ä½œï¼š

      // éœ€è¦å°† Object è½¬ä¸º Integer
  Integer x = (Integer)list.get(0);


* å¦‚æœå‰é¢çš„ x å˜é‡ç±»å‹ä¿®æ”¹ä¸º int åŸºæœ¬ç±»å‹é‚£ä¹ˆæœ€ç»ˆç”Ÿæˆçš„å­—èŠ‚ç æ˜¯ï¼š

      // éœ€è¦å°† Object è½¬ä¸º Integer, å¹¶æ‰§è¡Œæ‹†ç®±æ“ä½œ
  int x = ((Integer)list.get(0)).intValue();


* æ“¦é™¤çš„æ˜¯å­—èŠ‚ç ä¸Šçš„æ³›å‹ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ° LocalVariableTypeTable ä»ç„¶ä¿ç•™äº†æ–¹æ³•å‚æ•°æ³›å‹çš„ä¿¡æ¯

      {
  public com.exp.test02.Candy03();
  descriptor: ()V
  flags: ACC_PUBLIC
  Code:
  stack=1, locals=1, args_size=1
  0: aload_0
  1: invokespecial #1 // Method java/lang/Object."":()V
  4: return
  LineNumberTable:
  line 6: 0
  LocalVariableTable:
  Start Length Slot Name Signature
  0 5 0 this Lcom/exp/test02/Candy03;

  public static void main(java.lang.String[]);
  descriptor: ([Ljava/lang/String;)V
  flags: ACC_PUBLIC, ACC_STATIC
  Code:
  stack=2, locals=3, args_size=1
  0: new #2 // class java/util/ArrayList
  3: dup
  4: invokespecial #3 // Method java/util/ArrayList."":()V
  7: astore_1
  8: aload_1
  9: bipush 10
  11: invokestatic #4 --è£…ç®± // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
  14: invokeinterface #5, 2 --ç±»å‹è¢«æ¶ˆé™¤äº† // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z
  19: pop
  20: aload_1
  21: iconst_0
  22: invokeinterface #6, 2 --ç±»å‹è¢«æ¶ˆé™¤äº† // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;
  27: checkcast #7 --ç±»å‹å¼ºåˆ¶è½¬æ¢ // class java/lang/Integer
  30: astore_2
  31: return
  LineNumberTable:
  line 9: 0
  line 10: 8
  line 11: 20
  line 12: 31
  LocalVariableTable:
  Start Length Slot Name Signature  
  0 32 0 args   [Ljava/lang/String;
  8 24 1 list Ljava/util/List;
  31 1 2 x Ljava/lang/Integer;
  LocalVariableTypeTable: //å±€éƒ¨å˜é‡ç±»å‹è¡¨
  Start Length Slot Name Signature
  8 24 1 list Ljava/util/List<Ljava/lang/Integer;>;
  }


* ä½¿ç”¨åå°„ï¼Œä»ç„¶èƒ½å¤Ÿè·å¾—è¿™äº›ä¿¡æ¯ï¼š

      public Set test(List list,Map map){
      return new HashSet();
  }

  public static void main(String[] args) throws NoSuchMethodException {
  Method test = Candy03.class.getMethod("test", List.class, Map.class);
  Type[] types = test.getGenericParameterTypes();
  for (Type type :
  types) {
  if (type instanceof ParameterizedType){
  ParameterizedType parameterizedType = (ParameterizedType) type;
  System.out.println("åŸå§‹ç±»å‹ - "+parameterizedType.getRawType());
  Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();
  for (int i = 0; i < actualTypeArguments.length; i++) {
  System.out.printf("æ³›å‹å‚æ•°[%d] - %s\n",i,actualTypeArguments[i]);
  }
  }
  }
  }

è¾“å‡ºï¼š

![image-20230327134849182](https://img-
blog.csdnimg.cn/img_convert/330219aa8013763e750d790c13fd54bd.png)ã€

#### 3.3.4 å¯å˜å‚æ•°

æºç ï¼š

* å¯å˜å‚æ•°ä¹Ÿæ˜¯ JDK 5 å¼€å§‹åŠ å…¥çš„æ–°ç‰¹æ€§ï¼š

      public class Candy04 {
      public static void foo(String... args) {
          String[] array = args; // ç›´æ¥èµ‹å€¼
          System.out.println(array);
      }

      public static void main(String[] args) {
          foo("hello", "world");
      }
  }


* å¯å˜å‚æ•° Stringâ€¦ args å…¶å®æ˜¯ä¸€ä¸ª String[] args ï¼Œä»ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚ åŒæ · java ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†ä¸Šè¿°ä»£ç å˜æ¢ä¸ºï¼š

      public class Candy04 {
      public static void foo(String[] args) {
          String[] array = args; // ç›´æ¥èµ‹å€¼
          System.out.println(array);
      }

      public static void main(String[] args) {
          foo(new String["hello", "world"]);
      }
  }

> æ³¨æ„ å¦‚æœè°ƒç”¨äº† foo() åˆ™ç­‰ä»·ä»£ç ä¸º foo(new String[]{}) ï¼Œåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œè€Œä¸ä¼šä¼ é€’ null è¿›å»

#### 3.3.5 foreach å¾ªç¯

* ä»æ˜¯ JDK 5 å¼€å§‹å¼•å…¥çš„è¯­æ³•ç³–ï¼Œæ•°ç»„çš„å¾ªç¯ï¼š

      public class Demo_05 {
      public static void main(String[] args) {
          int[] array = {1, 2, 3, 4, 5}; // æ•°ç»„èµ‹åˆå€¼çš„ç®€åŒ–å†™æ³•ä¹Ÿæ˜¯è¯­æ³•ç³–å“¦
          for (int e : array) {
              System.out.println(e);
          }
      }
  }

ç¼–è¯‘å™¨ä¼˜åŒ–åçš„ï¼š

        public class Demo_05 {
        public Demo_05() {
        }
        public static void main(String[] args) {
            int[] array = new int[]{1, 2, 3, 4, 5};
            int[] var2 = array;
            int var3 = array.length;
            for(int var4 = 0; var4 < var3; ++var4) {
                int e = var2[var4];
                System.out.println(e);
            }
        }
    }

* è€Œé›†åˆçš„å¾ªç¯ï¼š

      public class Demo_06 {
      public static void main(String[] args) {
          List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
          for (Integer i : list) {
              System.out.println(i);
          }
      }
  }

ç¼–è¯‘å™¨ä¼˜åŒ–åçš„ï¼š

        public class Demo_06 {
        public Demo_06() {
        }
        public static void main(String[] args) {
            List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
            Iterator var2 = list.iterator();
            while(var2.hasNext()) {
                Integer i = (Integer)var2.next();
                System.out.println(i);
            }
        }
    }

> æ³¨æ„ foreach å¾ªç¯å†™æ³•ï¼Œèƒ½å¤Ÿé…åˆæ•°ç»„ï¼Œä»¥åŠæ‰€æœ‰å®ç°äº† Iterable æ¥å£çš„é›†åˆç±»ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­ Iterable ç”¨æ¥è·å–é›†åˆçš„è¿­ä»£å™¨ï¼ˆ
> Iterator ï¼‰

#### 3.3.6 switch å­—ç¬¦ä¸²

ä» JDK 7 å¼€å§‹ï¼Œswitch å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²å’Œæšä¸¾ç±»ï¼Œè¿™ä¸ªåŠŸèƒ½å…¶å®ä¹Ÿæ˜¯è¯­æ³•ç³–ï¼Œä¾‹å¦‚ï¼š

    public class Demo_07 {
        public static void choose(String str) {
            switch (str) {
                case "hello": {
                    System.out.println("h");
                    break;
                }
                case "world": {
                    System.out.println("w");
                    break;
                }
            }
        }
    }

> **æ³¨æ„** switch é…åˆ String å’Œæšä¸¾ä½¿ç”¨æ—¶ï¼Œå˜é‡ä¸èƒ½ä¸ºnullï¼ŒåŸå› åˆ†æå®Œè¯­æ³•ç³–è½¬æ¢åçš„ä»£ç åº”å½“è‡ªç„¶æ¸…æ¥š

ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºï¼š

    public class Demo_07{
        public Demo_07(){
        }
        public static void choose(String str){
            String s = str;
            byte byte0 = -1;
            switch(s.hashCode()){
            case 99162322:  //helloçš„hashCode
                if(s.equals("hello"))
                    byte0 = 0;
                break;
    
            case 113318802: //worldçš„hashCode
                if(s.equals("world"))
                    byte0 = 1;
                break;
            }
            switch(byte0){
            case 0: // '\0'
                System.out.println("h");
                break;
    
            case 1: // '\001'
                System.out.println("w");
                break;
            }
        }
    }

å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†ä¸¤é switchï¼Œç¬¬ä¸€éæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„ hashCode å’Œ equals å°†å­—ç¬¦ä¸²çš„è½¬æ¢ä¸ºç›¸åº”byte ç±»å‹ï¼Œç¬¬äºŒéæ‰æ˜¯åˆ©ç”¨ byte
æ‰§è¡Œè¿›è¡Œæ¯”è¾ƒã€‚  
ä¸ºä»€ä¹ˆç¬¬ä¸€éæ—¶å¿…é¡»æ—¢æ¯”è¾ƒ hashCodeï¼Œåˆåˆ©ç”¨ equals æ¯”è¾ƒå‘¢ï¼ŸhashCode æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå‡å°‘å¯èƒ½çš„æ¯”è¾ƒï¼›è€Œ equals æ˜¯ä¸ºäº†é˜²æ­¢
hashCode å†²çªï¼Œä¾‹å¦‚ BM å’Œ C. è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„hashCodeå€¼éƒ½æ˜¯2123 ï¼Œå¦‚æœæœ‰å¦‚ä¸‹ä»£ç ï¼š

    public class Demo_08 {
        public static void choose(String str) {
            switch (str) {
                case "BM": {
                    System.out.println("h");
                    break;
                }
                case "C.": {
                    System.out.println("w");
                    break;
                }
            }
        }
    }

ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºï¼š

    public class Demo_08{
        public Demo_08(){
        }
        public static void choose(String str){
            String s = str;
            byte byte0 = -1;
            switch(s.hashCode()){
            case 2123:   // hashCode å€¼å¯èƒ½ç›¸åŒï¼Œéœ€è¦è¿›ä¸€æ­¥ç”¨ equals æ¯”è¾ƒ
                if(s.equals("C."))
                    byte0 = 1;
                else
                if(s.equals("BM"))
                    byte0 = 0;
                break;
            }
            switch(byte0){
            case 0: // '\0'
                System.out.println("h");
                break;
            case 1: // '\001'
                System.out.println("w");
                break;
            }
        }
    }

#### 3.3.7 switchæšä¸¾

æºç ï¼š

    public enum Sex {
        MALE,FEMALE
    }
    
    
    
    public class Demo_09 {
        public static void foo(Sex sex) {
            switch (sex) {
                case MALE:
                    System.out.println("ç”·");
                    break;
                case FEMALE:
                    System.out.println("å¥³");
                    break;
            }
        }
    }

è½¬å­—èŠ‚ç åï¼š

    public class Demo_09{
        public Demo_09(){}
        public static void foo(Sex sex){
            /**
            *å®šä¹‰äº†ä¸€ä¸ªåˆæˆç±»ï¼ˆä»…JVMä½¿ç”¨ï¼Œå¯¹æˆ‘ä»¬çœ‹ä¸è§ï¼‰
            *ç”¨æ¥æ˜ å°„æšä¸¾çš„ordinalä¸æ•°ç»„å…ƒç´ çš„å…³ç³»
            *æšä¸¾çš„ ordinal è¡¨ç¤ºæšä¸¾å¯¹è±¡çš„åºå·ï¼Œä» 0 å¼€å§‹
            *å³ MALE çš„ ordinal()=0ï¼ŒFEMALE çš„ ordinal()=1
            *ä¸‹é¢ä¸ºäº†çœ‹çš„æ¸…æ¥šæŠŠåŸæ¥çš„å˜é‡åç­‰ç®€åŒ–äº†
            * map = $SwitchMap$com$exp$test02$Sex
            */
            static class _cls1{
    		   //static final int $SwitchMap$com$exp$test02$Sex[];
                static final int map[];
                static {
                    //æ•°ç»„å¤§å°å³ä¸ºæšä¸¾å…ƒç´ ä¸ªæ•°ï¼Œé‡Œé¢å­˜å‚¨caseç”¨æ¥å¯¹æ¯”çš„æ•°å­—
                    map = new int[Sex.values().length];
                    try{
                        map[Sex.MALE.ordinal()] = 1;//map[0] = 1
                    }
                    catch(NoSuchFieldError nosuchfielderror) { }
                    try{
                        map[Sex.FEMALE.ordinal()] = 2; //map[1] =2
                    }
                    catch(NoSuchFieldError nosuchfielderror1) { }
                }
            }
    
            switch(_cls1.map[sex.ordinal()]){
            case 1: // '\001'
                System.out.println("\u7537");
                break;
    
            case 2: // '\002'
                System.out.println("\u5973");
                break;
            }
        }
    }

#### 3.3.8 æšä¸¾ç±»

> JDK 7 æ–°å¢äº†æšä¸¾ç±»ï¼Œä»¥å‰é¢çš„æ€§åˆ«æšä¸¾ä¸ºä¾‹ï¼š

æºç ï¼š

    public enum Sex {
        MALE,FEMALE
    }

è½¬ç åï¼š

    public final class Sex extends Enum{
        public static Sex[] values(){
            return (Sex[])$VALUES.clone();
        }
        public static Sex valueOf(String name){
            return (Sex)Enum.valueOf(com/exp/test02/Sex, name);
        }
        //ç§æœ‰æ„é€ æ–¹æ³•
        private Sex(String s, int i){
            super(s, i);
        }
        public static final Sex MALE;
        public static final Sex FEMALE;
        private static final Sex $VALUES[];
        static 
        {
            MALE = new Sex("MALE", 0);
            FEMALE = new Sex("FEMALE", 1);
            $VALUES = (new Sex[] {
                MALE, FEMALE
            });
        }
    }

#### 3.3.9 try-with-resources

JDK 7 å¼€å§‹æ–°å¢äº†å¯¹éœ€è¦å…³é—­çš„èµ„æºå¤„ç†çš„ç‰¹æ®Šè¯­æ³• try-with-resources`ï¼š

    try(èµ„æºå˜é‡ = åˆ›å»ºèµ„æºå¯¹è±¡){
    } catch( ) {
    }

å…¶ä¸­ **èµ„æºå¯¹è±¡éœ€è¦å®ç° AutoCloseable æ¥å£** ï¼Œä¾‹å¦‚ InputStream ã€ OutputStream ã€Connection ã€
Statement ã€ ResultSet ç­‰æ¥å£éƒ½å®ç°äº† AutoCloseable ï¼Œä½¿ç”¨ try-withresources å¯ä»¥ä¸ç”¨å†™
finally è¯­å¥å—ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©ç”Ÿæˆå…³é—­èµ„æºä»£ç ï¼Œä¾‹å¦‚ï¼š

    public class Demo_10 {
        public static void main(String[] args) {
            try (InputStream is = new FileInputStream("d:\\1.txt")) {
                System.out.println(is);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

è½¬åŒ–åï¼š

    public class Demo_10{
        public Demo_10(){}
        public static void main(String args[]){
            try{
            	InputStream is;
            	is = new FileInputStream("d:\\1.txt");
            	Throwable t = null;
            	try{
                	System.out.println(is);
            	} catch (Throwable e1) {
    				// t æ˜¯æˆ‘ä»¬ä»£ç å‡ºç°çš„å¼‚å¸¸
    				t = e1;
    				throw e1;
    			} finally {
    				// åˆ¤æ–­äº†èµ„æºä¸ä¸ºç©º
    				if (is != null) {
    					// å¦‚æœæˆ‘ä»¬ä»£ç æœ‰å¼‚å¸¸
    					if (t != null) {
    						try {
    							is.close();
    						} catch (Throwable e2) {
    							// å¦‚æœ close å‡ºç°å¼‚å¸¸ï¼Œä½œä¸ºè¢«å‹åˆ¶å¼‚å¸¸æ·»åŠ 
    							t.addSuppressed(e2);
    						}
    				} else {
    					// å¦‚æœæˆ‘ä»¬ä»£ç æ²¡æœ‰å¼‚å¸¸ï¼Œclose å‡ºç°çš„å¼‚å¸¸å°±æ˜¯æœ€å catch å—ä¸­çš„ e
    					is.close();
    				}
    			}
    		} catch (IOException e) {
    				e.printStackTrace();
    		}
    	}
    }

ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸€ä¸ª addSuppressed(Throwable e) ï¼ˆæ·»åŠ è¢«å‹åˆ¶å¼‚å¸¸ï¼‰çš„æ–¹æ³•å‘¢ï¼Ÿæ˜¯ä¸ºäº†é˜²æ­¢å¼‚å¸¸ä¿¡æ¯çš„ä¸¢å¤±ï¼ˆæƒ³æƒ³ try-with-
resources ç”Ÿæˆçš„ fianlly ä¸­å¦‚æœæŠ›å‡ºäº†å¼‚å¸¸ï¼‰ï¼š

    public class Demo_11 {
        public static void main(String[] args) {
            try (MyResource resource = new MyResource()) {
                int i = 1/0;
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    class MyResource implements AutoCloseable {
        public void close() throws Exception {
            throw new Exception("close å¼‚å¸¸");
        }
    }

è¾“å‡ºç»“æœï¼š

    java.lang.ArithmeticException: / by zero
    	at com.exp.test02.Demo_11.main(Demo_11.java:6)
    	Suppressed: java.lang.Exception: close å¼‚å¸¸
    		at com.exp.test02.MyResource.close(Demo_11.java:14)
    		at com.exp.test02.Demo_11.main(Demo_11.java:7)

#### 3.3.10 æ–¹æ³•é‡å†™æ—¶çš„æ¡¥æ¥æ–¹æ³•

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ–¹æ³•é‡å†™æ—¶å¯¹è¿”å›å€¼åˆ†ä¸¤ç§æƒ…å†µï¼š

* çˆ¶å­ç±»çš„è¿”å›å€¼å®Œå…¨ä¸€è‡´
* å­ç±»è¿”å›å€¼å¯ä»¥æ˜¯çˆ¶ç±»è¿”å›å€¼çš„å­ç±»ï¼ˆæ¯”è¾ƒç»•å£ï¼Œè§ä¸‹é¢çš„ä¾‹å­ï¼‰

    class A {
    	public Number m() {
    		return 1;
    	}
    }
    class B extends A {
    	@Override
    	// å­ç±» m æ–¹æ³•çš„è¿”å›å€¼æ˜¯ Integer æ˜¯çˆ¶ç±» m æ–¹æ³•è¿”å›å€¼ Number çš„å­ç±»
    	public Integer m() {
    		return 2;
    	}
    }

å¯¹äºå­ç±»ï¼Œjava ç¼–è¯‘å™¨ä¼šåšå¦‚ä¸‹å¤„ç†ï¼š

    class B extends A {
    	public Integer m() {
    		return 2;
    	}
    	// æ­¤æ–¹æ³•æ‰æ˜¯çœŸæ­£é‡å†™äº†çˆ¶ç±» public Number m() æ–¹æ³•
    	public synthetic bridge Number m() {
    		// è°ƒç”¨ public Integer m()
    		return m();
    	}
    }

å…¶ä¸­æ¡¥æ¥æ–¹æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œä»…å¯¹ java è™šæ‹Ÿæœºå¯è§ï¼Œå¹¶ä¸”ä¸åŸæ¥çš„ public Integer m() æ²¡æœ‰å‘½åå†²çªï¼Œå¯ä»¥  
ç”¨ä¸‹é¢åå°„ä»£ç æ¥éªŒè¯ï¼š

    for (Method m : B.class.getDeclaredMethods()) {
    	System.out.println(m);
    }

ä¼šè¾“å‡ºï¼š

    public java.lang.Integer test.candy.B.m()
    public java.lang.Number test.candy.B.m()

#### 3.3.11 åŒ¿åå†…éƒ¨ç±»

æºç ï¼š

    public class Candy11 {
        public static void main(String[] args) {
            Runnable runnable = new Runnable() {
                @Override
                public void run() {
                    System.out.println("ok");
                }
            };
        }
    }

è½¬æ¢åï¼š

    // é¢å¤–ç”Ÿæˆçš„ç±»
    final class Candy11$1 implements Runnable {
    	Candy11$1() {
    	}
    	public void run() {
    		System.out.println("ok");
    	}
    }
    public class Candy11 {
    	public static void main(String[] args) {
    		Runnable runnable = new Candy11$1();
    	}
    }

å¼•ç”¨å±€éƒ¨å˜é‡çš„åŒ¿åå†…éƒ¨ç±»ï¼Œæºä»£ç ï¼š

    public class Candy11 {
    	public static void test(final int x) {
    		Runnable runnable = new Runnable() {
    			@Override
    			public void run() {
    				System.out.println("ok:" + x);
    			}
    		};
    	}
    }

è½¬æ¢åï¼š

    // é¢å¤–ç”Ÿæˆçš„ç±»
    final class Candy11$1 implements Runnable {
    	int val$x;
    	Candy11$1(int x) {
    		this.val$x = x;
    	}
    	public void run() {
    		System.out.println("ok:" + this.val$x);
    	}
    }
    public class Candy11{
    	public static void test(final int x) {
    		Runnable runnable = new Candy11$1(x);
    	}
    }

> æ³¨æ„ è¿™åŒæ—¶è§£é‡Šäº†ä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»å¼•ç”¨å±€éƒ¨å˜é‡æ—¶ï¼Œå±€éƒ¨å˜é‡å¿…é¡»æ˜¯ final çš„ï¼šå› ä¸ºåœ¨åˆ›å»ºCandy11$1 å¯¹è±¡æ—¶ï¼Œå°† x çš„å€¼èµ‹å€¼ç»™äº†
> Candy11$1 å¯¹è±¡çš„ valxå± æ€§ ï¼Œ xä¸ åº” è¯¥ å† å‘ ç”Ÿ å˜ äº† ï¼Œ å¦‚ æœ å˜ äº†ï¼Œ é‚£ ä¹ˆ valx å±æ€§æ²¡æœ‰æœºä¼šå†è·Ÿç€ä¸€èµ·å˜åŒ–

### 3.4 ç±»åŠ è½½é˜¶æ®µ

#### 3.4.1 åŠ è½½

* å°†ç±»çš„å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒºä¸­ï¼Œå†…éƒ¨é‡‡ç”¨ C++ çš„ instanceKlass æè¿° java ç±»ï¼Œå®ƒçš„é‡è¦ field æœ‰ï¼š
    * _java_mirror å³ java çš„ç±»é•œåƒï¼Œä¾‹å¦‚å¯¹ String æ¥è¯´ï¼Œå°±æ˜¯ String.classï¼Œä½œç”¨æ˜¯æŠŠ klass æš´  
      éœ²ç»™ java ä½¿ç”¨

    * _super å³çˆ¶ç±»
    * _fields å³æˆå‘˜å˜é‡
    * _methods å³æ–¹æ³•
    * _constants å³å¸¸é‡æ± 
    * _class_loader å³ç±»åŠ è½½å™¨
    * _vtable è™šæ–¹æ³•è¡¨
    * _itable æ¥å£æ–¹æ³•è¡¨
* å¦‚æœè¿™ä¸ªç±»è¿˜æœ‰çˆ¶ç±»æ²¡æœ‰åŠ è½½ï¼Œå…ˆåŠ è½½çˆ¶ç±»
* åŠ è½½å’Œé“¾æ¥å¯èƒ½æ˜¯äº¤æ›¿è¿è¡Œçš„

> æ³¨æ„  
> instanceKlass è¿™æ ·çš„ã€å…ƒæ•°æ®ã€‘æ˜¯å­˜å‚¨åœ¨æ–¹æ³•åŒºï¼ˆ1.8 åçš„å…ƒç©ºé—´å†…ï¼‰ï¼Œä½† _java_mirror  
> æ˜¯å­˜å‚¨åœ¨å †ä¸­å¯ä»¥é€šè¿‡å‰é¢ä»‹ç»çš„ HSDB å·¥å…·æŸ¥çœ‹

![image-20230327175031337](https://img-
blog.csdnimg.cn/img_convert/9c0780bf84d3711c48076b24ce7aed4f.png)

#### 3.4.2 é“¾æ¥

**éªŒè¯**

* éªŒè¯ç±»æ˜¯å¦ç¬¦åˆ JVMè§„èŒƒï¼Œå®‰å…¨æ€§æ£€æŸ¥  
  ç”¨ UE ç­‰æ”¯æŒäºŒè¿›åˆ¶çš„ç¼–è¾‘å™¨ä¿®æ”¹ HelloWorld.class çš„é­”æ•°(CA -> AA)ï¼Œåœ¨æ§åˆ¶å°è¿è¡Œ

![image-20230327181134925](https://img-
blog.csdnimg.cn/img_convert/bac67414e32808812c686d9e4545220f.png)

![image-20230327181240368](https://img-
blog.csdnimg.cn/img_convert/b8655c7fea6efe1f5a260e421d589110.png)

**å‡†å¤‡** : ä¸º static å˜é‡åˆ†é…ç©ºé—´ï¼Œè®¾ç½®é»˜è®¤å€¼

* static å˜é‡åœ¨ JDK 7 ä¹‹å‰å­˜å‚¨äº instanceKlass æœ«å°¾ï¼Œä» JDK 7 å¼€å§‹ï¼Œå­˜å‚¨äº _java_mirror æœ«å°¾
* static å˜é‡åˆ†é…ç©ºé—´å’Œèµ‹å€¼æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ
* å¦‚æœ static å˜é‡æ˜¯ final çš„åŸºæœ¬ç±»å‹ï¼Œä»¥åŠå­—ç¬¦ä¸²å¸¸é‡ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šäº†ï¼Œèµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ  
  å¦‚æœ static å˜é‡æ˜¯ final çš„ï¼Œä½†å±äºå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

**è§£æï¼š**å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨

    package com.exp.test03;
    import java.io.IOException;
    /**
     * è§£æçš„å«ä¹‰
     */
    public class Load_01 {
    
        public static void main(String[] args) throws ClassNotFoundException,
                IOException {
            ClassLoader classloader = Load_01.class.getClassLoader();
            // loadClass æ–¹æ³•ä¸ä¼šå¯¼è‡´ç±»çš„è§£æå’Œåˆå§‹åŒ–
            Class<?> c = classloader.loadClass("com.exp.test03.C");
            // new C();
            System.in.read();
        }
    }
    
    class C {
        D d = new D();
    }
    
    class D {
    }

#### 3.4.3 åˆå§‹åŒ–

**()V æ–¹æ³•**

* åˆå§‹åŒ–å³è°ƒç”¨ ()V ï¼Œè™šæ‹Ÿæœºä¼šä¿è¯è¿™ä¸ªç±»çš„ã€æ„é€ æ–¹æ³•ã€çš„çº¿ç¨‹å®‰å…¨

**å‘ç”Ÿçš„æ—¶æœº**

* æ¦‚æ‹¬å¾—è¯´ï¼Œç±»åˆå§‹åŒ–æ˜¯ã€æ‡’æƒ°çš„ã€‘

    * main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œæ€»ä¼šè¢«é¦–å…ˆåˆå§‹åŒ–
    * é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶
    * å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘
    * å­ç±»è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–
    * Class.forName
    * new ä¼šå¯¼è‡´åˆå§‹åŒ–
* ä¸ä¼šå¯¼è‡´ç±»åˆå§‹åŒ–çš„æƒ…å†µ

    * è®¿é—®ç±»çš„ static final é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    * ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    * åˆ›å»ºè¯¥ç±»çš„æ•°ç»„ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    * ç±»åŠ è½½å™¨çš„loadClassæ–¹æ³•
    * Class.forNameçš„å‚æ•°2ä¸ºfalseæ—¶
* å®éªŒ

      class A {
  	static int a = 0;
  	static {
  		System.out.println("a init");
  	}
  }
  class B extends A {
  final static double b = 5.0;
  static boolean c = false;
  static {
  System.out.println("b init");
  }
  }

éªŒè¯ï¼ˆå®éªŒæ—¶è¯·å…ˆå…¨éƒ¨æ³¨é‡Šï¼Œæ¯æ¬¡åªæ‰§è¡Œå…¶ä¸­ä¸€ä¸ªï¼‰

        public class Load3 {
    	static {
    		System.out.println("main init");
    	}
    	public static void main(String[] args) throws ClassNotFoundException {
    		// 1. é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    		System.out.println(B.b);
    		// 2. ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    		System.out.println(B.class);
    		// 3. åˆ›å»ºè¯¥ç±»çš„æ•°ç»„ä¸ä¼šè§¦å‘åˆå§‹åŒ–
    		System.out.println(new B[0]);
    		// 4. ä¸ä¼šåˆå§‹åŒ–ç±» Bï¼Œä½†ä¼šåŠ è½½ Bã€A
    		ClassLoader cl = Thread.currentThread().getContextClassLoader();
    		cl.loadClass("cn.itcast.jvm.t3.B");
    		// 5. ä¸ä¼šåˆå§‹åŒ–ç±» Bï¼Œä½†ä¼šåŠ è½½ Bã€A
    		ClassLoader c2 = Thread.currentThread().getContextClassLoader();
    		Class.forName("cn.itcast.jvm.t3.B", false, c2);
    		// 1. é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶
    		System.out.println(A.a);
    		// 2. å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘
    		System.out.println(B.c);
    		// 3. å­ç±»è®¿é—®çˆ¶ç±»é™æ€å˜é‡ï¼Œåªè§¦å‘çˆ¶ç±»åˆå§‹åŒ–
    		System.out.println(B.a);
    		// 4. ä¼šåˆå§‹åŒ–ç±» Bï¼Œå¹¶å…ˆåˆå§‹åŒ–ç±» A
    		Class.forName("cn.itcast.jvm.t3.B");
    	}
    }

#### 3.4.4 ç»ƒä¹ 

ä»å­—èŠ‚ç åˆ†æï¼Œä½¿ç”¨ aï¼Œbï¼Œc è¿™ä¸‰ä¸ªå¸¸é‡æ˜¯å¦ä¼šå¯¼è‡´ E åˆå§‹åŒ–ï¼š

    public class Load_02 {
        public static void main(String[] args) {
            // static final çš„åŸºæœ¬ç±»å‹ï¼Œä»¥åŠå­—ç¬¦ä¸²å¸¸é‡ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šï¼Œèµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ,æ‰€ä»¥ä¸ä¼šåˆå§‹åŒ–
            System.out.println(E.a); 
            System.out.println(E.b);
            //static final çš„å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆï¼Œå¯¼è‡´Eåˆå§‹åŒ–
            System.out.println(E.c);
        }
    }
    
    class E {
        public static final int a = 10;
        public static final String b = "hello";
        public static final Integer c = 20;
    }

å…¸å‹åº”ç”¨ - å®Œæˆæ‡’æƒ°åˆå§‹åŒ–å•ä¾‹æ¨¡å¼

    public final class Singleton {
    	private Singleton() { }
    	// å†…éƒ¨ç±»ä¸­ä¿å­˜å•ä¾‹
    	private static class LazyHolder {
    		static final Singleton INSTANCE = new Singleton();
    	}
    	// ç¬¬ä¸€æ¬¡è°ƒç”¨ getInstance æ–¹æ³•ï¼Œæ‰ä¼šå¯¼è‡´å†…éƒ¨ç±»åŠ è½½å’Œåˆå§‹åŒ–å…¶é™æ€æˆå‘˜
    	public static Singleton getInstance() {
    		return LazyHolder.INSTANCE;
    	}
    }

ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š

* æ‡’æƒ°å®ä¾‹åŒ–
* åˆå§‹åŒ–æ—¶çš„çº¿ç¨‹å®‰å…¨æ˜¯æœ‰ä¿éšœçš„

### 3.5 ç±»åŠ è½½å™¨

> ä»¥ JDK 8 ä¸ºä¾‹ï¼š
>
> **åç§°**|  **åŠ è½½å“ªçš„ç±»**|  **è¯´æ˜**  
> ---|---|---  
> Bootstrap ClassLoader| JAVA_HOME/jre/lib| æ— æ³•ç›´æ¥è®¿é—®  
> Extension ClassLoader| JAVA_HOME/jre/lib/ext| ä¸Šçº§ä¸º Bootstrapï¼Œæ˜¾ç¤ºä¸º null  
> Application ClassLoader| classpath| ä¸Šçº§ä¸º Extension  
> è‡ªå®šä¹‰ç±»åŠ è½½å™¨| è‡ªå®šä¹‰| ä¸Šçº§ä¸º Application  

#### 3.5.1 å¯åŠ¨ç±»åŠ è½½å™¨

ç”¨ Bootstrap ç±»åŠ è½½å™¨åŠ è½½ç±»ï¼š

![image-20230327192925798](https://img-
blog.csdnimg.cn/img_convert/9cb7665dc051ea5d405fb7268cc0bfd2.png)

æ‰§è¡Œ:

![image-20230327192936777](https://img-
blog.csdnimg.cn/img_convert/025e948ce6bec5f0daf3b1d067dc729b.png)

è¾“å‡ºï¼š

![image-20230327193001422](https://img-
blog.csdnimg.cn/img_convert/e9bddb87a4ae2186a1bbd5b66a1d923a.png)

* -Xbootclasspath è¡¨ç¤ºè®¾ç½® bootclasspath
* å…¶ä¸­ /a:. è¡¨ç¤ºå°†å½“å‰ç›®å½•è¿½åŠ è‡³ bootclasspath ä¹‹å
* å¯ä»¥ç”¨è¿™ä¸ªåŠæ³•æ›¿æ¢æ ¸å¿ƒç±»
    * java -Xbootclasspath:
    * java -Xbootclasspath/a:<è¿½åŠ è·¯å¾„>
    * java -Xbootclasspath/p:<è¿½åŠ è·¯å¾„>

#### 3.5.2 æ‰©å±•ç±»åŠ è½½å™¨

![image-20230327193202952](https://img-
blog.csdnimg.cn/img_convert/36b6144ee56102fd5aed02a0fa3f279c.png)

æ‰§è¡Œï¼š

![image-20230327193222976](https://img-
blog.csdnimg.cn/img_convert/9354be94c0ce228a7dc84ee61d5f2e81.png)

è¾“å‡ºï¼š

![image-20230327193241968](https://img-
blog.csdnimg.cn/img_convert/ffe67487bfa89f254945ba6c4dfa1dfa.png)

å†™ä¸€ä¸ªåŒåçš„ç±»ï¼š

![image-20230327193304817](https://img-
blog.csdnimg.cn/img_convert/c3ee20cc20e6d6c9c7572b7e720cd692.png)

æ‰“ä¸ª jar åŒ…

![image-20230327193328586](https://img-
blog.csdnimg.cn/img_convert/813469cba82858c5d28cfa1598ddbe95.png)

å°† jar åŒ…æ‹·è´åˆ° JAVA_HOME/jre/lib/ext

é‡æ–°æ‰§è¡Œ Load5_2

è¾“å‡º

![image-20230327193355581](https://img-
blog.csdnimg.cn/img_convert/4d8690455f01751e4b27c4b4205b1df8.png)

#### 3.5.3 åŒäº²å§”æ´¾æ¨¡å¼

æ‰€è°“çš„åŒäº²å§”æ´¾ï¼Œå°±æ˜¯æŒ‡è°ƒç”¨ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•æ—¶ï¼ŒæŸ¥æ‰¾ç±»çš„è§„åˆ™

> æ³¨æ„ï¼šè¿™é‡Œçš„åŒäº²ï¼Œç¿»è¯‘ä¸ºä¸Šçº§ä¼¼ä¹æ›´ä¸ºåˆé€‚ï¼Œå› ä¸ºä»–ä»¬æ²¡æœ‰ç›´æ¥çš„ç»§æ‰¿å…³ç³»

    protected Class<?> loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
        synchronized (getClassLoadingLock(name)) {
            //  1. æ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                long t0 = System.nanoTime();
                try {
                    if (parent != null) {
                        // 2. æœ‰ä¸Šçº§çš„è¯ï¼Œå§”æ´¾ä¸Šçº§ loadClass
                        c = parent.loadClass(name, false);
                    } else {
                        //å¦‚æœæ²¡æœ‰ä¸Šçº§äº†ï¼ˆExtClassLoaderï¼‰ï¼Œåˆ™å§”æ´¾BootstrapClassLoader
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {
                    // ClassNotFoundException thrown if class not found
                    // from the non-null parent class loader
                }
    
                if (c == null) {
                    // 4. æ¯ä¸€å±‚æ‰¾ä¸åˆ°ï¼Œè°ƒç”¨ findClass æ–¹æ³•ï¼ˆæ¯ä¸ªç±»åŠ è½½å™¨è‡ªå·±æ‰©å±•ï¼‰æ¥åŠ è½½
                    long t1 = System.nanoTime();
                    c = findClass(name);
    
                    // è®°å½•è€—æ—¶
                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    sun.misc.PerfCounter.getFindClasses().increment();
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }

ä¾‹å¦‚ï¼š

![image-20230327203838949](https://img-
blog.csdnimg.cn/img_convert/8847991a30d5248c39c72116c653741a.png)

1. sun.misc.Launcher$AppClassLoader //1 å¤„ï¼Œ å¼€å§‹æŸ¥çœ‹å·²åŠ è½½çš„ç±»ï¼Œç»“æœæ²¡æœ‰
2. sun.misc.Launcher A p p C l a s s L o a d e r / / 2 å¤„ï¼Œå§”æ´¾ä¸Šçº§ s u n . m i s c . L a u n c h e r AppClassLoader // 2
   å¤„ï¼Œå§”æ´¾ä¸Šçº§sun.misc.Launcher AppClassLoader//2å¤„ï¼Œå§”æ´¾ä¸Šçº§sun.misc.LauncherExtClassLoader.loadClass()
3. sun.misc.Launcher$ExtClassLoader // 1 å¤„ï¼ŒæŸ¥çœ‹å·²åŠ è½½çš„ç±»ï¼Œç»“æœæ²¡æœ‰
4. BootstrapClassLoader æ˜¯åœ¨ JAVA_HOME/jre/lib ä¸‹æ‰¾ H è¿™ä¸ªç±»ï¼Œæ˜¾ç„¶æ²¡
5. sun.misc.Launcher E x t C l a s s L o a d e r / / 4 å¤„ï¼Œè°ƒç”¨è‡ªå·±çš„ f i n d C l a s s æ–¹æ³•ï¼Œæ˜¯åœ¨ J A V A H O M E / j r
   e / l i b / e x t ä¸‹æ‰¾ H è¿™ä¸ªç±»ï¼Œæ˜¾ç„¶æ²¡æœ‰ï¼Œå›åˆ° s u n . m i s c . L a u n c h e r ExtClassLoader // 4 å¤„ï¼Œè°ƒç”¨è‡ªå·±çš„
   findClass æ–¹æ³•ï¼Œæ˜¯åœ¨JAVA_HOME/jre/lib/ext ä¸‹æ‰¾ H è¿™ä¸ªç±»ï¼Œæ˜¾ç„¶æ²¡ æœ‰ï¼Œå›åˆ° sun.misc.Launcher
   ExtClassLoader//4å¤„ï¼Œè°ƒç”¨è‡ªå·±çš„findClassæ–¹æ³•ï¼Œæ˜¯åœ¨JAVAHâ€‹OME/jre/lib/extä¸‹æ‰¾Hè¿™ä¸ªç±»ï¼Œæ˜¾ç„¶æ²¡æœ‰ï¼Œå›åˆ°sun.misc.LauncherAppClassLoaderçš„ //
   2 å¤„
6. ç»§ç»­æ‰§è¡Œåˆ° sun.misc.Launcher$AppClassLoader // 4 å¤„ï¼Œè°ƒç”¨å®ƒè‡ªå·±çš„ findClass æ–¹æ³•ï¼Œåœ¨ classpath ä¸‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†

![image-20230327205344294](https://img-
blog.csdnimg.cn/img_convert/816ff0ef3cecc918678534be6f5c0b9d.png)

#### 3.5.4 çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

æˆ‘ä»¬åœ¨ä½¿ç”¨ JDBC æ—¶ï¼Œéƒ½éœ€è¦åŠ è½½ Driver é©±åŠ¨ï¼Œä¸çŸ¥é“ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œä¸å†™

`Class.forName("com.mysql.jdbc.Driver")`

ä¹Ÿæ˜¯å¯ä»¥è®© com.mysql.jdbc.Driver æ­£ç¡®åŠ è½½çš„ï¼Œä½ çŸ¥é“æ˜¯æ€ä¹ˆåšçš„å—ï¼Ÿ

è®©æˆ‘ä»¬è¿½è¸ªä¸€ä¸‹æºç ï¼š

    public class DriverManager {
    	// æ³¨å†Œé©±åŠ¨çš„é›†åˆ
    	private final static CopyOnWriteArrayList<DriverInfo> registeredDrivers
    		= new CopyOnWriteArrayList<>();
    	// åˆå§‹åŒ–é©±åŠ¨
    	static {
    		loadInitialDrivers();
    		println("JDBC DriverManager initialized");
    	}

å…ˆä¸çœ‹åˆ«çš„ï¼Œçœ‹çœ‹ DriverManager çš„ç±»åŠ è½½å™¨ï¼š

`System.out.println(DriverManager.class.getClassLoader());`

æ‰“å° nullï¼Œè¡¨ç¤ºå®ƒçš„ç±»åŠ è½½å™¨æ˜¯ Bootstrap ClassLoaderï¼Œä¼šåˆ° JAVA_HOME/jre/lib
ä¸‹æœç´¢ç±»ï¼Œä½†JAVA_HOME/jre/lib ä¸‹æ˜¾ç„¶æ²¡æœ‰ mysql-connector-java-5.1.47.jar
åŒ…ï¼Œè¿™æ ·é—®é¢˜æ¥äº†ï¼Œåœ¨DriverManager çš„é™æ€ä»£ç å—ä¸­ï¼Œæ€ä¹ˆèƒ½æ­£ç¡®åŠ è½½com.mysql.jdbc.Driver å‘¢ï¼Ÿ

ç»§ç»­çœ‹ loadInitialDrivers() æ–¹æ³•ï¼š

    private static void loadInitialDrivers() {
        String drivers;
        try {
            drivers = AccessController.doPrivileged(new PrivilegedAction<String>() {
                public String run() {
                    return System.getProperty("jdbc.drivers");
                }
            });
        } catch (Exception ex) {
            drivers = null;
        }
        //  1ï¼‰ä½¿ç”¨ ServiceLoader æœºåˆ¶åŠ è½½é©±åŠ¨ï¼Œå³SPI
        AccessController.doPrivileged(new PrivilegedAction<Void>() {
            public Void run() {
                ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator<Driver> driversIterator = loadedDrivers.iterator();
                try{
                    while(driversIterator.hasNext()) {
                        driversIterator.next();
                    }
                } catch(Throwable t) {
                // Do nothing
                }
                return null;
            }
        });
    
        println("DriverManager.initialize: jdbc.drivers = " + drivers);
       //2ï¼‰ä½¿ç”¨ jdbc.drivers å®šä¹‰çš„é©±åŠ¨ååŠ è½½é©±åŠ¨
        if (drivers == null || drivers.equals("")) {
            return;
        }
        String[] driversList = drivers.split(":");
        println("number of Drivers:" + driversList.length);
        for (String aDriver : driversList) {
            try {
                println("DriverManager.Initialize: loading " + aDriver);
                // è¿™é‡Œçš„ ClassLoader.getSystemClassLoader() å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨
                Class.forName(aDriver, true,
                        ClassLoader.getSystemClassLoader());
            } catch (Exception ex) {
                println("DriverManager.Initialize: load failed: " + ex);
            }
        }
    }

å…ˆçœ‹ 2ï¼‰å‘ç°å®ƒæœ€åæ˜¯ä½¿ç”¨ Class.forName å®Œæˆç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼Œå…³è”çš„æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå› æ­¤  
å¯ä»¥é¡ºåˆ©å®Œæˆç±»åŠ è½½  
å†çœ‹ 1ï¼‰å®ƒå°±æ˜¯å¤§åé¼é¼çš„ Service Provider Interface ï¼ˆSPIï¼‰  
çº¦å®šå¦‚ä¸‹ï¼Œåœ¨ jar åŒ…çš„ META-INF/services åŒ…ä¸‹ï¼Œä»¥æ¥å£å…¨é™å®šååä¸ºæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å®ç°ç±»åç§°

![image-20230327210701474](https://img-
blog.csdnimg.cn/img_convert/8c8dd238bbab7ee3e671ebe0667b7628.png)

è¿™æ ·å°±å¯ä»¥ä½¿ç”¨

![image-20230327210803395](https://img-
blog.csdnimg.cn/img_convert/ff71a6f7313e9484f5c4c205f7774f6d.png)

æ¥å¾—åˆ°å®ç°ç±»ï¼Œä½“ç°çš„æ˜¯ã€é¢å‘æ¥å£ç¼–ç¨‹+è§£è€¦ã€‘çš„æ€æƒ³ï¼Œåœ¨ä¸‹é¢ä¸€äº›æ¡†æ¶ä¸­éƒ½è¿ç”¨äº†æ­¤æ€æƒ³ï¼š

* JDBC
* Servlet åˆå§‹åŒ–å™¨
* Spring å®¹å™¨
* Dubboï¼ˆå¯¹ SPI è¿›è¡Œäº†æ‰©å±•ï¼‰

æ¥ç€çœ‹ ServiceLoader.load æ–¹æ³•ï¼š

![image-20230327210921875](https://img-
blog.csdnimg.cn/img_convert/2f4ea434fc5358e76adcc1a581697e9d.png)

çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯å½“å‰çº¿ç¨‹ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼Œé»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå®ƒå†…éƒ¨åˆæ˜¯ç”±Class.forName è°ƒç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®Œæˆç±»åŠ è½½ï¼Œå…·ä½“ä»£ç åœ¨
ServiceLoader çš„å†…éƒ¨ç±»LazyIterator ä¸­ï¼š

    private S nextService() {
        if (!hasNextService())
            throw new NoSuchElementException();
        String cn = nextName;
        nextName = null;
        Class<?> c = null;
        try {
            c = Class.forName(cn, false, loader);
        } catch (ClassNotFoundException x) {
            fail(service,
                 "Provider " + cn + " not found");
        }
        if (!service.isAssignableFrom(c)) {
            fail(service,
                 "Provider " + cn  + " not a subtype");
        }
        try {
            S p = service.cast(c.newInstance());
            providers.put(cn, p);
            return p;
        } catch (Throwable x) {
            fail(service,
                 "Provider " + cn + " could not be instantiated",
                 x);
        }
        throw new Error();          // This cannot happen
    }

#### 3.5.5 è‡ªå®šä¹‰ç±»åŠ è½½å™¨

é—®é—®è‡ªå·±ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨  
1ï¼‰æƒ³åŠ è½½é classpath éšæ„è·¯å¾„ä¸­çš„ç±»æ–‡ä»¶  
2ï¼‰éƒ½æ˜¯é€šè¿‡æ¥å£æ¥ä½¿ç”¨å®ç°ï¼Œå¸Œæœ›è§£è€¦æ—¶ï¼Œå¸¸ç”¨åœ¨æ¡†æ¶è®¾è®¡  
3ï¼‰è¿™äº›ç±»å¸Œæœ›äºˆä»¥éš”ç¦»ï¼Œä¸åŒåº”ç”¨çš„åŒåç±»éƒ½å¯ä»¥åŠ è½½ï¼Œä¸å†²çªï¼Œå¸¸è§äº tomcat å®¹å™¨  
æ­¥éª¤ï¼š

1. ç»§æ‰¿ ClassLoader çˆ¶ç±»
2. è¦éµä»åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‡å†™ findClass æ–¹æ³•
   * æ³¨æ„ä¸æ˜¯é‡å†™ loadClass æ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šèµ°åŒäº²å§”æ´¾æœºåˆ¶
3. è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
4. è°ƒç”¨çˆ¶ç±»çš„ defineClass æ–¹æ³•æ¥åŠ è½½ç±»
5. ä½¿ç”¨è€…è°ƒç”¨è¯¥ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•

ç¤ºä¾‹ï¼š

* å‡†å¤‡å¥½ä¸¤ä¸ªç±»æ–‡ä»¶æ”¾å…¥ E:\myclasspathï¼Œå®ƒå®ç°äº† java.util.Map æ¥å£ï¼Œå¯ä»¥å…ˆåç¼–è¯‘çœ‹ä¸€ä¸‹ï¼š

![image-20230327211855052](https://img-
blog.csdnimg.cn/img_convert/a07a643009911dbeb768c57b822d92e9.png)

![image-20230327212059396](https://img-
blog.csdnimg.cn/img_convert/9ef69d9d1c5170b7e3727d4598201fa6.png)

    public class Load7 {
        public static void main(String[] args) throws Exception {
            MyClassLoader classLoader = new MyClassLoader();
            Class<?> c1 = classLoader.loadClass("MapImpl1");
            Class<?> c2 = classLoader.loadClass("MapImpl1");
            System.out.println(c1 == c2);
    
            MyClassLoader classLoader2 = new MyClassLoader();
            Class<?> c3 = classLoader2.loadClass("MapImpl1");
            System.out.println(c1 == c3);
    
            c1.newInstance();
        }
    }
    
    class MyClassLoader extends ClassLoader {
    
        @Override // name å°±æ˜¯ç±»åç§°
        protected Class<?> findClass(String name) throws ClassNotFoundException {
            String path = "e:\\myclasspath\\" + name + ".class";
    
            try {
                ByteArrayOutputStream os = new ByteArrayOutputStream();
                Files.copy(Paths.get(path), os);
    
                // å¾—åˆ°å­—èŠ‚æ•°ç»„
                byte[] bytes = os.toByteArray();
    
                // byte[] -> *.class
                return defineClass(name, bytes, 0, bytes.length);
    
            } catch (IOException e) {
                e.printStackTrace();
                throw new ClassNotFoundException("ç±»æ–‡ä»¶æœªæ‰¾åˆ°", e);
            }
        }
    }

### 3.6 è¿è¡ŒæœŸä¼˜åŒ–

#### 3.6.1 å³æ—¶ç¼–è¯‘

**åˆ†å±‚ç¼–è¯‘ï¼ˆTieredCompilationï¼‰**

å…ˆæ¥ä¸ªä¾‹å­:

    public class JIT1 {
        public static void main(String[] args) {
            for (int i = 0; i < 200; i++) {
                long start = System.nanoTime();
                for (int j = 0; j < 1000; j++) {
                    new Object();
                }
                long end = System.nanoTime();
                System.out.printf("%d\t%d\n",i,(end - start));
            }
        }
    }
    
    
    
    0	41900
    1	159700
    2	43200
    .........
    195	400
    196	400
    197	400
    198	400
    199	300

åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

JVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

* 0 å±‚ï¼Œè§£é‡Šæ‰§è¡Œï¼ˆInterpreterï¼‰
* 1 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ profifilingï¼‰
* 2 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„ profifilingï¼‰
* 3 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„ profifilingï¼‰
* 4 å±‚ï¼Œä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œ

> profiling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚ã€æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€‘ï¼Œã€å¾ªç¯çš„  
> å›è¾¹æ¬¡æ•°ã€‘ç­‰

å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¸è§£é‡Šå™¨çš„åŒºåˆ«:

* è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºæœºå™¨ç ï¼Œä¸‹æ¬¡å³ä½¿é‡åˆ°ç›¸åŒçš„å­—èŠ‚ç ï¼Œä»ä¼šæ‰§è¡Œé‡å¤çš„è§£é‡Š
* JIT æ˜¯å°†ä¸€äº›å­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œå¹¶å­˜å…¥ Code Cacheï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€å†ç¼–è¯‘
* è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºé’ˆå¯¹æ‰€æœ‰å¹³å°éƒ½é€šç”¨çš„æœºå™¨ç 
* JIT ä¼šæ ¹æ®å¹³å°ç±»å‹ï¼Œç”Ÿæˆå¹³å°ç‰¹å®šçš„æœºå™¨ç 

å¯¹äºå æ®å¤§éƒ¨åˆ†çš„ä¸å¸¸ç”¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ— éœ€è€—è´¹æ—¶é—´å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯é‡‡å–è§£é‡Šæ‰§è¡Œçš„æ–¹å¼è¿è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹äºä»…å æ®å°éƒ¨åˆ†çš„çƒ­ç‚¹ä»£ç ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»¥è¾¾åˆ°ç†æƒ³çš„è¿è¡Œé€Ÿåº¦ã€‚
æ‰§è¡Œæ•ˆç‡ä¸Šç®€å•æ¯”è¾ƒä¸€ä¸‹ Interpreter < C1 < C2ï¼Œæ€»çš„ç›®æ ‡æ˜¯å‘ç°çƒ­ç‚¹ä»£ç ï¼ˆhotspotåç§°çš„ç”±æ¥ï¼‰ï¼Œä¼˜åŒ–ä¹‹

åˆšæ‰çš„ä¸€ç§ä¼˜åŒ–æ‰‹æ®µç§°ä¹‹ä¸ºã€é€ƒé€¸åˆ†æã€‘ï¼Œå‘ç°æ–°å»ºçš„å¯¹è±¡æ˜¯å¦é€ƒé€¸ã€‚å¯ä»¥ä½¿ç”¨ -XX:-DoEscapeAnalysis å…³é—­é€ƒé€¸åˆ†æï¼Œå†è¿è¡Œåˆšæ‰çš„ç¤ºä¾‹è§‚å¯Ÿç»“æœ

å‚è€ƒèµ„æ–™ï¼šhttps://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-
machineperformance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4

**æ–¹æ³•å†…è” ï¼ˆInliningï¼‰**

![image-20230327214550574](https://img-
blog.csdnimg.cn/img_convert/d7891a88fa2d57694a78cf9faa34b6ac.png)

å¦‚æœå‘ç° square æ˜¯çƒ­ç‚¹æ–¹æ³•ï¼Œå¹¶ä¸”é•¿åº¦ä¸å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡Œå†…è”ï¼Œæ‰€è°“çš„å†…è”å°±æ˜¯æŠŠæ–¹æ³•å†…ä»£ç æ‹·è´ã€ç²˜è´´åˆ°è°ƒç”¨è€…çš„ä½ç½®ï¼š

![image-20230327214711679](https://img-
blog.csdnimg.cn/img_convert/d05c96aad9edbc643a53f47ecf7d3bd9.png)

è¿˜èƒ½å¤Ÿè¿›è¡Œå¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰çš„ä¼˜åŒ–

`System.out.println(81);`

å®éªŒï¼š

![image-20230327214933949](https://img-
blog.csdnimg.cn/img_convert/c430760805ce213b61ac61203d5d6ce7.png)

**å­—æ®µä¼˜åŒ–**

JMH åŸºå‡†æµ‹è¯•è¯·å‚è€ƒï¼šhttp://openjdk.java.net/projects/code-tools/jmh/

åˆ›å»º maven å·¥ç¨‹ï¼Œæ·»åŠ ä¾èµ–å¦‚ä¸‹:

![image-20230327215541348](https://img-
blog.csdnimg.cn/img_convert/a8f27313d00a421777b0bfb59266df47.png)

ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç ï¼š

    @Warmup(iterations = 2, time = 1)
    @Measurement(iterations = 5, time = 1)
    @State(Scope.Benchmark)
    public class Benchmark1 {
    	int[] elements = randomInts(1_000);
    	private static int[] randomInts(int size) {
    		Random random = ThreadLocalRandom.current();
    		int[] values = new int[size];
    		for (int i = 0; i < size; i++) {
    			values[i] = random.nextInt();
    		}
    		return values;
    	}
    	@Benchmark
    	public void test1() {
    		for (int i = 0; i < elements.length; i++) {
    			doSum(elements[i]);
    		}
    	}
    	@Benchmark
    	public void test2() {
    		int[] local = this.elements;
    		for (int i = 0; i < local.length; i++) {
    			doSum(local[i]);
    		}
    	}
    	@Benchmark
    	public void test3() {
    		for (int element : elements) {
    			doSum(element);
    		}
    	}
    	static int sum = 0;
    	@CompilerControl(CompilerControl.Mode.INLINE)
    	static void doSum(int x) {
    		sum += x;
    	}
    	public static void main(String[] args) throws RunnerException {
    		Options opt = new OptionsBuilder()
                			.include(Benchmark1.class.getSimpleName())
                			.forks(1)
                			.build();
    		new Runner(opt).run();
        }
    }

é¦–å…ˆå¯ç”¨ doSum çš„æ–¹æ³•å†…è”ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼ˆæ¯ç§’ååé‡ï¼Œåˆ†æ•°è¶Šé«˜çš„æ›´å¥½ï¼‰ï¼š

![image-20230327220218664](https://img-
blog.csdnimg.cn/img_convert/87c80eb7613bd2cfc63fc1faaf9e3472.png)

æ¥ä¸‹æ¥ç¦ç”¨ doSum æ–¹æ³•å†…è”

![image-20230327220347450](https://img-
blog.csdnimg.cn/img_convert/2daa988b92b08910c31cf939acf6a23c.png)

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

![image-20230327220411931](https://img-
blog.csdnimg.cn/img_convert/780c9b7cbdcb930b2a1e83da98a5ceac.png)

åˆ†æï¼š  
åœ¨åˆšæ‰çš„ç¤ºä¾‹ä¸­ï¼ŒdoSum æ–¹æ³•æ˜¯å¦å†…è”ä¼šå½±å“ elements æˆå‘˜å˜é‡è¯»å–çš„ä¼˜åŒ–ï¼š  
å¦‚æœ doSum æ–¹æ³•å†…è”äº†ï¼Œåˆšæ‰çš„ test1 æ–¹æ³•ä¼šè¢«ä¼˜åŒ–æˆä¸‹é¢çš„æ ·å­ï¼ˆä¼ªä»£ç ï¼‰ï¼š

![image-20230327220527299](https://img-
blog.csdnimg.cn/img_convert/b0dff044678769230c0cd7793d736614.png)

å¯ä»¥èŠ‚çœ 1999 æ¬¡ Field è¯»å–æ“ä½œ  
ä½†å¦‚æœ doSum æ–¹æ³•æ²¡æœ‰å†…è”ï¼Œåˆ™ä¸ä¼šè¿›è¡Œä¸Šé¢çš„ä¼˜åŒ–

#### 3.6.2 åå°„ä¼˜åŒ–

    public class Reflect1 {
        public static void foo() {
            System.out.println("foo...");
        }
    
        public static void main(String[] args) throws Exception {
            Method foo = Reflect1.class.getMethod("foo");
            for (int i = 0; i <= 16; i++) {
                System.out.printf("%d\t", i);
                foo.invoke(null);
            }
            System.in.read();
        }
    }

foo.invoke å‰é¢ 0 ~ 15 æ¬¡è°ƒç”¨ä½¿ç”¨çš„æ˜¯ MethodAccessor çš„ NativeMethodAccessorImpl å®ç°:

    class NativeMethodAccessorImpl extends MethodAccessorImpl {
        private final Method method;
        private DelegatingMethodAccessorImpl parent;
        private int numInvocations;//è®°å½•è°ƒç”¨æ¬¡æ•°
        NativeMethodAccessorImpl(Method var1) {
            this.method = var1;
        }
        public Object invoke(Object var1, Object[] var2) throws IllegalArgumentException, InvocationTargetException {
            //è¶…è¿‡15=ReflectionFactory.inflationThreshold()æ—¶è¿›å…¥ifè¯­å¥
            if (++this.numInvocations > ReflectionFactory.inflationThreshold() && !ReflectUtil.isVMAnonymousClass(this.method.getDeclaringClass())) {
                MethodAccessorImpl var3 = (MethodAccessorImpl)(new MethodAccessorGenerator()).generateMethod(this.method.getDeclaringClass(), this.method.getName(), this.method.getParameterTypes(), this.method.getReturnType(), this.method.getExceptionTypes(), this.method.getModifiers());
                this.parent.setDelegate(var3);
            }
            return invoke0(this.method, var1, var2);
        }
        void setParent(DelegatingMethodAccessorImpl var1) {
            this.parent = var1;
        }
        private static native Object invoke0(Method var0, Object var1, Object[] var2);
    }

å½“è°ƒç”¨åˆ°ç¬¬ 16 æ¬¡ï¼ˆä»0å¼€å§‹ç®—ï¼‰æ—¶ï¼Œä¼šé‡‡ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»ä»£æ›¿æ‰æœ€åˆçš„å®ç°ï¼Œå¯ä»¥é€šè¿‡ debug å¾—åˆ°  
ç±»åä¸º sun.reflect.GeneratedMethodAccessor1

å¯ä»¥ä½¿ç”¨é˜¿é‡Œçš„ arthas å·¥å…·ï¼š

![image-20230327231358569](https://img-
blog.csdnimg.cn/img_convert/3305d3bc852949a43b735c0ce22f92b8.png)

å†è¾“å…¥ã€jad + ç±»åã€‘æ¥è¿›è¡Œåç¼–è¯‘

    [arthas@7508]$ jad sun.reflect.GeneratedMethodAccessor1
    ClassLoader:
    +-sun.reflect.DelegatingClassLoader@7ea987ac
      +-sun.misc.Launcher$AppClassLoader@18b4aac2
        +-sun.misc.Launcher$ExtClassLoader@7f31245a
    Location:
    /*
     * Decompiled with CFR.
     *
     * Could not load the following classes:
     *  com.exp.test03.Reflect1
     */
    package sun.reflect;
    
    import com.exp.test03.Reflect1;
    import java.lang.reflect.InvocationTargetException;
    import sun.reflect.MethodAccessorImpl;
    
    public class GeneratedMethodAccessor1
    extends MethodAccessorImpl {
        /*
         * Loose catch block
         */
        public Object invoke(Object object, Object[] objectArray) throws InvocationTargetException {
            // æ¯”è¾ƒå¥‡è‘©çš„åšæ³•ï¼Œå¦‚æœæœ‰å‚æ•°ï¼Œé‚£ä¹ˆæŠ›éæ³•å‚æ•°å¼‚å¸¸
            block4: {
                if (objectArray == null || objectArray.length == 0) break block4;
                throw new IllegalArgumentException();
            }
            try {
                // å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æ˜¯ç›´æ¥è°ƒç”¨äº†
                Reflect1.foo();
                // å› ä¸ºæ²¡æœ‰è¿”å›å€¼
                return null;
            }
            catch (Throwable throwable) {
                throw new InvocationTargetException(throwable);
            }
            catch (ClassCastException | NullPointerException runtimeException) {
                throw new IllegalArgumentException(super.toString());
            }
        }
    }

> æ³¨æ„  
> é€šè¿‡æŸ¥çœ‹ ReflectionFactory æºç å¯
>
>   * sun.reflect.noInflation å¯ä»¥ç”¨æ¥ç¦ç”¨è†¨èƒ€ï¼ˆç›´æ¥ç”Ÿæˆ GeneratedMethodAccessor1ï¼Œä½†é¦–  
      > æ¬¡ç”Ÿæˆæ¯”è¾ƒè€—æ—¶ï¼Œå¦‚æœä»…åå°„è°ƒç”¨ä¸€æ¬¡ï¼Œä¸åˆ’ç®—ï¼‰
>   * sun.reflect.inflationThreshold å¯ä»¥ä¿®æ”¹è†¨èƒ€é˜ˆå€¼
>

## 4.å†…å­˜æ¨¡å‹

### 4.1 **java** å†…å­˜æ¨¡å‹

* å¾ˆå¤šäººå°†ã€java å†…å­˜ç»“æ„ã€‘ä¸ã€java å†…å­˜æ¨¡å‹ã€‘å‚»å‚»åˆ†ä¸æ¸…ï¼Œã€java å†…å­˜æ¨¡å‹ã€‘æ˜¯ Java MemoryModelï¼ˆJMMï¼‰çš„æ„æ€ã€‚
* ç®€å•çš„è¯´ï¼ŒJMM å®šä¹‰äº†ä¸€å¥—åœ¨å¤šçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ—¶ï¼ˆæˆå‘˜å˜é‡ã€æ•°ç»„ï¼‰æ—¶ï¼Œå¯¹æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸå­æ€§çš„è§„åˆ™å’Œä¿éšœ

#### 4.1.1 åŸå­æ€§

* **åŸå­æ€§çš„æ“ä½œæ˜¯ä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œã€‚**
* ä¸ªäººç†è§£ï¼Œä¸¥æ ¼çš„åŸå­æ€§çš„æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹è·å–æ“ä½œçš„å˜é‡æ—¶ï¼Œåªèƒ½è·å–æ“ä½œå‰çš„å˜é‡å€¼å’Œæ“ä½œåçš„å˜é‡å€¼ï¼Œä¸èƒ½è·å–åˆ°æ“ä½œè¿‡ç¨‹ä¸­çš„ä¸­é—´å€¼ï¼Œåœ¨æ“ä½œè¿‡ç¨‹ä¸­å…¶ä»–æ“ä½œéœ€è¦è·å–å˜é‡å€¼ï¼Œéœ€è¦è¿›å…¥é˜»å¡çŠ¶æ€ç­‰å¾…æ“ä½œç»“æŸã€‚
* é—®é¢˜æå‡º:ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ

#### 4.1.2 é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œã€‚  
ä¾‹å¦‚å¯¹äº i++ è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

![image-20230327233314192](https://img-
blog.csdnimg.cn/img_convert/57547421b1b395b5e63e58b0b6018edf.png)

è€Œå¯¹åº” i-- ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

![image-20230327233354675](https://img-
blog.csdnimg.cn/img_convert/379992e3f01470dcd17bed84473f5fd9.png)

è€ŒJavaçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å†…å­˜å’Œçº¿ç¨‹å†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š

![image-20230327233634479](https://img-
blog.csdnimg.cn/img_convert/3cdc1b391f1e1dc62bcaa7e7143cfec6.png)

å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

![image-20230327233710432](https://img-
blog.csdnimg.cn/img_convert/8904d378a8cb51820428605e88cee749.png)

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œï¼ˆä¸ºä»€ä¹ˆä¼šäº¤é”™ï¼Ÿæ€è€ƒä¸€ä¸‹ï¼‰ï¼š

å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

![image-20230327233747417](https://img-
blog.csdnimg.cn/img_convert/548316999c05fb72797738b673c1aa98.png)

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

![image-20230327233812792](https://img-
blog.csdnimg.cn/img_convert/fc842e977f5668117b71987f3ab1d226.png)

#### 4.1.3 è§£å†³æ–¹æ³•

**synchronized(åŒæ­¥å…³é”®å­—)**

åŒæ­¥ä»£ç å—è¯­æ³•

    synchronized( å¯¹è±¡ ) {
    	è¦ä½œä¸ºåŸå­æ“ä½œä»£ç 
    }

ç”¨ synchronized è§£å†³å¹¶å‘é—®é¢˜ï¼š

![image-20230327234445600](https://img-
blog.csdnimg.cn/img_convert/7ade7e65c41eb3e78b7613ebd95126eb.png)

* å¦‚ä½•ç†è§£å‘¢ï¼šä½ å¯ä»¥æŠŠ obj æƒ³è±¡æˆä¸€ä¸ªæˆ¿é—´ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäººã€‚
* å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(obj) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶åæ‰‹é”ä½äº†é—¨ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç ã€‚
* è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(obj) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ã€‚
* å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šè§£å¼€é—¨ä¸Šçš„é”ï¼Œä» obj æˆ¿é—´å‡ºæ¥ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œåé”ä½é—¨ï¼Œæ‰§è¡Œå®ƒçš„
  count-- ä»£ç ã€‚

> æ³¨æ„ï¼šä¸Šä¾‹ä¸­ t1 å’Œ t2 çº¿ç¨‹å¿…é¡»ç”¨ synchronized é”ä½åŒä¸€ä¸ª obj å¯¹è±¡ï¼Œå¦‚æœ t1 é”ä½çš„æ˜¯ m1 å¯¹  
> è±¡ï¼Œt2 é”ä½çš„æ˜¯ m2 å¯¹è±¡ï¼Œå°±å¥½æ¯”ä¸¤ä¸ªäººåˆ†åˆ«è¿›å…¥äº†ä¸¤ä¸ªä¸åŒçš„æˆ¿é—´ï¼Œæ²¡æ³•èµ·åˆ°åŒæ­¥çš„æ•ˆæœã€‚

### 4.2 å¯è§æ€§

#### 4.2.1 é€€ä¸å‡ºçš„å¾ªç¯

å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š

![image-20230327234748608](https://img-
blog.csdnimg.cn/img_convert/bbfe5e3da3610de418cd29e598016b92.png)

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š

1. åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚

![image-20230327234902164](https://img-
blog.csdnimg.cn/img_convert/76949336be898a4e6bfb547ae3335b3e.png)

2. å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run
   çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡

![image-20230327235046185](https://img-
blog.csdnimg.cn/img_convert/51ee0046806cf2a3828a57ad55dc2ab0.png)

3. 1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼

![image-20230327235130049](https://img-
blog.csdnimg.cn/img_convert/5b3e487828c311cba2516ee65ebfac3e.png)

#### 4.2.2 è§£å†³æ–¹æ³•

volatileï¼ˆæ˜“å˜å…³é”®å­—ï¼‰  
å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ
volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜

#### 4.2.3 å¯è§æ€§

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œ
ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µï¼š ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š

![image-20230327235410198](https://img-
blog.csdnimg.cn/img_convert/8b7114546b52693efd2b7caa4cb5e869.png)

æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£  
å†³æŒ‡ä»¤äº¤é”™

> æ³¨æ„ synchronized
> è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯synchronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½  
> å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿ  
> èƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆ

### 4.3 æœ‰åºæ€§

#### 4.3.1 è¯¡å¼‚çš„ç»“æœ

![](https://img-
blog.csdnimg.cn/img_convert/630747049e627f066bc3a2ec2db003a9.png)

I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ  
åˆ†æï¼š

* æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1
* æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1
* æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰

ç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼šçº¿ç¨‹2æ‰§è¡Œread =
true,åˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ifåˆ†æ”¯ç›¸åŠ ä¸º0ï¼Œå†åˆ‡æ¢åˆ°çº¿ç¨‹2æ‰§è¡Œnum=2ã€‚è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT
ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼šå€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress
https://wiki.openjdk.java.net/display/CodeTools/jcstress

![image-20230328105302625](https://img-
blog.csdnimg.cn/img_convert/fc224f0e3ea26f12bc6147af7992d6e0.png)

åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»

![image-20230328105349589](https://img-
blog.csdnimg.cn/img_convert/4618fc205316b5b7ea1e10747ae7f802.png)

æ‰§è¡Œ

![image-20230328105451158](https://img-
blog.csdnimg.cn/img_convert/e5d5c2278efbc31aa7cd65f8c8eeebbb.png)

ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š

![å¾®ä¿¡å›¾ç‰‡_20230328105955](https://img-
blog.csdnimg.cn/img_convert/b22002b46a20affaf2cf4be7f9f48b13.jpeg)

å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 3712æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚

#### 4.3.2 è§£å†³æ–¹æ³•

volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼š

![](https://img-
blog.csdnimg.cn/img_convert/6569d2b4107d7bb9d4bac84e34df76bd.png)

ç»“æœä¸ºï¼š

![image-20230328110542087](https://img-
blog.csdnimg.cn/img_convert/06e78f3d2d5dbdfa9d20e886cefcb821.png)

#### 4.3.3 æœ‰åºæ€§ç†è§£

åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒJVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç ï¼š

    static int i;
    static int j;
    //åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ
    i=....;//è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
    j=...;

å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯

![image-20230328111152242](https://img-
blog.csdnimg.cn/img_convert/6eabdeb382578d21b6fbbc229e895840.png)

ä¹Ÿå¯ä»¥æ˜¯:

![image-20230328111208494](https://img-
blog.csdnimg.cn/img_convert/559eac0bbf020ad088a908fdec8e17d1.png)

è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ï¼Œä¾‹å¦‚è‘—åçš„ double-checked locking æ¨¡å¼å®ç°å•ä¾‹

![image-20230328111327326](https://img-
blog.csdnimg.cn/img_convert/68dd0e5678c4e880d4cad36b8384d0a7.png)

ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š

* æ‡’æƒ°å®ä¾‹åŒ–
* é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”

ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œ INSTANCE = new Singleton() å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š

![image-20230328111855490](https://img-
blog.csdnimg.cn/img_convert/44afe5eddb8b664f6cb6b5c3e770dd2b.png)

å…¶ä¸­4ï¼Œ7ä¸¤æ­¥çš„é¡ºåºä¸æ˜¯å›ºå®šçš„ï¼Œä¹Ÿè®¸jvmä¼šä¼˜åŒ–ä¸ºï¼šå…ˆå°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™INSTANCEå˜é‡åï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹t1,t2æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š

![image-20230328112200906](https://img-
blog.csdnimg.cn/img_convert/122b60ad9b02e1a8127534fc502c89c8.png)

è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹ã€‚å¯¹
INSTANCE ä½¿ç”¨
volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰  
ä¼šçœŸæ­£æœ‰æ•ˆã€‚

#### 4.3.4 happens-before

happens-before è§„å®šäº†å“ªäº›å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM
å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§

* çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

![image-20230328112737782](https://img-
blog.csdnimg.cn/img_convert/63227da2a99b2a1e49f46cae12f02bb4.png)

* çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

![image-20230328112819301](https://img-
blog.csdnimg.cn/img_convert/8bf63bd8ec70b2190b41e4c94cbc1e4a.png)

* çº¿ç¨‹startå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„å¯è§

![image-20230328113152000](https://img-
blog.csdnimg.cn/img_convert/61d1425c5c43ab26b9c6cdaeac2ed928.png)

* çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ–t1.join()ç­‰å¾…å®ƒç»“æŸï¼‰

![image-20230328112932026](https://img-
blog.csdnimg.cn/img_convert/5681db5965953d86ad4872cc33421c19.png)

* çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡t2.interrupted æˆ–
  t2.isInterruptedï¼‰

![a89b11b5e07bd5cc9d881a4e796bc6f](https://img-
blog.csdnimg.cn/img_convert/e08e9ad5bfd9e87bd37d3effec4835a0.jpeg)

* å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

* å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ x hb-> y å¹¶ä¸” y hb-> z é‚£ä¹ˆæœ‰ x hb-> z

### 4.4 CASä¸åŸå­ç±»

#### 4.4.1 CAS

CAS å³ Compare and Swap ï¼Œå®ƒä½“ç°çš„ä¸€ç§ä¹è§‚é”çš„æ€æƒ³ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è¦å¯¹ä¸€ä¸ªå…±äº«çš„æ•´å‹å˜é‡æ‰§è¡Œ +1 æ“ä½œï¼š

![image-20230328113649463](https://img-
blog.csdnimg.cn/img_convert/f86d7f4dff7cf13e6af90ae3a5c07356.png)

è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸
CPU çš„åœºæ™¯ä¸‹ã€‚

* å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
* ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“

CAS åº•å±‚ä¾èµ–äºä¸€ä¸ª Unsafe ç±»æ¥ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚çš„ CAS æŒ‡ä»¤ï¼Œä¸‹é¢æ˜¯ç›´æ¥ä½¿ç”¨ Unsafe å¯¹è±¡è¿›è¡Œçº¿ç¨‹å®‰å…¨ä¿æŠ¤çš„ä¸€ä¸ªä¾‹å­

    public class TeatCAS {
        public static void main(String[] args) throws InterruptedException {
            DataContainer dc = new DataContainer();
            int count = 5;
            Thread t1 = new Thread(() -> {
                for (int i = 0; i < count; i++) {
                    dc.increase();
                }
            });
            t1.start();
            t1.join();
            System.out.println(dc.getData());
        }
    }
    
    class DataContainer {
        private volatile int data;
        static final Unsafe unsafe;
        static final long DATA_OFFSET;
    
        static {
            try {
                // Unsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—
                Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
                theUnsafe.setAccessible(true);
                unsafe = (Unsafe) theUnsafe.get(null);
            } catch (NoSuchFieldException | IllegalAccessException e) {
                throw new Error(e);
            }
            try {
                // data å±æ€§åœ¨ DataContainer å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç”¨äº Unsafe ç›´æ¥è®¿é—®è¯¥å±æ€§
                DATA_OFFSET =
                        unsafe.objectFieldOffset(DataContainer.class.getDeclaredField("data"));
            } catch (NoSuchFieldException e) {
                throw new Error(e);
            }
        }
    
        public void increase() {
            int oldValue;
            while (true) {
                // è·å–å…±äº«å˜é‡æ—§å€¼ï¼Œå¯ä»¥åœ¨è¿™ä¸€è¡ŒåŠ å…¥æ–­ç‚¹ï¼Œä¿®æ”¹ data è°ƒè¯•æ¥åŠ æ·±ç†è§£
                oldValue = data;
                // cas å°è¯•ä¿®æ”¹ data ä¸º æ—§å€¼ + 1ï¼Œå¦‚æœæœŸé—´æ—§å€¼è¢«åˆ«çš„çº¿ç¨‹æ”¹äº†ï¼Œè¿”å› false
                if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue +
                        1)) {
                    return;
                }
            }
        }
    
        public void decrease() {
            int oldValue;
            while (true) {
                oldValue = data;
                if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue -
                        1)) {
                    return;
                }
            }
        }
    
        public int getData() {
            return data;
        }
    }

#### 4.4.2 ä¹è§‚é”ä¸æ‚²è§‚é”

* CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚
* synchronized æ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚

#### 4.4.3 åŸå­æ“ä½œç±»

jucï¼ˆjava.util.concurrentï¼‰ä¸­æä¾›äº†åŸå­æ“ä½œç±»ï¼Œå¯ä»¥æä¾›çº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šAtomicIntegerã€AtomicBooleanç­‰ï¼Œå®ƒä»¬åº•å±‚å°±æ˜¯é‡‡ç”¨
CAS æŠ€æœ¯ + volatile æ¥å®ç°çš„ã€‚å¯ä»¥ä½¿ç”¨ AtomicInteger æ”¹å†™ä¹‹å‰çš„ä¾‹å­ï¼š

![7ad53cfcff370f23b097032f11f0a21](https://img-
blog.csdnimg.cn/img_convert/772fa6ee32abf791fd88f4a1771ee266.jpeg)

### 4.5 synchronizedä¼˜åŒ–

> Java HotSpot è™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯¹è±¡å¤´ï¼ˆåŒ…æ‹¬ class æŒ‡é’ˆå’Œ Mark Wordï¼‰ã€‚Mark Word å¹³æ—¶å­˜å‚¨è¿™ä¸ªå¯¹è±¡çš„ å“ˆå¸Œç 
> ã€ åˆ†ä»£å¹´é¾„ ï¼Œå½“åŠ é”æ—¶ï¼Œè¿™äº›ä¿¡æ¯å°±æ ¹æ®æƒ…å†µè¢«æ›¿æ¢ä¸º æ ‡è®°ä½ ã€ çº¿ç¨‹é”è®°å½•æŒ‡é’ˆ ã€ é‡é‡çº§é”æŒ‡é’ˆ ã€ çº¿ç¨‹ID ç­‰å†…å®¹

#### 4.5.1 è½»é‡çº§é”

å¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚è¿™å°±å¥½æ¯”ï¼šå­¦ç”Ÿï¼ˆçº¿ç¨‹
Aï¼‰ç”¨è¯¾æœ¬å åº§ï¼Œä¸Šäº†åŠèŠ‚è¯¾ï¼Œå‡ºé—¨äº†ï¼ˆCPUæ—¶é—´åˆ°ï¼‰ï¼Œå›æ¥ä¸€çœ‹ï¼Œå‘ç°è¯¾æœ¬æ²¡å˜ï¼Œè¯´æ˜æ²¡  
æœ‰ç«äº‰ï¼Œç»§ç»­ä¸Šä»–çš„è¯¾ã€‚ å¦‚æœè¿™æœŸé—´æœ‰å…¶å®ƒå­¦ç”Ÿï¼ˆçº¿ç¨‹ Bï¼‰æ¥äº†ï¼Œä¼šå‘ŠçŸ¥ï¼ˆçº¿ç¨‹Aï¼‰æœ‰å¹¶å‘è®¿é—®ï¼Œçº¿ç¨‹A
éšå³å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”çš„æµç¨‹ã€‚è€Œé‡é‡çº§é”å°±ä¸æ˜¯é‚£ä¹ˆç”¨è¯¾æœ¬å åº§é‚£ä¹ˆç®€å•äº†ï¼Œå¯ä»¥æƒ³è±¡çº¿ç¨‹ A
èµ°ä¹‹å‰ï¼ŒæŠŠåº§ä½ç”¨ä¸€ä¸ªé“æ …æ å›´èµ·æ¥å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”ã€‚

![image-20230328120142478](https://img-
blog.csdnimg.cn/img_convert/dc8b2579bb939d1c41eb840f7dcc32bb.png)

æ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word

![image-20230328120607393](https://img-
blog.csdnimg.cn/img_convert/eb2e90e9ef6b1bbc8a5573084f89e04f.png)

#### 4.5.2 é”è†¨èƒ€

å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”

![å¾®ä¿¡å›¾ç‰‡_20230328123314](https://img-
blog.csdnimg.cn/img_convert/35e4381a6ce2520d155a342191990e66.jpeg)

![image-20230328123407807](https://img-
blog.csdnimg.cn/img_convert/6aee81c051769b02a74e6268369ee94d.png)

#### 4.5.3 é‡é‡é”

* é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚
* åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½
    * è‡ªæ—‹ä¼šå ç”¨CPUæ—¶é—´ï¼Œå•æ ¸CPUè‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸CPUè‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿
    * å¥½æ¯”ç­‰çº¢è·¯ç¯æ±½è½¦æ˜¯å¦ç†„ç«ï¼Œä¸ç†„ç«ç›¸å½“äºè‡ªæ—‹ï¼ˆç­‰å¾…æ—¶é—´çŸ­åˆ’ç®—ï¼‰ï¼Œç†„ç­äº†ç›¸å½“äºé˜»å¡ï¼ˆç­‰å¾…æ—¶é—´é•¿äº†ä¸åˆ’ç®—ï¼‰
    * Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½

è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ

![image-20230328123837873](https://img-
blog.csdnimg.cn/img_convert/15d25cbc30864ed82c4002bc182f6924.png)

è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ

![image-20230328124417855](https://img-
blog.csdnimg.cn/img_convert/c907989f5f91dddc3d66ae6c4b0c9a40.png)

#### 4.5.4 åå‘é”

æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CAS.

* æ’¤é”€åå‘éœ€è¦å°†æŒé”çº¿ç¨‹å‡çº§ä¸ºè½»é‡çº§é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹éœ€è¦æš‚åœï¼ˆSTWï¼‰
* è®¿é—®å¯¹è±¡çš„ hashCode ä¹Ÿä¼šæ’¤é”€åå‘é”
* å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID
* æ’¤é”€åå‘å’Œé‡åå‘éƒ½æ˜¯æ‰¹é‡è¿›è¡Œçš„ï¼Œä»¥ç±»ä¸ºå•ä½
* å¦‚æœæ’¤é”€åå‘åˆ°è¾¾æŸä¸ªé˜ˆå€¼ï¼Œæ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„
* å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ -XX:-UseBiasedLocking ç¦ç”¨åå‘é”

å¯ä»¥å‚è€ƒè¿™ç¯‡è®ºæ–‡ï¼šhttps://www.oracle.com/technetwork/java/biasedlocking-
oopsla2006-wp-149958.pdf  
å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

![image-20230328124656991](https://img-
blog.csdnimg.cn/img_convert/5f2c2a551487a0adeda822bc43249022.png)

![image-20230328124719565](https://img-
blog.csdnimg.cn/img_convert/83ccbf085b3dfcc40dd6d9312ddddbca.png)

#### 4.5.5 å…¶å®ƒä¼˜åŒ–

1. **å‡å°‘ä¸Šé”æ—¶é—´**  
   åŒæ­¥ä»£ç å—ä¸­å°½é‡çŸ­

2. **å‡å°‘é”çš„ç²’åº¦**

å°†ä¸€ä¸ªé”æ‹†åˆ†ä¸ºå¤šä¸ªé”æé«˜å¹¶å‘åº¦ï¼Œä¾‹å¦‚ï¼š

    * ConcurrentHashMap
    * LongAdderåˆ†ä¸ºbaseå’Œcell,æ²¡æœ‰å¹¶å‘äº‰ç”¨çš„æ—¶å€™æˆ–è€…æ˜¯cellæ•°ç»„æ­£åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨CASæ¥ç´¯åŠ åˆ°bese,æœ‰å¹¶å‘äº‰ç”¨ï¼Œä¼šåˆå§‹åŒ–cellæ•°ç»„ï¼Œæ•°ç»„å¤šæœ‰ä¸ªcell,å°±å…è®¸æœ‰å¤šå°‘çº¿ç¨‹å¹¶å‘ä¿®æ”¹ï¼Œæœ€åå°†æ•°ç»„ä¸­æ¯ä¸ªcellç´¯åŠ ï¼Œåœ¨åŠ ä¸Šbaseå°±æ˜¯æœ€ç»ˆçš„å€¼ã€‚
    * LinkedBlockingQueue å…¥é˜Ÿå’Œå‡ºé˜Ÿä½¿ç”¨ä¸åŒçš„é”ï¼Œç›¸å¯¹äºLinkedBlockingArrayåªæœ‰ä¸€ä¸ªé”æ•ˆç‡è¦é«˜

3. **é”ç²—åŒ–**

å¤šæ¬¡å¾ªç¯è¿›å…¥åŒæ­¥å—ä¸å¦‚åŒæ­¥å—å†…å¤šæ¬¡å¾ªç¯ å¦å¤– JVM å¯èƒ½ä¼šåšå¦‚ä¸‹ä¼˜åŒ–ï¼ŒæŠŠå¤šæ¬¡ append
çš„åŠ é”æ“ä½œç²—åŒ–ä¸ºä¸€æ¬¡ï¼ˆå› ä¸ºéƒ½æ˜¯å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œæ²¡å¿…è¦é‡å…¥å¤šæ¬¡ï¼‰

![image-20230328125236232](https://img-
blog.csdnimg.cn/img_convert/a5adffbec4fd1772b371202998ab001d.png)

4. **é”æ¶ˆé™¤**

JVM ä¼šè¿›è¡Œä»£ç çš„é€ƒé€¸åˆ†æï¼Œä¾‹å¦‚æŸä¸ªåŠ é”å¯¹è±¡æ˜¯æ–¹æ³•å†…å±€éƒ¨å˜é‡ï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œè¿™æ—¶å€™å°±ä¼šè¢«å³æ—¶ç¼–è¯‘å™¨å¿½ç•¥æ‰æ‰€æœ‰åŒæ­¥æ“ä½œã€‚

5. **è¯»å†™åˆ†ç¦»**

CopyOnWriteArrayList

ConyOnWriteSet  
å‚è€ƒï¼š  
https://wiki.openjdk.java.net/display/HotSpot/Synchronization  
https://www.infoq.cn/article/java-se-16-synchronized  
https://www.jianshu.com/p/9932047a89be  
https://www.cnblogs.com/sheeva/p/6366782.html  
https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-
individual-lock

